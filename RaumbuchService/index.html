<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raumbuch Manager - Lokal</title>
    <link rel="stylesheet" href="Content/Site.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Raumbuch Manager</h1>
            <p class="subtitle">Lokale Version - Raumprogramm und Raumbuch Verwaltung</p>
        </header>

        <main>
            <!-- Token Setup -->
            <div class="token-section">
                <strong>üîë Trimble Connect Token erforderlich</strong>
                <p>Holen Sie sich ein Access Token: 
                    <a href="https://id.trimble.com/oauth/authorize?client_id=073a84b7-323b-43bf-b5a9-96bf17638dcc&response_type=code&redirect_uri=http://localhost:5005/callback/&scope=openid%20CST-PowerBI" target="_blank">
                        Hier klicken
                    </a>
                </p>
                <p><small>Kopieren Sie den Authorization Code aus der callback-Seite und verwenden Sie ihn in Postman, um ein access_token zu erhalten.</small></p>
            </div>

            <!-- Configuration -->
            <section class="card">
                <h2>‚öôÔ∏è Konfiguration</h2>
                
                <div class="form-group">
                    <label for="accessToken">Access Token:</label>
                    <input type="text" id="accessToken" class="form-control" placeholder="Token hier einf√ºgen...">
                </div>
                
                <div class="form-group">
                    <label for="projectId">Project ID:</label>
                    <input type="text" id="projectId" class="form-control" value="y7-N0uBcXNI">
                </div>

                <!-- Configuration Management -->
                <div class="form-group">
                    <label for="configName">Konfigurations-Name:</label>
                    <input type="text" id="configName" class="form-control" placeholder="z.B. 'MeinProjekt_Config'">
                    <small>Geben Sie einen Namen ein (wird beim ersten Speichern verwendet)</small>
                </div>

                <div class="form-group">
                    <label>Konfiguration:</label>
                    <input type="file" id="loadConfigFile" accept=".json" onchange="loadConfig()" style="display:inline-block; width:auto;">
                    <button class="btn btn-secondary" onclick="saveConfig()">üíæ Konfiguration speichern</button>
                    <button class="btn btn-secondary" onclick="loadProjectData()">üìÅ Projektdaten laden</button>
                </div>

                <hr>

                <!-- Target Folder Dropdown -->
                <div class="form-group">
                    <label for="targetFolder">Zielordner:</label>
                    <select id="targetFolder" class="form-control">
                        <option value="">-- Klicken Sie auf "Projektdaten laden" --</option>
                    </select>
                    <button class="btn btn-secondary" onclick="fetchFiles()">üîÑ Dateien laden</button>
                </div>

                <div id="connectionResult" class="result"></div>
            </section>

            <!-- Step 1: Import Template -->
            <section class="card">
                <h2>1Ô∏è‚É£ Vorlage importieren</h2>
                <p>Erstellt Raumprogramm.xlsx aus einer Vorlage</p>
                
                <!-- Template Dropdown -->
                <div class="form-group">
                    <label for="templateFile">Vorlagendatei (.xlsx):</label>
                    <select id="templateFile" class="form-control">
                        <option value="">-- Vorlage ausw√§hlen nach "Dateien laden" --</option>
                    </select>
                </div>
                
                <button class="btn btn-primary" onclick="importTemplate()">üì• Vorlage importieren</button>
                
                <div id="step1Result" class="result"></div>
            </section>

            <!-- Step 2: Create BCF Topic -->
            <section class="card">
                <h2>2Ô∏è‚É£ BCF Topic erstellen</h2>
                <p>Benachrichtigt Benutzer √ºber das neue Raumprogramm via Trimble Connect</p>
                
                <div class="form-group">
                    <label for="bcfTitle">Titel:</label>
                    <input type="text" id="bcfTitle" class="form-control" value="Raumbuch">
                </div>

                <!-- Users Multi-Select Dropdown -->
                <div class="form-group">
                    <label for="bcfAssignees">Zuweisen an (E-Mail):</label>
                    <select id="bcfAssignees" class="form-control" multiple size="5">
                        <option value="">-- Klicken Sie auf "Projektdaten laden" --</option>
                    </select>
                    <small>Erste ausgew√§hlte Benutzer erhalten E-Mail direkt. Halten Sie Strg/Cmd gedr√ºckt, um mehrere auszuw√§hlen.</small>
                </div>

                <div class="form-group">
                    <label for="bcfDescription">Beschreibung (optional):</label>
                    <textarea id="bcfDescription" class="form-control" rows="3" placeholder="Raumprogramm wurde in diesem Verzeichnis erstellt.">Raumprogramm wurde in diesem Verzeichnis erstellt.</textarea>
                    <small>Link zum Ordner wird automatisch als Dokumentreferenz hinzugef√ºgt.</small>
                </div>

                <button class="btn btn-primary" onclick="createBcfTopic()">üìã BCF Topic erstellen</button>

                <div id="step2Result" class="result"></div>
            </section>

            <!-- Step 3: Import IFC -->
            <section class="card">
                <h2>3Ô∏è‚É£ IFC importieren</h2>
                <p>Erstellt Raumbuch.xlsx mit SOLL/IST-Analyse</p>
                
                <!-- IFC Dropdown -->
                <div class="form-group">
                    <label for="ifcFile">IFC-Datei (.ifc):</label>
                    <select id="ifcFile" class="form-control">
                        <option value="">-- IFC ausw√§hlen nach "Dateien laden" --</option>
                    </select>
                </div>
                
                <!-- Raumprogramm Dropdown -->
                <div class="form-group">
                    <label for="raumprogrammFile">Raumprogramm-Datei (.xlsx):</label>
                    <select id="raumprogrammFile" class="form-control">
                        <option value="">-- Raumprogramm ausw√§hlen nach "Dateien laden" --</option>
                    </select>
                    <small>W√§hlen Sie die Raumprogramm.xlsx aus Schritt 1</small>
                </div>
                
                <!-- Raumbuch Dropdown (moved from Step 4) -->
                <div class="form-group">
                    <label for="raumbuchFile">Raumbuch-Datei (.xlsx):</label>
                    <select id="raumbuchFile" class="form-control">
                        <option value="">-- Raumbuch ausw√§hlen nach "Dateien laden" --</option>
                    </select>
                    <small>Wird automatisch ausgef√ºllt nach "IFC importieren" oder w√§hlen Sie eine existierende Datei</small>
                </div>
                
                <button class="btn btn-primary" onclick="importIfc()">üèóÔ∏è IFC importieren</button>
                <button class="btn btn-secondary" onclick="updateRaumbuch()">üîÑ Raumbuch aktualisieren</button>
                
                <div id="step3Result" class="result"></div>
            </section>

            <!-- Step 4: Write Raumbuch Pset to IFC -->
            <section class="card">
                <h2>4Ô∏è‚É£ Raumbuch Pset in IFC schreiben</h2>
                <p>Schreibt Differenz und Gem√§ss Raumprogramm als Pset "Raumbuch" in die IFC-Datei</p>
                <p><small>Verwendet IFC-Datei und Raumbuch-Datei aus Schritt 3</small></p>
                
                <button class="btn btn-primary" onclick="writePset()">üìù Pset schreiben</button>
                <button class="btn btn-secondary" onclick="updatePset()">üîÑ Pset aktualisieren</button>
                <button class="btn btn-secondary" onclick="deletePset()">üóëÔ∏è Pset l√∂schen</button>
                <div id="step4Result" class="result"></div>
            </section>

            <!-- Step 5: Inventory Management -->
            <section class="card">
                <h2>5Ô∏è‚É£ Inventarverwaltung</h2>
                <p>Erstellt Raumlisten und f√ºllt sie mit Inventar aus IFC-Dateien</p>
                
                <!-- Step 5.1: Create Room Sheets -->
                <div class="subsection">
                    <h3>5.1 Raumlisten erstellen</h3>
                    <p><small>Erstellt ein Blatt pro Raum in der Raumbuch.xlsx</small></p>
                    
                    <button class="btn btn-primary" onclick="createRoomSheets()">üìã Raumliste erstellen</button>
                    <div id="step5_1Result" class="result"></div>
                </div>

                <hr style="margin: 20px 0;">

                <!-- Step 5.2: Fill Inventory -->
                <div class="subsection">
                    <h3>5.2 Inventar erstellen</h3>
                    <p><small>F√ºllt Raumlisten mit Inventardaten aus IFC-Dateien</small></p>
                    
                    <!-- IFC Folder Dropdown -->
                    <div class="form-group">
                        <label for="inventoryFolder">IFC-Dateien aus Zielordner:</label>
                        <select id="inventoryFolder" class="form-control">
                            <option value="">-- Klicken Sie auf "Projektdaten laden" --</option>
                        </select>
                        <small>Ordner f√ºr IFC-Dateien (kann unterschiedlich vom Raumbuch-Ordner sein)</small>
                    </div>

                    <!-- Load IFC Files Button -->
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="loadIfcFilesForInventory()">üìÅ IFC-Dateien laden</button>
                    </div>

                    <!-- IFC Files Multi-Select List -->
                    <div class="form-group">
                        <label for="inventoryIfcFiles">IFC-Dateien ausw√§hlen:</label>
                        <div id="ifcFilesList" class="file-selection-list">
                            <p style="color: #666; font-style: italic;">Klicken Sie auf "IFC-Dateien laden"</p>
                        </div>
                    </div>

                    <!-- Pset Configuration -->
                    <div class="form-group">
                        <label for="psetPartialName">Pset Name (teilweise):</label>
                        <input type="text" id="psetPartialName" class="form-control" value="Plancal nova" placeholder="z.B. 'Plancal nova'">
                        <small>Teilweiser Name des Psets, z.B. "Plancal nova" findet "Pset Plancal nova - Electrical"</small>
                    </div>

                    <div class="form-group">
                        <label for="roomPropertyName">Raumnummer-Eigenschaft:</label>
                        <input type="text" id="roomPropertyName" class="form-control" value="Room Nbr" placeholder="z.B. 'Room Nbr'">
                        <small>Name der Eigenschaft, die die Raumnummer enth√§lt</small>
                    </div>

                    <button class="btn btn-primary" onclick="fillInventory()">üì¶ Inventar erstellen</button>
                    <div id="step5_2Result" class="result"></div>
                </div>
            </section>
        </main>

        <footer>
            <p>Raumbuch Manager v2.0 - Lokale Version mit Konfigurationsverwaltung</p>
            <p>API: https://localhost:44305</p>
        </footer>
    </div>

    <script>
        const API_BASE = 'https://localhost:44305/api/raumbuch';
        const API_PROJECT = 'https://localhost:44305/api/project';

        // Global configuration object
        let currentConfig = {
            projectId: '',
            projectName: '',
            targetFolder: null,
            files: {
                template: null,
                raumprogramm: null,
                ifcModel: null,
                raumbuch: null
            },
            bcfAssignees: []
        };

        function getToken() {
            return document.getElementById('accessToken').value.trim();
        }

        function getProjectId() {
            return document.getElementById('projectId').value.trim();
        }

        function getTargetFolder() {
            const select = document.getElementById('targetFolder');
            const value = select.value;
            console.log('getTargetFolder() - selected value:', value);
            console.log('getTargetFolder() - selected index:', select.selectedIndex);
            console.log('getTargetFolder() - selected option:', select.options[select.selectedIndex]);
            return value;
        }

        function showResult(elementId, type, message) {
            const el = document.getElementById(elementId);
            el.className = `result ${type}`;
            el.innerHTML = message;
        }

        // ====================================================================
        //  CONFIGURATION MANAGEMENT
        // ====================================================================

        async function loadProjectData() {
            const token = getToken();
            const projectId = getProjectId();

            if (!token || !projectId) {
                showResult('connectionResult', 'error', '‚ö† Bitte Token und Project ID eingeben');
                return;
            }

            showResult('connectionResult', 'loading', '‚è≥ Projektdaten werden geladen...');

            try {
                // Load folders
                console.log('Loading folders...');
                const foldersResponse = await fetch(`${API_PROJECT}/folders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessToken: token, projectId: projectId })
                });

                const contentType = foldersResponse.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const textResponse = await foldersResponse.text();
                    console.error('Non-JSON response:', textResponse);
                    showResult('connectionResult', 'error', '‚ùå Ung√ºltige Antwort vom Server (kein JSON)');
                    return;
                }

                const foldersData = await foldersResponse.json();
                console.log('Folders response:', foldersData);

                if (foldersResponse.ok && foldersData.success) {
                    const select = document.getElementById('targetFolder');
                    
                    if (!foldersData.folders || !Array.isArray(foldersData.folders)) {
                        showResult('connectionResult', 'error', '‚ùå Keine Ordner-Daten in Antwort');
                        return;
                    }

                    select.innerHTML = '<option value="">-- Ordner ausw√§hlen --</option>';
                    
                    // Also populate inventory folder dropdown
                    const inventoryFolderSelect = document.getElementById('inventoryFolder');
                    if (inventoryFolderSelect) {
                        inventoryFolderSelect.innerHTML = '<option value="">-- Ordner ausw√§hlen --</option>';
                    }
                    
                    if (foldersData.folders.length === 0) {
                        showResult('connectionResult', 'error', '‚ö† Keine Ordner gefunden');
                        return;
                    }

                    foldersData.folders.forEach((folder) => {
                        const option = document.createElement('option');
                        option.value = folder.id || '';
                        option.textContent = folder.path || folder.name || 'Unnamed folder';
                        option.dataset.name = folder.name || '';
                        option.dataset.path = folder.path || '';
                        select.appendChild(option);
                        
                        // Add to inventory folder dropdown
                        if (inventoryFolderSelect) {
                            const inventoryOption = document.createElement('option');
                            inventoryOption.value = folder.id || '';
                            inventoryOption.textContent = folder.path || folder.name || 'Unnamed folder';
                            inventoryOption.dataset.name = folder.name || '';
                            inventoryOption.dataset.path = folder.path || '';
                            inventoryFolderSelect.appendChild(inventoryOption);
                        }
                    });

                    console.log('Folders loaded:', foldersData.folders.length);
                } else {
                    const errorMsg = foldersData.message || foldersData.Message || 'Unbekannter Fehler';
                    showResult('connectionResult', 'error', `‚ùå ${errorMsg}`);
                    return;
                }

                // Load users
                console.log('Loading users...');
                const usersResponse = await fetch(`${API_PROJECT}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessToken: token, projectId: projectId })
                });

                const usersData = await usersResponse.json();
                console.log('Users response:', usersData);

                if (usersResponse.ok && usersData.success) {
                    const select = document.getElementById('bcfAssignees');
                    select.innerHTML = '';
                    
                    if (!usersData.users || !Array.isArray(usersData.users)) {
                        showResult('connectionResult', 'warning', `‚úÖ ${foldersData.folders.length} Ordner geladen, aber keine Benutzer gefunden`);
                        return;
                    }

                    usersData.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.email;
                        option.textContent = `${user.displayName} (${user.email})`;
                        option.dataset.id = user.id;
                        option.dataset.displayName = user.displayName;
                        select.appendChild(option);
                    });

                    console.log('Users loaded:', usersData.users.length);
                    showResult('connectionResult', 'success', `‚úÖ ${foldersData.folders.length} Ordner und ${usersData.users.length} Benutzer geladen!`);
                } else {
                    const errorMsg = usersData.message || usersData.Message || 'Unbekannter Fehler';
                    showResult('connectionResult', 'warning', `‚úÖ ${foldersData.folders.length} Ordner geladen, aber Fehler beim Laden der Benutzer: ${errorMsg}`);
                }
            } catch (error) {
                console.error('Error in loadProjectData:', error);
                showResult('connectionResult', 'error', `‚ùå Fehler: ${error.message}`);
            }
        }

        async function fetchFolders() {
            // This function is now replaced by loadProjectData()
            // Keeping it for backward compatibility if called from elsewhere
            await loadProjectData();
        }

        async function fetchUsers() {
            // This function is now replaced by loadProjectData()
            // Keeping it for backward compatibility if called from elsewhere
            await loadProjectData();
        }

        async function fetchFiles() {
            const token = getToken();
            const folderId = getTargetFolder();

            console.log('fetchFiles() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('Folder ID:', folderId);

            if (!token || !folderId) {
                showResult('connectionResult', 'error', '‚ö† Bitte Token and Zielordner ausw√§hlen');
                console.error('Missing token or folderId');
                return;
            }

            showResult('connectionResult', 'loading', '‚è≥ Dateien werden geladen...');

            try {
                // Fetch Excel files for all dropdowns (template, raumprogramm, raumbuch)
                console.log('Fetching Excel files from folder:', folderId);
                const excelResponse = await fetch(`${API_PROJECT}/files`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        accessToken: token, 
                        folderId: folderId,
                        fileExtensions: ['xlsx']
                    })
                });

                console.log('Excel response status:', excelResponse.status);
                const excelData = await excelResponse.json();
                console.log('Excel response data:', excelData);

                if (excelResponse.ok && excelData.success) {
                    // Populate template dropdown
                    const templateSelect = document.getElementById('templateFile');
                    templateSelect.innerHTML = '<option value="">-- Vorlage ausw√§hlen --</option>';
                    
                    // Populate raumprogramm dropdown (Step 3)
                    const raumprogrammSelect = document.getElementById('raumprogrammFile');
                    raumprogrammSelect.innerHTML = '<option value="">-- Raumprogramm ausw√§hlen --</option>';
                    
                    // Populate raumbuch dropdown (Step 4)
                    const raumbuchSelect = document.getElementById('raumbuchFile');
                    raumbuchSelect.innerHTML = '<option value="">-- Raumbuch ausw√§hlen --</option>';
                    
                    console.log('Excel files found:', excelData.files?.length || 0);
                    
                    if (excelData.files && excelData.files.length > 0) {
                        excelData.files.forEach(file => {
                            console.log('Adding Excel file:', file.name);
                            
                            // Add to template dropdown
                            const templateOption = document.createElement('option');
                            templateOption.value = file.id;
                            templateOption.textContent = file.name;
                            templateOption.dataset.name = file.name;
                            templateOption.dataset.versionId = file.versionId;
                            templateSelect.appendChild(templateOption);
                            
                            // Add to raumprogramm dropdown
                            const raumprogrammOption = document.createElement('option');
                            raumprogrammOption.value = file.id;
                            raumprogrammOption.textContent = file.name;
                            raumprogrammOption.dataset.name = file.name;
                            raumprogrammOption.dataset.versionId = file.versionId;
                            raumprogrammSelect.appendChild(raumprogrammOption);
                            
                            // Add to raumbuch dropdown (used by both Step 3 update and Step 4 pset operations)
                            const raumbuchOption = document.createElement('option');
                            raumbuchOption.value = file.id;
                            raumbuchOption.textContent = file.name;
                            raumbuchOption.dataset.name = file.name;
                            raumbuchOption.dataset.versionId = file.versionId;
                            raumbuchSelect.appendChild(raumbuchOption);
                        });
                    }
                } else {
                    console.error('Excel fetch failed:', excelData);
                }

                // Fetch IFC files for IFC dropdown
                console.log('Fetching IFC files from folder:', folderId);
                const ifcResponse = await fetch(`${API_PROJECT}/files`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        accessToken: token, 
                        folderId: folderId,
                        fileExtensions: ['ifc']
                    })
                });

                console.log('IFC response status:', ifcResponse.status);
                const ifcData = await ifcResponse.json();
                console.log('IFC response data:', ifcData);

                if (ifcResponse.ok && ifcData.success) {
                    const ifcSelect = document.getElementById('ifcFile');
                    
                    ifcSelect.innerHTML = '<option value="">-- IFC ausw√§hlen --</option>';
                    
                    console.log('IFC files found:', ifcData.files?.length || 0);
                    
                    if (ifcData.files && ifcData.files.length > 0) {
                        ifcData.files.forEach(file => {
                            console.log('Adding IFC file:', file.name);
                            const option = document.createElement('option');
                            option.value = file.id;
                            option.textContent = file.name;
                            option.dataset.name = file.name;
                            ifcSelect.appendChild(option);
                        });
                    }
                } else {
                    console.error('IFC fetch failed:', ifcData);
                }

                const excelCount = excelData.files?.length || 0;
                const ifcCount = ifcData.files?.length || 0;
                
                console.log('Total files:', excelCount, 'Excel,', ifcCount, 'IFC');
                showResult('connectionResult', 'success', `‚úÖ Dateien geladen! ${excelCount} Excel, ${ifcCount} IFC`);
            } catch (error) {
                console.error('Error in fetchFiles:', error);
                console.error('Error stack:', error.stack);
                showResult('connectionResult', 'error', `‚ùå Fehler: ${error.message}`);
            }
        }

        async function fetchUsers() {
            const token = getToken();
            const projectId = getProjectId();

            if (!token || !projectId) {
                showResult('step2Result', 'error', '‚ö† Bitte Token und Project ID eingeben');
                return;
            }

            showResult('step2Result', 'loading', '‚è≥ Benutzer werden geladen...');

            try {
                const response = await fetch(`${API_PROJECT}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessToken: token, projectId: projectId })
                });

                console.log('Response status:', response.status);
                const contentType = response.headers.get('content-type');
                console.log('Content-Type:', contentType);

                if (!contentType || !contentType.includes('application/json')) {
                    const textResponse = await response.text();
                    console.error('Non-JSON response:', textResponse);
                    showResult('step2Result', 'error', '‚ùå Ung√ºltige Antwort vom Server (kein JSON)');
                    return;
                }

                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok && data.success) {
                    const select = document.getElementById('bcfAssignees');
                    select.innerHTML = '';
                    
                    if (!data.users || !Array.isArray(data.users)) {
                        showResult('step2Result', 'error', '‚ö† Keine Benutzer-Daten in Antwort');
                        return;
                    }

                    console.log('Number of users:', data.users.length);
                    
                    data.users.forEach(user => {
                        console.log('Adding user:', user.email, user.displayName);
                        const option = document.createElement('option');
                        option.value = user.email;
                        option.textContent = `${user.displayName} (${user.email})`;
                        option.dataset.id = user.id;
                        option.dataset.displayName = user.displayName;
                        select.appendChild(option);
                    });

                    showResult('step2Result', 'success', `‚úÖ ${data.users.length} Benutzer geladen!`);
                } else {
                    console.error('Response not OK or success=false');
                    const errorMsg = data.message || data.Message || 'Unbekannter Fehler';
                    showResult('step2Result', 'error', `‚ùå ${errorMsg}`);
                }
            } catch (error) {
                console.error('Error in fetchUsers:', error);
                console.error('Error stack:', error.stack);
                showResult('step2Result', 'error', `‚ùå Fehler: ${error.message}`);
            }
        }

        function saveConfig() {
            const configName = document.getElementById('configName').value.trim();
            
            if (!configName) {
                alert('‚ö† Bitte geben Sie einen Konfigurations-Namen ein!');
                return;
            }

            // Build configuration object
            const config = {
                projectId: getProjectId(),
                projectName: configName,
                lastUpdated: new Date().toISOString(),
                targetFolder: getSelectedOption('targetFolder'),
                files: {
                    template: getSelectedOption('templateFile'),
                    raumprogramm: getSelectedOption('raumprogrammFile'),
                    ifcModel: getSelectedOption('ifcFile'),
                    raumbuch: getSelectedOption('raumbuchFile')
                },
                bcfAssignees: getSelectedUsers()
            };

            // Download as JSON file
            const blob = new Blob([JSON.stringify(config, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${configName}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showResult('connectionResult', 'success', `‚úÖ Konfiguration "${configName}.json" heruntergeladen!`);
        }

        function loadConfig() {
            const fileInput = document.getElementById('loadConfigFile');
            const file = fileInput.files[0];

            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    applyConfiguration(config);
                    showResult('connectionResult', 'success', `‚úÖ Konfiguration "${config.projectName}" geladen!`);
                } catch (error) {
                    console.error('Error loading config:', error);
                    showResult('connectionResult', 'error', `‚ùå Ung√ºltige Konfigurationsdatei: ${error.message}`);
                }
            };
            reader.readAsText(file);
        }

        function applyConfiguration(config) {
            currentConfig = config;

            // Fill Project ID and Name
            document.getElementById('projectId').value = config.projectId || '';
            document.getElementById('configName').value = config.projectName || '';

            // Fill Target Folder (display name in readonly field if not in dropdown yet)
            if (config.targetFolder) {
                const folderSelect = document.getElementById('targetFolder');
                // Try to find and select the folder
                let found = false;
                for (let i = 0; i < folderSelect.options.length; i++) {
                    if (folderSelect.options[i].value === config.targetFolder.id) {
                        folderSelect.selectedIndex = i;
                        found = true;
                        break;
                    }
                }
                if (!found && config.targetFolder.id) {
                    // Add as option if not found
                    const option = document.createElement('option');
                    option.value = config.targetFolder.id;
                    option.textContent = config.targetFolder.path || config.targetFolder.name;
                    option.dataset.name = config.targetFolder.name;
                    option.dataset.path = config.targetFolder.path;
                    folderSelect.appendChild(option);
                    folderSelect.value = config.targetFolder.id;
                }
            }

            // Fill Template
            if (config.files?.template) {
                setSelectValue('templateFile', config.files.template.id, config.files.template.name);
            }

            // Fill Raumprogramm (changed from readonly to dropdown)
            if (config.files?.raumprogramm) {
                setSelectValue('raumprogrammFile', config.files.raumprogramm.id, config.files.raumprogramm.name);
            }

            // Fill IFC
            if (config.files?.ifcModel) {
                setSelectValue('ifcFile', config.files.ifcModel.id, config.files.ifcModel.name);
            }

            // Fill Raumbuch (changed from readonly to dropdown)
            if (config.files?.raumbuch) {
                setSelectValue('raumbuchFile', config.files.raumbuch.id, config.files.raumbuch.name);
            }

            // Fill BCF Assignees
            if (config.bcfAssignees && config.bcfAssignees.length > 0) {
                const select = document.getElementById('bcfAssignees');
                // Pre-select users if they exist in dropdown
                for (let i = 0; i < select.options.length; i++) {
                    const option = select.options[i];
                    const isSelected = config.bcfAssignees.some(u => u.email === option.value);
                    option.selected = isSelected;
                }
            }
        }

        function getSelectedOption(selectId) {
            const select = document.getElementById(selectId);
            const option = select.options[select.selectedIndex];
            if (!option || !option.value) return null;

            return {
                id: option.value,
                name: option.dataset.name || option.textContent,
                path: option.dataset.path || ''
            };
        }

        function getSelectedUsers() {
            const select = document.getElementById('bcfAssignees');
            const users = [];
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].selected) {
                    users.push({
                        id: select.options[i].dataset.id || '',
                        email: select.options[i].value,
                        displayName: select.options[i].dataset.displayName || select.options[i].textContent
                    });
                }
            }
            return users;
        }

        function setSelectValue(selectId, value, name) {
            const select = document.getElementById(selectId);
            let found = false;
            
            // Try to find existing option
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === value) {
                    select.selectedIndex = i;
                    found = true;
                    return;
                }
            }
            
            // If not found, add as option
            if (!found && value && name) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = name;
                option.dataset.name = name;
                select.appendChild(option);
                select.value = value;
            }
        }

        // ====================================================================
        //  POLLING HELPER FUNCTION
        // ====================================================================

        /**
         * Polls the folder for a newly created file by name.
         * Tries up to 5 times with 500ms intervals.
         * Returns the file ID if found, or null if not found.
         */
        async function pollForFile(fileName, maxAttempts = 5, delayMs = 500) {
            const token = getToken();
            const folderId = getTargetFolder();

            console.log(`Starting polling for file: ${fileName}`);

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                console.log(`Poll attempt ${attempt}/${maxAttempts}`);
//                
                // Wait before querying
                await new Promise(resolve => setTimeout(resolve, delayMs));
                
                try {
                    const response = await fetch(`${API_PROJECT}/files`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            accessToken: token, 
                            folderId: folderId,
                            fileExtensions: ['xlsx']
                        })
                    });

                    if (!response.ok) {
                        console.warn(`Folder query failed with status ${response.status}`);
                        continue;
                    }

                    const data = await response.json();
                    
                    if (data.success && data.files) {
                        // Find the file by name (case-insensitive)
                        const foundFile = data.files.find(f => 
                            f.name.toLowerCase() === fileName.toLowerCase()
                        );
                        
                        if (foundFile && foundFile.id) {
                            console.log(`Found file: ${foundFile.name}, ID: ${foundFile.id}`);
                            return foundFile;
                        }
                    }
                    
                    console.log(`File '${fileName}' not found yet. Will retry...`);
                } catch (error) {
                    console.error(`Error during poll attempt ${attempt}:`, error);
                }
            }
            
            console.warn(`File '${fileName}' not found after ${maxAttempts} attempts.`);
            return null;
        }

        /**
         * Updates a dropdown with a new file option and selects it.
         */
        function updateDropdownWithFile(selectId, file) {
            const select = document.getElementById(selectId);
            
            // Check if file already exists in dropdown
            let optionExists = false;
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === file.id) {
                    select.selectedIndex = i;
                    optionExists = true;
                    break;
                }
            }
            
            // If not exists, add it
            if (!optionExists) {
                const option = document.createElement('option');
                option.value = file.id;
                option.textContent = file.name;
                option.dataset.name = file.name;
                select.appendChild(option);
                select.value = file.id;
            }
            
            console.log(`Updated dropdown ${selectId} with file: ${file.name}`);
        }

        // ====================================================================
        //  EXISTING FUNCTIONS (updated to use polling)
        // ====================================================================

        async function testConnection() {
            const token = getToken();
            const projectId = getProjectId();

            if (!token || !projectId) {
                showResult('connectionResult', 'error', '‚ö† Bitte Token und Project ID eingeben');
                return;
            }

            showResult('connectionResult', 'loading', '‚è≥ Teste Verbindung...');

            try {
                const response = await fetch(`${API_BASE}/test-project`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessToken: token, projectId: projectId })
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('connectionResult', 'success', `‚úÖ Verbindung OK! Projekt: ${data.projectId || projectId}`);
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    showResult('connectionResult', 'error', `‚ùå ${errorMsg}`);
                }
            } catch (error) {
                showResult('connectionResult', 'error', `‚ùå Fehler: ${error.message}`);
            }
        }

        async function importTemplate() {
            const token = getToken();
            const projectId = getProjectId();
            const templateFileId = document.getElementById('templateFile').value;
            const targetFolder = getTargetFolder();

            console.log('importTemplate() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('ProjectId:', projectId);
            console.log('Template File ID:', templateFileId);
            console.log('Target Folder:', targetFolder);

            if (!token || !templateFileId || !targetFolder || !projectId) {
                showResult('step1Result', 'error', '‚ö† Bitte alle Felder ausf√ºllen');
                return;
            }

            showResult('step1Result', 'loading', '‚è≥ Importiere Vorlage...');

            try {
                const requestBody = {
                    accessToken: token,
                    projectId: projectId,
                    templateFileId: templateFileId,
                    targetFolderId: targetFolder
                };

                console.log('Sending request body:', requestBody);

                const response = await fetch(`${API_BASE}/import-template`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    const fileName = data.raumprogrammFileName || 'Raumprogramm.xlsx';
                    const fileId = data.raumprogrammFileId || 'N/A';
                    
                    console.log('Raumprogramm created successfully:', fileName, fileId);
                    
                    // Save to config
                    currentConfig.files.raumprogramm = {
                        id: fileId,
                        name: fileName
                    };
                    
                    console.log('Updated currentConfig.files.raumprogramm:', currentConfig.files.raumprogramm);
                    
                    showResult('step1Result', 'loading', `‚úÖ Raumprogramm erstellt!<br>‚è≥ Warte auf ID von Connect...`);
                    
                    // Poll for the file to get the actual Connect ID
                    const foundFile = await pollForFile(fileName);
                    
                    if (foundFile) {
                        // Update config with correct ID
                        currentConfig.files.raumprogramm.id = foundFile.id;
                        
                        // Update dropdown in Step 3
                        updateDropdownWithFile('raumprogrammFile', foundFile);
                        
                        showResult('step1Result', 'success', 
                            `‚úÖ Erfolgreich!<br>Datei: ${fileName}<br>ID: ${foundFile.id}<br>‚úÖ Raumprogramm wurde zur Dropdown-Liste hinzugef√ºgt!`);
                    } else {
                        // File not found after polling, use backend ID
                        showResult('step1Result', 'warning', 
                            `‚ö†Ô∏è Raumprogramm wurde erstellt, aber ID konnte nicht sofort abgerufen werden.<br>Datei: ${fileName}<br>Bitte klicken Sie auf "Dateien laden" um die Liste zu aktualisieren.`);
                    }
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    console.error('Import template failed:', errorMsg);
                    showResult('step1Result', 'error', `‚ùå ${errorMsg}`);
                }
            } catch (error) {
                console.error('Error in importTemplate:', error);
                showResult('step1Result', 'error', `‚ùå Fehler: ${error.message}`);
            }
        }

        async function createBcfTopic() {
            const token = getToken();
            const projectId = getProjectId();
            const folderId = getTargetFolder();
            const title = document.getElementById('bcfTitle').value.trim();
            const description = document.getElementById('bcfDescription').value.trim();

            // Get selected users
            const selectedUsers = getSelectedUsers();
            if (selectedUsers.length === 0) {
                showResult('step2Result', 'error', '‚ö† Bitte mindestens einen Benutzer ausw√§hlen');
                return;
            }

            const assignedTo = selectedUsers.map(u => u.email).join(',');

            if (!token || !projectId || !folderId) {
                showResult('step2Result', 'error', '‚ö† Bitte Token, Project ID und Folder ausw√§hlen');
                return;
            }

            showResult('step2Result', 'loading', '‚è≥ Erstelle BCF Topic...');

            try {
                const response = await fetch(`${API_BASE}/create-bcf-topic`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        projectId: projectId,
                        folderId: folderId,
                        title: title,
                        description: description,
                        assignedTo: assignedTo,
                        createMultipleTopics: false
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    let resultHtml = `‚úÖ BCF Topic erfolgreich erstellt!<br>Topic GUID: ${data.topicGuid || 'N/A'}`;
                    
                    if (data.documentReferenceGuid) {
                        resultHtml += `<br>Dokumentreferenz GUID: ${data.documentReferenceGuid}`;
                    }
					
					resultHtml += `<br><br>‚ö†Ô∏è Bitte pr√ºfen Sie die Benutzerzuweisungen und Berechtigungen in Trimble Connect.`;
                    
                    showResult('step2Result', 'success', resultHtml);
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    showResult('step2Result', 'error', `‚ùå ${errorMsg}`);
                }
            } catch (error) {
                showResult('step2Result', 'error', `‚ùå Fehler: ${error.message}`);
            }
        }

        async function importIfc() {
            const token = getToken();
            const projectId = getProjectId();
            const ifcFileId = document.getElementById('ifcFile').value;
            const raumprogrammFileSelect = document.getElementById('raumprogrammFile');
            const raumprogrammFileId = raumprogrammFileSelect.value;
            const targetFolder = getTargetFolder();

            console.log('importIfc() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('ProjectId:', projectId);
            console.log('IFC File ID:', ifcFileId);
            console.log('Raumprogramm File ID:', raumprogrammFileId);
            console.log('Target Folder:', targetFolder);

            if (!token || !projectId || !ifcFileId || !raumprogrammFileId || !targetFolder) {
                let missingFields = [];
                if (!token) missingFields.push('Token');
                if (!projectId) missingFields.push('Project ID');
                if (!ifcFileId) missingFields.push('IFC File');
                if (!raumprogrammFileId) missingFields.push('Raumprogramm File');
                if (!targetFolder) missingFields.push('Target Folder');
                
                showResult('step3Result', 'error', `‚ö† Bitte alle Felder ausf√ºllen. Fehlende Felder: ${missingFields.join(', ')}`);
                return;
            }

            showResult('step3Result', 'loading', '‚è≥ Importiere IFC und erstelle Raumbuch... (kann einige Sekunden dauern)');

            try {
                const requestBody = {
                    accessToken: token,
                    projectId: projectId,
                    ifcFileId: ifcFileId,
                    raumprogrammFileId: raumprogrammFileId,
                    targetFolderId: targetFolder
                };

                console.log('Sending request body:', requestBody);

                const response = await fetch(`${API_BASE}/import-ifc`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    const fileName = data.raumbuchFileName || 'Raumbuch.xlsx';
                    const fileId = data.raumbuchFileId || 'N/A';
                    
                    console.log('Raumbuch created successfully:', fileName, fileId);
                    
                    // Save to config
                    currentConfig.files.raumbuch = {
                        id: fileId,
                        name: fileName
                    };
                    
                    let message = `‚úÖ Raumbuch erstellt!<br>Datei: ${fileName}<br>‚è≥ Warte auf ID von Connect...<br><br><strong>Analyse:</strong><br>`;
                    if (data.analysis && data.analysis.length > 0) {
                        data.analysis.forEach(a => {
                            const status = a.isOverLimit ? '‚ö†Ô∏è √úBERSCHUSS' : '‚úÖ OK';
                            message += `- ${a.roomCategory}: ${a.percentage.toFixed(1)}% ${status}<br>`;
                        });
                    }
                    
                    showResult('step3Result', 'loading', message);
                    
                    // Poll for the file to get the actual Connect ID
                    const foundFile = await pollForFile(fileName);
                    
                    if (foundFile) {
                        // Update config with correct ID
                        currentConfig.files.raumbuch.id = foundFile.id;
                        
                        // Update dropdown (used by both Step 3 update and Step 4 pset operations)
                        updateDropdownWithFile('raumbuchFile', foundFile);
                        
                        message = `‚úÖ Raumbuch erfolgreich erstellt!<br>Datei: ${fileName}<br>ID: ${foundFile.id}<br>‚úÖ Raumbuch wurde zur Dropdown-Liste hinzugef√ºgt!`;
                        showResult('step3Result', 'success', message);
                    } else {
                        // File not found after polling, use backend ID
                        message = `‚ö†Ô∏è Raumbuch wurde erstellt, aber ID konnte nicht sofort abgerufen werden.<br>Datei: ${fileName}<br>Bitte klicken Sie auf "Dateien laden" um die Liste zu aktualisieren.<br><br><strong>Analyse:</strong><br>`;
                        if (data.analysis && data.analysis.length > 0) {
                            data.analysis.forEach(a => {
                                const status = a.isOverLimit ? '‚ö†Ô∏è √úBERSCHUSS' : '‚úÖ OK';
                                message += `- ${a.roomCategory}: ${a.percentage.toFixed(1)}% ${status}<br>`;
                            });
                        }
                        showResult('step3Result', 'warning', message);
                    }
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    showResult('step3Result', 'error', `‚ùå ${errorMsg}`);
                }
            } catch (error) {
                console.error('Error in importIfc:', error);
                showResult('step3Result', 'error', `‚ùå Fehler: ${error.message}`);
            }
        }

        async function updateRaumbuch() {
            const token = getToken();
            const projectId = getProjectId();
            const ifcFileId = document.getElementById('ifcFile').value;
            const raumprogrammFileId = document.getElementById('raumprogrammFile').value;
            const existingRaumbuchFileId = document.getElementById('raumbuchFile').value; // Use Step 4 dropdown
            const targetFolder = getTargetFolder();

            console.log('updateRaumbuch() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('ProjectId:', projectId);
            console.log('IFC File ID:', ifcFileId);
            console.log('Raumprogramm File ID:', raumprogrammFileId);
            console.log('Existing Raumbuch File ID:', existingRaumbuchFileId);
            console.log('Target Folder:', targetFolder);

            if (!token || !projectId || !ifcFileId || !raumprogrammFileId || !existingRaumbuchFileId || !targetFolder) {
                let missingFields = [];
                if (!token) missingFields.push('Token');
                if (!projectId) missingFields.push('Project ID');
                if (!ifcFileId) missingFields.push('IFC File');
                if (!raumprogrammFileId) missingFields.push('Raumprogramm File');
                if (!existingRaumbuchFileId) missingFields.push('Raumbuch File (siehe Schritt 4)');
                if (!targetFolder) missingFields.push('Target Folder');
                
                showResult('step3Result', 'error', `‚ö† Bitte alle Felder ausf√ºllen. Fehlende Felder: ${missingFields.join(', ')}`);
                return;
            }

            showResult('step3Result', 'loading', '‚è≥ Aktualisiere Raumbuch... (kann einige Sekunden dauern)');

            try {
                const requestBody = {
                    accessToken: token,
                    projectId: projectId,
                    raumbuchFileId: existingRaumbuchFileId,
                    ifcFileId: ifcFileId,
                    raumprogrammFileId: raumprogrammFileId,
                    targetFolderId: targetFolder
                };

                console.log('Sending request body:', requestBody);

                const response = await fetch(`${API_BASE}/update-raumbuch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    const fileName = data.raumbuchFileName || 'Raumbuch.xlsx';
                    const fileId = data.raumbuchFileId || 'N/A';
                    
                    console.log('Raumbuch updated successfully:', fileName, fileId);
                    
                    // Save to config
                    currentConfig.files.raumbuch = {
                        id: fileId,
                        name: fileName
                    };
                    
                    let message = `‚úÖ Raumbuch aktualisiert!<br>Datei: ${fileName}<br>`;
                    message += `R√§ume hinzugef√ºgt: ${data.roomsAdded || 0}<br>`;
                    message += `R√§ume aktualisiert: ${data.roomsUpdated || 0}<br>`;
                    message += `R√§ume unver√§ndert: ${data.roomsUnchanged || 0}<br>`;
                    message += `<br><strong>Neue Analyse:</strong><br>`;
                    
                    if (data.analysis && data.analysis.length > 0) {
                        data.analysis.forEach(a => {
                            const status = a.isOverLimit ? '‚ö†Ô∏è √úBERSCHUSS' : '‚úÖ OK';
                            message += `- ${a.roomCategory}: ${a.percentage.toFixed(1)}% ${status}<br>`;
                        });
                    }
                    
                    showResult('step3Result', 'success', message);
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    showResult('step3Result', 'error', `‚ùå ${errorMsg}`);
                }
            } catch (error) {
                console.error('Error in updateRaumbuch:', error);
                showResult('step3Result', 'error', `‚ùå Fehler: ${error.message}`);
            }
        }

        async function writePset() {
            const token = getToken();
            const ifcFileId = document.getElementById('ifcFile').value; // Read from Step 3
            const raumbuchFileId = document.getElementById('raumbuchFile').value; // Read from Step 3
            const targetFolder = getTargetFolder();

            if (!token || !ifcFileId || !raumbuchFileId || !targetFolder) {
                showResult('step4Result', 'error', '‚ö† Bitte alle Felder ausf√ºllen (IFC und Raumbuch aus Schritt 3 erforderlich)');
                return;
            }

            showResult('step4Result', 'loading', '‚è≥ Schreibe Pset "Raumbuch" in IFC... (kann einige Sekunden dauern)');

            try {
                const response = await fetch(`${API_BASE}/write-raumbuch-pset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        ifcFileId: ifcFileId,
                        raumbuchFileId: raumbuchFileId,
                        targetFolderId: targetFolder
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    let message = `‚úÖ ${data.Message || data.message || 'Pset erfolgreich geschrieben!'}<br>`;
                    message += `R√§ume aktualisiert: ${data.RoomsUpdated || data.roomsUpdated || 0}<br>`;
                    message += `R√§ume √ºbersprungen: ${data.RoomsSkipped || data.roomsSkipped || 0}`;
                    
                    if (data.Warnings && data.Warnings.length > 0) {
                        message += '<br><br><strong>Warnungen:</strong><br>';
                        data.Warnings.forEach(w => {
                            message += `- ${w}<br>`;
                        });
                    }
                    
                    showResult('step4Result', 'success', message);
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    showResult('step4Result', 'error', `‚ùå ${errorMsg}`);
                }
            } catch (error) {
                showResult('step4Result', 'error', `‚ùå Fehler: ${error.message}`);
            }
        }

        async function updatePset() {
            const token = getToken();
            const ifcFileId = document.getElementById('ifcFile').value; // Read from Step 3
            const raumbuchFileId = document.getElementById('raumbuchFile').value; // Read from Step 3
            const targetFolder = getTargetFolder();

            if (!token || !ifcFileId || !raumbuchFileId || !targetFolder) {
                showResult('step4Result', 'error', '‚ö† Bitte alle Felder ausf√ºllen (IFC und Raumbuch aus Schritt 3 erforderlich)');
                return;
            }

            showResult('step4Result', 'loading', '‚è≥ Aktualisiere Pset "Raumbuch" in IFC...');

            try {
                const response = await fetch(`${API_BASE}/update-raumbuch-pset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        ifcFileId: ifcFileId,
                        raumbuchFileId: raumbuchFileId,
                        targetFolderId: targetFolder
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    let message = `‚úÖ ${data.Message || data.message || 'Pset erfolgreich aktualisiert!'}<br>`;
                    message += `R√§ume aktualisiert: ${data.RoomsUpdated || data.roomsUpdated || 0}<br>`;
                    message += `R√§ume √ºbersprungen: ${data.RoomsSkipped || data.roomsSkipped || 0}`;
                    
                    showResult('step4Result', 'success', message);
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    showResult('step4Result', 'error', `‚ùå ${errorMsg}`);
                }
            } catch (error) {
                showResult('step4Result', 'error', `‚ùå Fehler: ${error.message}`);
            }
        }

        async function deletePset() {
            const token = getToken();
            const ifcFileId = document.getElementById('ifcFile').value; // Read from Step 3
            const targetFolder = getTargetFolder();

            if (!token || !ifcFileId || !targetFolder) {
                showResult('step4Result', 'error', '‚ö† Bitte IFC File aus Schritt 3 ausw√§hlen');
                return;
            }

            if (!confirm('Sind Sie sicher, dass Sie das Pset "Raumbuch" aus der IFC-Datei l√∂schen m√∂chten?')) {
                return;
            }

            showResult('step4Result', 'loading', '‚è≥ L√∂sche Pset "Raumbuch" aus IFC...');

            try {
                const response = await fetch(`${API_BASE}/delete-raumbuch-pset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        ifcFileId: ifcFileId,
                        targetFolderId: targetFolder
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    let message = `‚úÖ ${data.Message || data.message || 'Pset erfolgreich gel√∂scht!'}<br>`;
                    message += `Psets entfernt: ${data.PsetsRemoved || data.psetsRemoved || 0}`;
                    
                    showResult('step4Result', 'success', message);
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    showResult('step4Result', 'error', `‚ùå ${errorMsg}`);
                }
            } catch (error) {
                showResult('step4Result', 'error', `‚ùå Fehler: ${error.message}`);
            }
        }

        async function createRoomSheets() {
            const token = getToken();
            const raumbuchFileId = document.getElementById('raumbuchFile').value;
            const targetFolder = getTargetFolder();

            console.log('createRoomSheets() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('Raumbuch File ID:', raumbuchFileId);
            console.log('Target Folder:', targetFolder);

            if (!token || !raumbuchFileId || !targetFolder) {
                showResult('step5_1Result', 'error', '‚ö† Bitte Token, Raumbuch-Datei und Zielordner ausw√§hlen');
                return;
            }

            showResult('step5_1Result', 'loading', '‚è≥ Erstelle Raumlisten...');

            try {
                const requestBody = {
                    accessToken: token,
                    raumbuchFileId: raumbuchFileId,
                    targetFolderId: targetFolder
                };

                console.log('Sending request body:', requestBody);

                const response = await fetch(`${API_BASE}/create-room-sheets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok && data.success) {
                    let message = `‚úÖ ${data.message}<br>`;
                    message += `Raumlisten erstellt: ${data.roomSheetsCreated || 0}`;
                    
                    showResult('step5_1Result', 'success', message);
                } else {
                    const errorMsg = data.message || data.exceptionMessage || `HTTP ${response.status}`;
                    showResult('step5_1Result', 'error', `‚ùå ${errorMsg}`);
                }
            } catch (error) {
                showResult('step5_1Result', 'error', `‚ùå Fehler: ${error.message}`);
            }
        }

        async function loadIfcFilesForInventory() {
            const token = getToken();
            const inventoryFolderId = document.getElementById('inventoryFolder').value;

            console.log('loadIfcFilesForInventory() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('Inventory Folder ID:', inventoryFolderId);

            if (!token || !inventoryFolderId) {
                showResult('step5_2Result', 'error', '‚ö† Bitte Token und IFC-Ordner ausw√§hlen');
                return;
            }

            showResult('step5_2Result', 'loading', '‚è≥ IFC-Dateien werden geladen...');

            try {
                const response = await fetch(`${API_PROJECT}/files`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        accessToken: token, 
                        folderId: inventoryFolderId,
                        fileExtensions: ['ifc']
                    })
                });

                console.log('IFC files response status:', response.status);
                const data = await response.json();
                console.log('IFC files response data:', data);

                if (response.ok && data.success) {
                    const ifcFilesList = document.getElementById('ifcFilesList');
                    
                    if (data.files && data.files.length > 0) {
                        // Create checkboxes for each IFC file
                        let html = '';
                        data.files.forEach(file => {
                            html += `
                                <div class="file-checkbox">
                                    <input type="checkbox" id="ifc_${file.id}" value="${file.id}" class="ifc-file-checkbox">
                                    <label for="ifc_${file.id}">${file.name}</label>
                                </div>
                            `;
                        });
                        ifcFilesList.innerHTML = html;
                        showResult('step5_2Result', 'success', `‚úÖ ${data.files.length} IFC-Datei(en) gefunden`);
                    } else {
                        ifcFilesList.innerHTML = '<p style="color: #666;">Keine IFC-Dateien gefunden</p>';
                        showResult('step5_2Result', 'warning', '‚ö† Keine IFC-Dateien im ausgew√§hlten Ordner gefunden');
                    }
                } else {
                    const errorMsg = data.message || `HTTP ${response.status}`;
                    showResult('step5_2Result', 'error', `‚ùå ${errorMsg}`);
                }
            } catch (error) {
                showResult('step5_2Result', 'error', `‚ùå Fehler: ${error.message}`);
            }
        }

        async function fillInventory() {
            const token = getToken();
            const raumbuchFileId = document.getElementById('raumbuchFile').value;
            const targetFolder = getTargetFolder();
            const psetPartialName = document.getElementById('psetPartialName').value;
            const roomPropertyName = document.getElementById('roomPropertyName').value;

            // Get selected IFC file IDs
            const selectedCheckboxes = document.querySelectorAll('.ifc-file-checkbox:checked');
            const ifcFileIds = Array.from(selectedCheckboxes).map(cb => cb.value);

            console.log('fillInventory() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('Raumbuch File ID:', raumbuchFileId);
            console.log('IFC File IDs:', ifcFileIds);
            console.log('Pset Partial Name:', psetPartialName);
            console.log('Room Property Name:', roomPropertyName);

            if (!token || !raumbuchFileId || !targetFolder || ifcFileIds.length === 0) {
                showResult('step5_2Result', 'error', '‚ö† Bitte Token, Raumbuch-Datei, Zielordner und mindestens eine IFC-Datei ausw√§hlen');
                return;
            }

            if (!psetPartialName || !roomPropertyName) {
                showResult('step5_2Result', 'error', '‚ö† Bitte Pset-Name und Raumnummer-Eigenschaft angeben');
                return;
            }

            showResult('step5_2Result', 'loading', '‚è≥ Inventar wird erstellt...');

            try {
                const requestBody = {
                    accessToken: token,
                    raumbuchFileId: raumbuchFileId,
                    ifcFileIds: ifcFileIds,
                    psetPartialName: psetPartialName,
                    roomPropertyName: roomPropertyName,
                    targetFolderId: targetFolder
                };

                console.log('Sending request body:', requestBody);

                const response = await fetch(`${API_BASE}/fill-inventory`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok && data.success) {
                    let message = `‚úÖ ${data.message}<br>`;
                    message += `R√§ume aktualisiert: ${data.roomsUpdated || 0}<br>`;
                    message += `Objekte hinzugef√ºgt: ${data.totalItems || 0}`;
                    
                    if (data.warnings && data.warnings.length > 0) {
                        message += '<br><br><strong>Warnungen:</strong><br>';
                        data.warnings.forEach(w => {
                            message += `‚ö† ${w}<br>`;
                        });
                    }
                    
                    showResult('step5_2Result', 'success', message);
                } else {
                    const errorMsg = data.message || data.exceptionMessage || `HTTP ${response.status}`;
                    showResult('step5_2Result', 'error', `‚ùå ${errorMsg}`);
                }
            } catch (error) {
                showResult('step5_2Result', 'error', `‚ùå Fehler: ${error.message}`);
            }
        }

    </script>
</body>
</html>
