<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raumbuch Manager - Lokal</title>
    <link rel="stylesheet" href="Content/Site.css">
    <!-- Trimble Workspace API -->
    <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
    <script src="Scripts/app.js"></script>
</head>



<body>
    <!-- =============================== -->
    <!-- TOP TAB NAVIGATION (Trimble Connect style) - FLYTTET HIT FOR FULL BREDDE -->
    <!-- =============================== -->
    <nav class="tc-tabs">

        <div class="tc-tab active" onclick="openTab('tab-raumprogramm')">
            <img src="Img/book.png" class="tc-tab-icon" />
            <span>Raumprogramm</span>
        </div>

        <div class="tc-tab" onclick="openTab('tab-ausgefuehrt')">
            <img src="Img/book.png" class="tc-tab-icon" />
            <span>AusgefÃ¼hrt</span>
        </div>

        <div class="tc-tab" onclick="openTab('tab-analyse')">
            <img src="Img/analyse.png" class="tc-tab-icon" />
            <span>Analyse</span>
        </div>

        <div class="tc-tab" onclick="openTab('tab-ausstattung')">
            <img src="Img/material.png" class="tc-tab-icon" />
            <span>Ausstattungen</span>
        </div>

        <div class="tc-tab" onclick="openTab('tab-bcf')">
            <img src="Img/mail.png" class="tc-tab-icon" />
            <span>Nachricht</span>
        </div>

        <div class="tc-tab" onclick="openTab('tab-konfig')">
            <img src="Img/settings.png" class="tc-tab-icon" />
            <span>Einstellungen</span>
        </div>
    </nav>

    <div class="container">
        <main>

            <!-- ========================================================= -->
            <!-- TAB 1 â€“ KONFIGURATION + STEP 1 + STEP 3 + STEP 4          -->
            <!-- ========================================================= -->
            <div id="tab-konfig" class="tab-content">


                <!-- STEP 0 â€“ CONFIGURATION -->
                <section class="card">
                    <h2>Konfiguration</h2>

                    <!-- Authentication is managed by Trimble Connect Extension API -->
                    <!-- Manual token input field (commented out - authentication handled by extension API) -->
                    <!--
                    <div class="form-group">
                        <label for="accessToken">Access Token:</label>
                        <input type="text" id="accessToken" class="form-control" placeholder="Token hier einfÃ¼gen...">
                    </div>
                    -->
                    <!-- Project ID retrieved from Trimble Connect context -->
                    <!-- Manual project ID input field (commented out - project ID retrieved from extension context) -->
                    <!--
                    <div class="form-group">
                        <label for="projectId">Project ID:</label>
                        <input type="text" id="projectId" class="form-control" value="y7-N0uBcXNI">
                    </div>
                    -->

                    <div class="form-group">
                        <label for="configName">Konfigurationsname:</label>
                        <div style="display:flex; gap:10px; align-items:flex-start;">
                            <input type="text" id="configName" class="form-control" placeholder="z.B. 'MeinProjekt_Config'">
                            </select>                            <button class="btn btn-secondary" onclick="saveConfig()">ğŸ’¾ Konfiguration speichern</button>
                            <button class="btn btn-primary" onclick="loadProjectData()">ğŸ“ Projektdaten laden</button>
                        </div>
                        <small>Geben Sie einen Namen fÃ¼r die Konfigurationsdatei an.</small>
                    </div>

                    <div class="form-group">
                        <label>Gespeicherte Konfigurationen:</label>
                        <div style="display:flex; gap:10px; align-items:flex-start;">
                            <select id="savedConfigs" class="form-control" style="flex:1;">
                                <option value="">-- Laden Sie Projektdaten um Konfigurationen zu sehen --</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadConfigFromAzure()">ğŸ“¥ Laden</button>
                            <button class="btn btn-danger" onclick="deleteConfigFromAzure()">ğŸ—‘ï¸ LÃ¶schen</button>
                        </div>
                    </div>
                    <hr>

                    <!-- Target Folder -->
                    <div class="form-group">
                        <label for="targetFolder">Zielordner:</label>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <select id="targetFolder" class="form-control">
                                <option value="">-- Klicken Sie auf "Projektdaten laden" --</option>
                            </select>
                            <button class="btn btn-secondary" onclick="fetchFiles()">ğŸ”„ Dateien laden</button>
                            <button class="btn btn-secondary" onclick="window.open('https://web.connect.trimble.com/projects/y7-N0uBcXNI/data/folder/syZ23DptUaQ', '_blank')">ğŸ“ Zielordner Ã¶ffnen</button>
                        </div>
                    </div>

                    <div id="connectionResult" class="result"></div>
                </section>


                <!-- =============================== -->
                <!-- Kombinert: Vorlage + Raumbuch -->
                <!-- =============================== -->
                <section class="card">
                    <h2>Raumbuch</h2>
                    <p>Vorlage laden und Raumbuch erzeugen oder aktualisieren</p>

                    <!-- TEMPLATE -->
                    <div class="form-group">
                        <label for="templateFile">Vorlagendatei (.xlsx):</label>
                        <div style="display:flex; gap:10px; align-items:flex-start;">
                            <select id="templateFile" class="form-control">
                                <option value="">-- Vorlage auswÃ¤hlen nach "Dateien laden" --</option>
                            </select>

                            <!-- Load template headers for mapping -->
                            <button class="btn btn-primary" onclick="loadTemplateHeaders()">ğŸ“¥ Vorlagen laden</button>
                        </div>
                    </div>

                    <!-- COLUMN MAPPING TABLE -->
                    <div class="form-group" id="mappingTableContainer" style="display:none;">
                        <label>Spaltenzuordnung:</label>
                        <table class="mapping-table" style="width:100%; max-width:500px; border-collapse:collapse; margin-top:8px;">
                            <thead>
                                <tr>
                                    <th style="text-align:left; padding:8px; border-bottom:2px solid var(--tc-border); background:#f5f5f5;">Eigenschaft</th>
                                    <th style="text-align:left; padding:8px; border-bottom:2px solid var(--tc-border); background:#f5f5f5;">Excel-Spalte</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding:8px; border-bottom:1px solid var(--tc-border);">Raumtyp</td>
                                    <td style="padding:8px; border-bottom:1px solid var(--tc-border);">
                                        <select id="mappingRaumtyp" class="form-control" style="width:100%; max-width:200px;">
                                            <option value="">-- Spalte wÃ¤hlen --</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding:8px; border-bottom:1px solid var(--tc-border);">Raumkategorie</td>
                                    <td style="padding:8px; border-bottom:1px solid var(--tc-border);">
                                        <select id="mappingRaumkategorie" class="form-control" style="width:100%; max-width:200px;">
                                            <option value="">-- Spalte wÃ¤hlen --</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding:8px; border-bottom:1px solid var(--tc-border);">FlÃ¤che Soll</td>
                                    <td style="padding:8px; border-bottom:1px solid var(--tc-border);">
                                        <select id="mappingFlaecheSoll" class="form-control" style="width:100%; max-width:200px;">
                                            <option value="">-- Spalte wÃ¤hlen --</option>
                                        </select>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <small>WÃ¤hlen Sie die Spalten aus der Vorlage, die den Eigenschaften entsprechen</small>
                    </div>

                    <div id="step1Result" class="result"></div>

                    <!-- IFC FILE -->
                    <div class="form-group">
                        <label for="ifcFile">Datei mit IfcSpaces (.ifc):</label>
                        <select id="ifcFile" class="form-control">
                            <option value="">-- IFC auswÃ¤hlen nach "Dateien laden" --</option>
                        </select>
                    </div>

                    <!-- RAUMBUCH -->
                    <div class="form-group">
                        <label for="raumbuchFile">Raumbuch-Datei (.xlsx):</label>

                        <div style="display:flex; gap:10px; align-items:flex-start;">
                            <select id="raumbuchFile" class="form-control" style="flex:1;">
                                <option value="">-- Raumbuch auswÃ¤hlen nach "Dateien laden" --</option>
                            </select>

                            <!-- IFC -> Raumbuch -->
                            <button class="btn btn-primary" onclick="createRaumbuch()">ğŸ—ï¸ Raumbuch erstellen</button>
                            <button class="btn btn-secondary" onclick="updateRaumbuch()">ğŸ”„ Raumbuch aktualisieren</button>
                        </div>

                        <small>Wird automatisch ausgefÃ¼llt nach "Raumbuch erstellen"</small>
                    </div>

                    <div id="step3Result" class="result"></div>
                </section>


            </div> <!-- END TAB 1 -->
            <!-- ========================================================= -->
            <!-- TAB - RAUMPROGRAMM (SOLL Data Management)                 -->
            <!-- ========================================================= -->
            <div id="tab-raumprogramm" class="tab-content active">
                <!-- Raumprogramm Overview -->
                <section class="card">
                    <h2>Raumprogramm Ãœbersicht (SOLL)</h2>
                    <p>Zeigt die geplanten (SOLL) Werte. FÃ¼r IST-Werte nutzen Sie den Tab "AusgefÃ¼hrt".</p>

                    <!-- Filters -->
                    <div class="filter-controls">
                        <div class="form-group" style="display:inline-block; margin-right:15px;">
                            <label for="raumprogram-filter-roomtype">Raumtyp:</label>
                            <select id="raumprogram-filter-roomtype" class="form-control" style="width:200px;" onchange="loadRaumprogramData()">
                                <option value="">-- Alle --</option>
                            </select>
                        </div>
                        <div class="form-group" style="display:inline-block; margin-right:15px;">
                            <label for="raumprogram-filter-inventory">Inventar:</label>
                            <select id="raumprogram-filter-inventory" class="form-control" style="width:200px;" multiple onchange="loadRaumprogramData()" title="Strg+Klick fÃ¼r Mehrfachauswahl">
                                <option value="">-- Alle --</option>
                            </select>
                        </div>
                        <div class="form-group" style="display:inline-block;">
                            <label for="raumprogram-search">Suche:</label>
                            <input type="text" id="raumprogram-search" class="form-control" placeholder="Raum suchen..." style="width:200px;" onkeyup="loadRaumprogramData()">
                        </div>
                    </div>

                    <!-- Data Table - SOLL only, dynamic columns based on visibility settings -->
                    <div class="analyse-table-container" style="max-height:400px; overflow-y:auto; overflow-x:auto;">
                        <table class="analyse-table" id="raumprogramTable">
                            <thead id="raumprogramTableHead">
                                <tr>
                                    <th>Raumtyp</th>
                                    <th>Raumkategorie</th>
                                    <th>Raum</th>
                                    <th>NettoflÃ¤che (mÂ²)</th>
                                    <th>BruttoflÃ¤che (mÂ²)</th>
                                </tr>
                            </thead>
                            <tbody id="raumprogramTableBody">
                                <tr>
                                    <td colspan="5" style="text-align:center; color:#666;">
                                        Keine Daten vorhanden. Klicken Sie auf "Daten laden".
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <span id="raumprogramPaginationInfo">Seite 1 von 1</span>
                        </div>
                        <div>
                            <button class="btn btn-secondary" id="raumprogramPrevPage" onclick="loadRaumprogramData(currentRaumprogramPage - 1)" disabled>â—€ ZurÃ¼ck</button>
                            <button class="btn btn-secondary" id="raumprogramNextPage" onclick="loadRaumprogramData(currentRaumprogramPage + 1)" disabled>Weiter â–¶</button>
                        </div>
                    </div>

                    <div style="margin-top:15px;">
                        <button class="btn btn-primary" onclick="loadRaumprogramData()">ğŸ“¥ Daten laden</button>
                        <button class="btn btn-secondary" onclick="refreshAllMasterData()">ğŸ”„ Stammdaten aktualisieren</button>
                    </div>
                    <div id="raumprogramResult" class="result"></div>

                    <!-- Column Visibility Controls -->
                    <div style="margin-bottom:10px; padding:10px; background:#f5f5f5; border-radius:5px;">
                        <label style="font-weight:bold; margin-right:15px;">Spalten anzeigen:</label>
                        <label style="margin-right:10px;"><input type="checkbox" id="col-raumtyp" checked onchange="loadRaumprogramData()"> Raumtyp</label>
                        <label style="margin-right:10px;"><input type="checkbox" id="col-raumkategorie" checked onchange="loadRaumprogramData()"> Raumkategorie</label>
                        <label style="margin-right:10px;"><input type="checkbox" id="col-raum" checked onchange="loadRaumprogramData()"> Raum</label>
                        <label style="margin-right:10px;"><input type="checkbox" id="col-netarea" checked onchange="loadRaumprogramData()"> NettoflÃ¤che</label>
                        <label style="margin-right:10px;"><input type="checkbox" id="col-grossarea" checked onchange="loadRaumprogramData()"> BruttoflÃ¤che</label>
                        <label style="margin-right:10px;"><input type="checkbox" id="col-areaplanned" onchange="loadRaumprogramData()"> FlÃ¤che SOLL</label>
                        <label style="margin-right:10px;"><input type="checkbox" id="col-description" onchange="loadRaumprogramData()"> Beschreibung</label>
                        <label style="margin-right:10px;"><input type="checkbox" id="col-objecttype" onchange="loadRaumprogramData()"> Objekttyp</label>
                        <label style="margin-right:10px;"><input type="checkbox" id="col-predefinedtype" onchange="loadRaumprogramData()"> Vordefinierter Typ</label>
                    </div>


                </section>


                <!-- Master Data Management -->
                <section class="card">
                    <h2>Stammdaten verwalten</h2>

                    <div id="masterDataResult" class="result"></div>

                    <div class="subsection">
                        <h3>Ausstattungseigenschaften (Inventory Templates)</h3>
                        <div class="form-group">
                            <label for="newInventoryPropertyName">Neue Eigenschaft:</label>
                            <div style="display:flex; gap:10px; align-items:flex-start;">
                                <input type="text" id="newInventoryPropertyName" class="form-control" placeholder="z.B. 'Bodenbelag', 'Beleuchtung'" style="flex:1;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="newInventoryDataType">Datentyp:</label>
                            <div style="display:flex; gap:10px; align-items:flex-start;">
                                <select id="newInventoryDataType" class="form-control" style="width:200px;">
                                    <option value="Text">Text</option>
                                    <option value="Number">Zahl (Number)</option>
                                    <option value="Integer">Ganzzahl (Integer)</option>
                                    <option value="Decimal">Dezimalzahl (Decimal)</option>
                                    <option value="Boolean">Ja/Nein (Boolean)</option>
                                </select>
                                <input type="text" id="newInventoryUnit" class="form-control" placeholder="Einheit (z.B. mÂ², kg, StÃ¼ck)" style="width:180px;">
                                <button class="btn btn-primary" onclick="createInventoryTemplate()">â• HinzufÃ¼gen</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Vorhandene Eigenschaften:</label>
                            <select id="existingInventoryTemplates" class="form-control" size="5" style="width:100%;" multiple>
                                <option value="">-- Laden Sie die Daten --</option>
                            </select>
                            <small>Mehrfachauswahl: Strg+Klick fÃ¼r mehrere Inventare</small>
                            <div style="margin-top:10px;">
                                <button class="btn btn-secondary" onclick="loadInventoryTemplates()">ğŸ”„ Laden</button>
                                <button class="btn btn-danger" onclick="deleteSelectedInventoryTemplate()">ğŸ—‘ï¸ LÃ¶schen</button>
                            </div>
                        </div>
                    </div>

                    <hr style="margin:20px 0;">

                    <!-- RÃ¤ume verwalten (Room Management) - SOLL only, IST moved to AusgefÃ¼hrt tab -->
                    <h3>RÃ¤ume verwalten (SOLL)</h3>
                    <div class="form-group">
                        <label for="roomRoomType">Raumtyp:</label>
                        <select id="roomRoomType" class="form-control">
                            <option value="">-- Raumtyp auswÃ¤hlen --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="roomName">Raum Name:</label>
                        <input type="text" id="roomName" class="form-control" placeholder="z.B. 'BÃ¼ro 101'">
                    </div>
                    <div class="form-group">
                        <label for="roomAreaPlanned">FlÃ¤che SOLL (mÂ²):</label>
                        <input type="number" id="roomAreaPlanned" class="form-control" step="0.01" placeholder="0.00" style="max-width:200px;">
                    </div>
                    <div style="margin-top:10px;">
                        <button class="btn btn-primary" onclick="createRoom()">â• Raum hinzufÃ¼gen</button>
                    </div>
                    <div id="roomManagementResult" class="result"></div>

                    <hr style="margin:20px 0;">

                    <div class="subsection">
                        <h3>Raumtypen</h3>
                        <div class="form-group">
                            <label for="newRoomTypeName">Neuer Raumtyp:</label>
                            <div style="display:flex; gap:10px; align-items:flex-start;">
                                <input type="text" id="newRoomTypeName" class="form-control" placeholder="z.B. 'BÃ¼ro', 'Besprechungsraum'" style="flex:1;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="newRoomTypeCategory">Raumkategorie:</label>
                            <div style="display:flex; gap:10px; align-items:flex-start;">
                                <input type="text" id="newRoomTypeCategory" class="form-control" placeholder="z.B. 'ArbeitsflÃ¤che', 'GemeinschaftsflÃ¤che'" style="flex:1;">
                                <button class="btn btn-primary" onclick="createRoomType()">â• HinzufÃ¼gen</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Vorhandene Raumtypen:</label>
                            <select id="existingRoomTypes" class="form-control" size="5" style="width:100%;">
                                <option value="">-- Laden Sie die Daten --</option>
                            </select>
                            <div style="margin-top:10px;">
                                <button class="btn btn-secondary" onclick="loadRoomTypes()">ğŸ”„ Laden</button>
                                <button class="btn btn-danger" onclick="deleteSelectedRoomType()">ğŸ—‘ï¸ LÃ¶schen</button>
                            </div>
                        </div>
                    </div>

                    <hr style="margin:20px 0;">


                </section>

 
                <!-- Import/Export -->
                <section class="card">
                    <h2>Import / Export</h2>
                    <p>Excel-Daten importieren oder exportieren</p>

                    <div class="form-group">
                        <label for="raumprogramImportFile">Excel-Datei fÃ¼r Import:</label>
                        <select id="raumprogramImportFile" class="form-control">
                            <option value="">-- Datei auswÃ¤hlen (nach "Dateien laden" in Einstellungen) --</option>
                        </select>
                    </div>

                    <div style="margin-top:15px;">
                        <button class="btn btn-primary" onclick="importRaumprogramFromExcel()">ğŸ“¥ Import (Excel â†’ SQL)</button>
                        <button class="btn btn-secondary" onclick="exportRaumprogramToExcel()">ğŸ“¤ Export (SQL â†’ Excel)</button>
                    </div>
                    <div id="importExportResult" class="result"></div>
                </section>

            </div> <!-- END TAB RAUMPROGRAMM -->
            <!-- ========================================================= -->
            <!-- TAB - AUSGEFÃœHRT (IST/Actuals Data Management)            -->
            <!-- ========================================================= -->
            <div id="tab-ausgefuehrt" class="tab-content">

                <section class="card">
                    <h2>AusgefÃ¼hrt (IST-Werte)</h2>
                    <p>Hier werden die tatsÃ¤chlichen (IST) Werte der RÃ¤ume und Inventare erfasst und verwaltet.</p>

                    <!-- Filters -->
                    <div class="filter-controls">
                        <div class="form-group" style="display:inline-block; margin-right:15px;">
                            <label for="ist-filter-roomtype">Raumtyp:</label>
                            <select id="ist-filter-roomtype" class="form-control" style="width:200px;" onchange="loadIstData()">
                                <option value="">-- Alle --</option>
                            </select>
                        </div>
                        <div class="form-group" style="display:inline-block; margin-right:15px;">
                            <label for="ist-filter-inventory">Inventar:</label>
                            <select id="ist-filter-inventory" class="form-control" style="width:200px;" multiple onchange="loadIstData()" title="Strg+Klick fÃ¼r Mehrfachauswahl">
                                <option value="">-- Alle --</option>
                            </select>
                        </div>
                        <div class="form-group" style="display:inline-block;">
                            <label for="ist-search">Suche:</label>
                            <input type="text" id="ist-search" class="form-control" placeholder="Raum suchen..." style="width:200px;" onkeyup="loadIstData()">
                        </div>
                    </div>

                    <!-- Data Table - IST values with comparison to SOLL -->
                    <div class="analyse-table-container" style="max-height:400px; overflow-y:auto; overflow-x:auto;">
                        <table class="analyse-table" id="istTable">
                            <thead id="istTableHead">
                                <tr>
                                    <th>Raumtyp</th>
                                    <th>Raum Name</th>
                                    <th>NettoflÃ¤che (mÂ²)</th>
                                    <th>BruttoflÃ¤che (mÂ²)</th>
                                    <th>Kommentar</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="istTableBody">
                                <tr>
                                    <td colspan="6" style="text-align:center; color:#666;">
                                        Keine Daten vorhanden. Klicken Sie auf "Daten laden".
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <span id="istPaginationInfo">Seite 1 von 1</span>
                        </div>
                        <div>
                            <button class="btn btn-secondary" id="istPrevPage" onclick="loadIstData(currentIstPage - 1)" disabled>â—€ ZurÃ¼ck</button>
                            <button class="btn btn-secondary" id="istNextPage" onclick="loadIstData(currentIstPage + 1)" disabled>Weiter â–¶</button>
                        </div>
                    </div>

                    <div style="margin-top:15px;">
                        <button class="btn btn-primary" onclick="loadIstData()">ğŸ“¥ Daten laden</button>
                        <button class="btn btn-secondary" onclick="syncIstFromIfc()" title="Coming Soon">ğŸ”„ IST aus IFC aktualisieren</button>
                        <button class="btn btn-primary" onclick="saveIstChanges()" title="Coming Soon">ğŸ’¾ Ã„nderungen speichern</button>
                        <small style="display:block; margin-top:5px; color:#666;">Hinweis: IFC-Synchronisation und Speichern werden in einer zukÃ¼nftigen Version implementiert.</small>
                    </div>
                    <div id="istResult" class="result"></div>
                </section>

                <!-- IFC Data Source -->
                <section class="card">
                    <h2>IFC Datenquelle <span style="font-size:0.7em; color:#666;">(Coming Soon)</span></h2>
                    <p>WÃ¤hlen Sie eine IFC-Datei aus, um IST-Werte automatisch zu extrahieren.</p>

                    <div class="form-group">
                        <label for="istIfcFile">IFC-Datei mit IfcSpaces:</label>
                        <select id="istIfcFile" class="form-control">
                            <option value="">-- IFC auswÃ¤hlen nach "Dateien laden" in Einstellungen --</option>
                        </select>
                    </div>

                    <div style="margin-top:15px;">
                        <button class="btn btn-primary" onclick="extractIstFromIfc()" title="Coming Soon">ğŸ“Š IST aus IFC extrahieren</button>
                    </div>
                    <div id="ifcExtractionResult" class="result"></div>
                </section>

            </div> <!-- END TAB AUSGEFÃœHRT -->
            <!-- ========================================================= -->
            <!-- TAB 2 â€“ ANALYSE (SOLL/IST + ZUSAMMENFASSUNG)              -->
            <!-- ========================================================= -->
            <div id="tab-analyse" class="tab-content">

                <!-- KPI Summary Widget -->
                <section class="card kpi-widget">
                    <h2>Ãœbersicht</h2>
                    <div class="kpi-container">
                        <div class="kpi-item">
                            <span class="kpi-label">SOLL Gesamt</span>
                            <span class="kpi-value" id="kpiSollTotal">- mÂ²</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-label">IST Gesamt</span>
                            <span class="kpi-value" id="kpiIstTotal">- mÂ²</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-label">Abweichung</span>
                            <span class="kpi-value" id="kpiDeviation">- %</span>
                        </div>
                        <div class="kpi-item kpi-status-ok">
                            <span class="kpi-label">ErfÃ¼llt</span>
                            <span class="kpi-value" id="kpiOkCount">0</span>
                        </div>
                        <div class="kpi-item kpi-status-under">
                            <span class="kpi-label">Unterschritten</span>
                            <span class="kpi-value" id="kpiUnderCount">0</span>
                        </div>
                        <div class="kpi-item kpi-status-over">
                            <span class="kpi-label">Ãœberschritten</span>
                            <span class="kpi-value" id="kpiOverCount">0</span>
                        </div>
                    </div>
                </section>

                <!-- Tolerance Configuration -->
                <section class="card">
                    <h2>Toleranz-Einstellungen</h2>
                    <div class="tolerance-controls">
                        <div class="form-group" style="display:inline-block; margin-right:20px;">
                            <label for="toleranceMin">Minimum Toleranz (%):</label>
                            <input type="number" id="toleranceMin" class="form-control" value="-10" min="-100" max="0" style="width:100px;">
                        </div>
                        <div class="form-group" style="display:inline-block; margin-right:20px;">
                            <label for="toleranceMax">Maximum Toleranz (%):</label>
                            <input type="number" id="toleranceMax" class="form-control" value="10" min="0" max="100" style="width:100px;">
                        </div>
                        <button class="btn btn-secondary" onclick="applyToleranceSettings()">Toleranz anwenden</button>
                    </div>
                </section>

                <!-- Filter and Search Controls -->
                <section class="card">
                    <h2>Filter & Suche</h2>
                    <div class="filter-controls">
                        <div class="filter-buttons">
                            <button class="btn btn-secondary filter-btn active" data-filter="all" onclick="filterAnalyseTable('all')">Alle</button>
                            <button class="btn btn-secondary filter-btn" data-filter="ok" onclick="filterAnalyseTable('ok')">âœ… ErfÃ¼llt</button>
                            <button class="btn btn-secondary filter-btn" data-filter="under" onclick="filterAnalyseTable('under')">âš ï¸ Unterschritten</button>
                            <button class="btn btn-secondary filter-btn" data-filter="over" onclick="filterAnalyseTable('over')">ğŸ“Š Ãœberschritten</button>
                        </div>
                        <div class="search-box">
                            <input type="text" id="analyseSearch" class="form-control" placeholder="Suche nach Raumtyp..." onkeyup="searchAnalyseTable()">
                        </div>
                    </div>
                </section>

                <!-- Zusammenfassung Table -->
                <section class="card">
                    <h2>Analysetabelle</h2>
                    <p>Ãœbersicht der FlÃ¤chenanalyse nach Raumkategorie</p>

                    <div class="analyse-table-container">
                        <table class="analyse-table" id="analyseTable">
                            <thead>
                                <tr>
                                    <th onclick="sortAnalyseTable(0)">Raumtyp â†•</th>
                                    <th onclick="sortAnalyseTable(1)">Raumkategorie â†•</th>
                                    <th onclick="sortAnalyseTable(2)">SOLL (mÂ²) â†•</th>
                                    <th onclick="sortAnalyseTable(3)">IST (mÂ²) â†•</th>
                                    <th>Abweichung</th>
                                    <th onclick="sortAnalyseTable(5)">Status â†•</th>
                                    <th>Kommentar</th>
                                </tr>
                            </thead>
                            <tbody id="analyseTableBody">
                                <tr>
                                    <td colspan="7" style="text-align:center; color:#666;">
                                        Keine Daten vorhanden. Bitte laden Sie eine Konfiguration oder erstellen Sie ein Raumbuch.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top:15px;">
                        <button class="btn btn-primary" onclick="loadAnalyseData()">ğŸ“¥ Daten laden</button>
                        <button class="btn btn-secondary" onclick="updateIstValues()">ğŸ”„ IST aktualisieren</button>
                        <button class="btn btn-secondary" onclick="recalculateStatus()">ğŸ“Š Status aktualisieren</button>
                        <button class="btn btn-primary" onclick="saveAnalyseChanges()">ğŸ’¾ Ã„nderungen speichern</button>
                    </div>
                    <div id="analyseResult" class="result"></div>
                </section>

                <!-- Soll/Ist-PrÃ¼fung (moved from Raumbuch tab) -->
                <section class="card">
                    <h2>Pset Raumbuch </h2>
                    <p>Die Differenz in der FlÃ¤che zwischen Raumprogramm (SOLL) und Raumbuch (IST) wird fÃ¼r jede Raumkategorie in Pset Raumbuch geschrieben.</p>

                    <button class="btn btn-primary" onclick="writePset()">ğŸ“ Pset erstellen</button>
                    <button class="btn btn-secondary" onclick="updatePset()">ğŸ”„ Pset aktualisieren</button>
                    <button class="btn btn-secondary" onclick="deletePset()">ğŸ—‘ï¸ Pset lÃ¶schen</button>
                    <button class="btn btn-secondary" onclick="openIn3DViewer()">ğŸ” In 3D-Viewer Ã¶ffnen</button>
                    <div id="step4Result" class="result"></div>
                </section>

            </div> <!-- END TAB 2 (ANALYSE) -->
            <!-- ========================================================= -->
            <!-- TAB 3 â€“ AUSSTATTUNGSVERWALTUNG (STEP 5)                   -->
            <!-- ========================================================= -->
            <div id="tab-ausstattung" class="tab-content">

                <section class="card">

                    <!-- Subsection: Room sheets -->
                    <div class="subsection">
                        <h2>RaumblÃ¤tter erstellen</h2>
                        <p>Erstellt ein Raumblatt pro Raum im Raumbuch</p>

                        <button class="btn btn-primary" onclick="createRoomSheets()">ğŸ“‹ RaumblÃ¤tter erstellen</button>
                        <button class="btn btn-secondary" onclick="deleteRoomLists()">ğŸ—‘ï¸ RaumblÃ¤tter lÃ¶schen</button>

                        <div id="step5_1Result" class="result"></div>
                    </div>

                    <hr style="margin:20px 0;">

                    <!-- Subsection: Inventory -->
                    <div class="subsection">
                        <h2>Ausstattung erstellen</h2>
                        <p>RaumblÃ¤tter mit Ausstattungen fÃ¼llen</p>

                        <div class="form-group">
                            <label for="inventoryFolder">Zielordner fÃ¼r IFC-Dateien:</label>
                            <select id="inventoryFolder" class="form-control">
                                <option value="">-- Klicken Sie auf "Projektdaten laden" --</option>
                            </select>
                        </div>

                        <button class="btn btn-primary" onclick="loadIfcFilesForInventory()">ğŸ“ IFC-Dateien laden</button>

                        <div class="form-group">
                            <label>IFC-Dateien auswÃ¤hlen:</label>
                            <div id="ifcFilesList" class="file-selection-list">
                                <p style="color:#666;">Klicken Sie auf "IFC-Dateien laden"</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="psetPartialName">Pset Name (teilweise):</label>
                            <input type="text" id="psetPartialName" class="form-control" value="Plancal nova">
                        </div>

                        <div class="form-group">
                            <label for="roomPropertyName">Eigenschaft fÃ¼r Raumnummer:</label>
                            <input type="text" id="roomPropertyName" class="form-control" value="Room Nbr">
                        </div>

                        <button class="btn btn-primary" onclick="discoverProperties()">ğŸ” Eigenschaften laden</button>

                        <div class="form-group">
                            <label for="additionalProperties">ZusÃ¤tzliche Eigenschaften:</label>
                            <select id="additionalProperties" class="form-control" multiple size="8">
                                <option value="">-- Klicken Sie auf "VerfÃ¼gbare Eigenschaften laden" --</option>
                            </select>
                        </div>

                        <button class="btn btn-primary" onclick="fillInventory()">ğŸ“¦ Ausstattungen erstellen</button>
                        <button class="btn btn-secondary" onclick="updateInventory()">ğŸ”„ Ausstattungen aktualisieren</button>

                        <div id="step5_2Result" class="result"></div>

                    </div>
                </section>

            </div> <!-- END TAB 2 -->
            <!-- ========================================================= -->
            <!-- TAB 3 â€“ BCF TOPIC (STEP 2)                                -->
            <!-- ========================================================= -->
            <div id="tab-bcf" class="tab-content">

                <section class="card">
                    <h2>BCF-Themen erstellen</h2>

                    <div class="form-group">
                        <label for="bcfTitle">Titel:</label>
                        <input type="text" id="bcfTitle" class="form-control" value="Raumbuch">
                    </div>

                    <div class="form-group">
                        <label for="bcfAssignees">Zuweisen an (E-Mail):</label>
                        <select id="bcfAssignees" class="form-control" multiple size="5">
                            <option value="">-- Klicken Sie auf "Projektdaten laden" --</option>
                        </select>
                        <small>Mehrfachauswahl: Strg/Cmd</small>
                    </div>

                    <div class="form-group">
                        <label for="bcfDescription">Beschreibung:</label>
                        <textarea id="bcfDescription" class="form-control" rows="3">
Das Raumprogramm wurde erstellt. Den Link zum Ordner fÃ¼r die weitere Arbeit finden Sie unter â€Verweiseâ€.
                </textarea>
                    </div>

                    <div class="form-group">
                        <label for="bcfPriority">PrioritÃ¤t:</label>
                        <select id="bcfPriority" class="form-control">
                            <option value="">-- Keine PrioritÃ¤t --</option>
                            <option value="Low">Niedrig</option>
                            <option value="Normal">Normal</option>
                            <option value="High">Hoch</option>
                            <option value="Critical">Kritisch</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="bcfDueDate">FÃ¤lligkeitsdatum:</label>
                        <input type="date" id="bcfDueDate" class="form-control">
                        <small>Wird automatisch auf heute gesetzt</small>
                    </div>

                    <button class="btn btn-primary" onclick="createBcfTopic()">ğŸ“‹ BCF-Themen erstellen</button>

                    <div id="step2Result" class="result"></div>

                </section>

            </div> <!-- END TAB 3 -->

        </main>



        <footer>
            <p>Raumbuch Manager v2.1 - Buildingpoint Schweiz AG</p>
            <p id="apiEndpoint" style="display: none;"></p>
        </footer>
    </div>

    <script>
        // Use relative URLs to work in both local development and Azure deployment
        const API_BASE = '/api/raumbuch';
        const API_PROJECT = '/api/project';

        // Display the current API endpoint in footer (hidden element for debugging)
        const apiEndpointEl = document.getElementById('apiEndpoint');
        if (apiEndpointEl) {
            apiEndpointEl.textContent = `API: ${window.location.origin}`;
        }

        // ====================================================================
        // TRIMBLE CONNECT WORKSPACE & EXTENSION API INTEGRATION
        // ====================================================================

        // Store authentication and context from Trimble Connect
        let trimbleConnect = {
            accessToken: null,
            projectId: null,
            userId: null,  // Current user ID for authorization
            isEmbedded: false,
            isWorkspaceApp: false, // New flag for Workspace API
            consentStatus: 'pending' // pending, granted, denied
        };

        /**
         * Get the current user ID for authorization
         * Returns the user ID from Trimble Connect context, or null if not available
         */
        function getCurrentUserId() {
            return trimbleConnect.userId || null;
        }

        // Helper functions to expose to app.js for Workspace API integration
        window.setWorkspaceToken = function (token) {
            console.log('Setting workspace token from app.js');
            trimbleConnect.accessToken = token;
            trimbleConnect.isWorkspaceApp = true;
            trimbleConnect.consentStatus = 'granted';

            // Try to auto-load configs if we also have project ID
            tryAutoLoadConfigs();
        };

        window.setWorkspaceUserId = function (userId) {
            console.log('Setting workspace user ID from app.js:', userId);
            trimbleConnect.userId = userId;
        };

        window.setWorkspaceProjectId = function (projectId) {
            console.log('Setting workspace project ID from app.js:', projectId);
            trimbleConnect.projectId = projectId;
            trimbleConnect.isWorkspaceApp = true;

            // Try to auto-load configs if we also have token
            tryAutoLoadConfigs();
        };

        // Auto-load saved configurations when both token and projectId are available
        async function tryAutoLoadConfigs() {
            const token = getToken();
            const projectId = getProjectId();

            if (token && projectId) {
                console.log('Auto-loading saved configurations for project:', projectId);
                try {
                    await loadSavedConfigurations(projectId);
                    showResult('connectionResult', 'success', 'âœ… Konfigurationen geladen. Klicken Sie "Projektdaten laden" fÃ¼r weitere Daten.');
                } catch (error) {
                    console.error('Error auto-loading configurations:', error);
                }
            }
        }

        // Check if running inside Trimble Connect as an extension
        function isInsideTrimbleConnect() {
            try {
                return window.parent !== window &&
                    window.parent.TrimbleConnectWorkspace !== undefined &&
                    window.parent.TrimbleConnectWorkspace !== null;
            } catch (e) {
                return false;
            }
        }

        // Initialize Trimble Connect Extension API
        function initializeTrimbleConnectExtension() {
            // Check if Workspace API is being initialized (app.js will handle authentication)
            // Check for both old WorkspaceAPI and new TrimbleConnectWorkspace
            if (window.WorkspaceAPI || window.TrimbleConnectWorkspace) {
                console.log('Workspace API detected - waiting for app.js to initialize');
                trimbleConnect.isEmbedded = true;
                trimbleConnect.isWorkspaceApp = true;
                // app.js will call setWorkspaceToken and setWorkspaceProjectId
                return;
            }

            trimbleConnect.isEmbedded = isInsideTrimbleConnect();

            if (trimbleConnect.isEmbedded) {
                console.log('Running inside Trimble Connect - initializing legacy extension API');

                try {
                    const workspace = window.parent.TrimbleConnectWorkspace;

                    // Request permission to use access token
                    workspace.extension.requestPermission()
                        .then(result => {
                            console.log('Extension permission result:', result);

                            if (result === 'granted') {
                                trimbleConnect.consentStatus = 'granted';
                                console.log('Permission granted - waiting for accessToken event');
                            } else if (result === 'denied') {
                                trimbleConnect.consentStatus = 'denied';
                                console.error('Permission denied by user');
                                showResult('connectionResult', 'error', 'âŒ Zugriff verweigert. Bitte erlauben Sie den Zugriff in den Extension-Einstellungen.');
                            } else if (result === 'pending') {
                                trimbleConnect.consentStatus = 'pending';
                                console.log('Permission pending - user needs to grant consent');
                            }
                        })
                        .catch(error => {
                            console.error('Error requesting permission:', error);
                            showResult('connectionResult', 'error', 'âŒ Fehler beim Anfordern der Berechtigung: ' + error.message);
                        });

                    // Listen for accessToken event (fired when token is available/refreshed)
                    workspace.extension.addEventListener('accessToken', (event) => {
                        console.log('Received accessToken event from Trimble Connect');

                        if (event && event.detail && event.detail.token) {
                            trimbleConnect.accessToken = event.detail.token;
                            trimbleConnect.consentStatus = 'granted';
                            console.log('Access token received and stored');

                            // Automatically load project data when token is received
                            if (trimbleConnect.projectId) {
                                console.log('Auto-loading project data with token and project ID');
                                loadProjectData().catch(error => {
                                    console.error('Error auto-loading project data:', error);
                                    showResult('connectionResult', 'error', 'âš  Fehler beim automatischen Laden der Projektdaten. Bitte versuchen Sie "Projektdaten laden".');
                                });
                            }
                        } else {
                            console.error('Invalid accessToken event - missing token');
                        }
                    });

                    // Get project context (project ID)
                    workspace.getContext()
                        .then(context => {
                            console.log('Trimble Connect context:', context);
                            if (context && context.project && context.project.id) {
                                trimbleConnect.projectId = context.project.id;
                                console.log('Project ID retrieved from context:', trimbleConnect.projectId);

                                // If we already have the token, auto-load project data
                                if (trimbleConnect.accessToken) {
                                    console.log('Auto-loading project data with both token and project ID');
                                    loadProjectData().catch(error => {
                                        console.error('Error auto-loading project data:', error);
                                        showResult('connectionResult', 'error', 'âš  Fehler beim automatischen Laden der Projektdaten. Bitte versuchen Sie "Projektdaten laden".');
                                    });
                                }
                            } else {
                                console.warn('No project context available from Trimble Connect');
                            }
                        })
                        .catch(error => {
                            console.error('Error getting Trimble Connect context:', error);
                            showResult('connectionResult', 'error', 'âš  Fehler beim Abrufen des Projekt-Kontexts von Trimble Connect.');
                        });

                } catch (error) {
                    console.error('Error initializing Trimble Connect Extension API:', error);
                    showResult('connectionResult', 'error', 'âŒ Fehler beim Initialisieren der Trimble Connect Extension API: ' + error.message);
                }
            } else {
                console.log('Not running inside Trimble Connect - standalone mode');
                // For local development/testing, fallback to manual input fields would be used
                // (currently commented out in HTML)
            }
        }

        // Initialize on page load - but after app.js has had a chance to load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTrimbleConnectExtension);
        } else {
            // DOM already loaded, wait a bit for app.js to initialize
            setTimeout(initializeTrimbleConnectExtension, 100);
        }

        function openTab(tabId) {
            // hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            // deactivate tabs
            document.querySelectorAll('.tc-tab').forEach(t => t.classList.remove('active'));

            // show selected tab
            document.getElementById(tabId).classList.add('active');

            // activate tab button
            const index = ['tab-raumprogramm', 'tab-ausgefuehrt', 'tab-analyse', 'tab-ausstattung', 'tab-bcf', 'tab-konfig'].indexOf(tabId);
            document.querySelectorAll('.tc-tab')[index].classList.add('active');

            // Auto-load data when Analyse tab is opened
            if (tabId === 'tab-analyse') {
                const raumbuchFileId = document.getElementById('raumbuchFile')?.value;
                if (raumbuchFileId && getToken()) {
                    loadAnalyseData();
                }
            }

            // Auto-load data when Raumprogramm tab is opened
            if (tabId === 'tab-raumprogramm') {
                refreshAllMasterData();
            }
        }

        // Global configuration object
        let currentConfig = {
            projectId: '',
            projectName: '',
            targetFolder: null,
            files: {
                template: null,
                raumprogramm: null,
                ifcModel: null,
                raumbuch: null
            },
            bcfAssignees: [],
            // New: Summary data for Analyse tab
            zusammenfassung: [],
            // Tolerance settings
            toleranceMin: -10,
            toleranceMax: 10,
            toleranceProfiles: [
                { name: 'Strenge Kontrolle (Â±5%)', min: -5, max: 5 },
                { name: 'Normal (Â±10%)', min: -10, max: 10 },
                { name: 'FrÃ¼he Projektphase (Â±20%)', min: -20, max: 20 }
            ]
        };

        function getToken() {
            // Use Trimble Connect token if available (from Workspace API or Extension API)
            if ((trimbleConnect.isEmbedded || trimbleConnect.isWorkspaceApp) && trimbleConnect.accessToken) {
                return trimbleConnect.accessToken;
            }

            // Fallback to manual input field (for local development)
            const tokenField = document.getElementById('accessToken');
            if (tokenField) {
                return tokenField.value.trim();
            }

            return '';
        }

        function getProjectId() {
            // Use Trimble Connect project ID if available (from Workspace API or Extension API)
            if ((trimbleConnect.isEmbedded || trimbleConnect.isWorkspaceApp) && trimbleConnect.projectId) {
                return trimbleConnect.projectId;
            }

            // Fallback to manual input field (for local development)
            const projectField = document.getElementById('projectId');
            if (projectField) {
                return projectField.value.trim();
            }

            return '';
        }

        function getTargetFolder() {
            const select = document.getElementById('targetFolder');
            const value = select.value;
            console.log('getTargetFolder() - selected value:', value);
            console.log('getTargetFolder() - selected index:', select.selectedIndex);
            console.log('getTargetFolder() - selected option:', select.options[select.selectedIndex]);
            return value;
        }

        function showResult(elementId, type, message) {
            const el = document.getElementById(elementId);
            el.className = `result ${type}`;
            el.innerHTML = message;
        }

        // ====================================================================
        //  CONFIGURATION MANAGEMENT
        // ====================================================================

        async function loadProjectData() {
            const token = getToken();
            const projectId = getProjectId();

            // Skip validation if we're waiting for credentials from Workspace/Extension API
            if (!token || !projectId) {
                // If we have neither token nor project ID, show a loading message instead of error
                // The app is likely still initializing via Workspace API
                if (trimbleConnect.isEmbedded || trimbleConnect.isWorkspaceApp) {
                    console.log('Waiting for Workspace API to provide token and project ID...');
                    showResult('connectionResult', 'loading', 'â³ Warte auf Authentifizierung...');
                } else {
                    showResult('connectionResult', 'error', 'âš  Bitte authentifizieren Sie sich Ã¼ber Trimble Connect');
                }
                return;
            }

            showResult('connectionResult', 'loading', 'â³ Projektdaten werden geladen...');

            try {
                // Load folders
                console.log('Loading folders...');
                const foldersResponse = await fetch(`${API_PROJECT}/folders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessToken: token, projectId: projectId })
                });

                const contentType = foldersResponse.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const textResponse = await foldersResponse.text();
                    console.error('Non-JSON response:', textResponse);
                    showResult('connectionResult', 'error', 'âŒ UngÃ¼ltige Antwort vom Server (kein JSON)');
                    return;
                }

                const foldersData = await foldersResponse.json();
                console.log('Folders response:', foldersData);

                if (foldersResponse.ok && foldersData.success) {
                    const select = document.getElementById('targetFolder');

                    if (!foldersData.folders || !Array.isArray(foldersData.folders)) {
                        showResult('connectionResult', 'error', 'âŒ Keine Ordner-Daten in Antwort');
                        return;
                    }

                    select.innerHTML = '<option value="">-- Ordner auswÃ¤hlen --</option>';

                    // Also populate inventory folder dropdown
                    const inventoryFolderSelect = document.getElementById('inventoryFolder');
                    if (inventoryFolderSelect) {
                        inventoryFolderSelect.innerHTML = '<option value="">-- Ordner auswÃ¤hlen --</option>';
                    }

                    if (foldersData.folders.length === 0) {
                        showResult('connectionResult', 'error', 'âš  Keine Ordner gefunden');
                        return;
                    }

                    foldersData.folders.forEach((folder) => {
                        const option = document.createElement('option');
                        option.value = folder.id || '';
                        option.textContent = folder.path || folder.name || 'Unnamed folder';
                        option.dataset.name = folder.name || '';
                        option.dataset.path = folder.path || '';
                        select.appendChild(option);

                        // Add to inventory folder dropdown
                        if (inventoryFolderSelect) {
                            const inventoryOption = document.createElement('option');
                            inventoryOption.value = folder.id || '';
                            inventoryOption.textContent = folder.path || folder.name || 'Unnamed folder';
                            inventoryOption.dataset.name = folder.name || '';
                            inventoryOption.dataset.path = folder.path || '';
                            inventoryFolderSelect.appendChild(inventoryOption);
                        }
                    });

                    console.log('Folders loaded:', foldersData.folders.length);
                } else {
                    const errorMsg = foldersData.message || foldersData.Message || 'Unbekannter Fehler';
                    showResult('connectionResult', 'error', `âŒ ${errorMsg}`);
                    return;
                }

                // Load users
                console.log('Loading users...');
                const usersResponse = await fetch(`${API_PROJECT}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessToken: token, projectId: projectId })
                });

                const usersData = await usersResponse.json();
                console.log('Users response:', usersData);

                if (usersResponse.ok && usersData.success) {
                    const select = document.getElementById('bcfAssignees');
                    select.innerHTML = '';

                    if (!usersData.users || !Array.isArray(usersData.users)) {
                        showResult('connectionResult', 'warning', `âœ… ${foldersData.folders.length} Ordner geladen, aber keine Benutzer gefunden`);
                        return;
                    }

                    usersData.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.email;
                        option.textContent = `${user.displayName} (${user.email})`;
                        option.dataset.id = user.id;
                        option.dataset.displayName = user.displayName;
                        select.appendChild(option);
                    });

                    console.log('Users loaded:', usersData.users.length);
                    showResult('connectionResult', 'success', `âœ… ${foldersData.folders.length} Ordner und ${usersData.users.length} Benutzer geladen!`);
                } else {
                    const errorMsg = usersData.message || usersData.Message || 'Unbekannter Fehler';
                    showResult('connectionResult', 'warning', `âœ… ${foldersData.folders.length} Ordner geladen, aber Fehler beim Laden der Benutzer: ${errorMsg}`);
                }

                // Load saved configurations from Azure
                await loadSavedConfigurations(projectId);
            } catch (error) {
                console.error('Error in loadProjectData:', error);
                showResult('connectionResult', 'error', 'âŒ Fehler bei der Authentifizierung mit Trimble Connect');
            }
        }

        async function loadSavedConfigurations(projectId) {
            try {
                console.log('Loading saved configurations for project:', projectId);
                const response = await fetch(`${API_PROJECT}/config/list`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectId: projectId })
                });

                if (!response.ok) {
                    console.warn('Failed to load configurations:', response.status);
                    return;
                }

                const data = await response.json();
                const configSelect = document.getElementById('savedConfigs');
                configSelect.innerHTML = '<option value="">-- Konfiguration auswÃ¤hlen --</option>';

                if (data.success && data.configurations && data.configurations.length > 0) {
                    data.configurations.forEach(config => {
                        const option = document.createElement('option');
                        option.value = config.name;
                        const dateStr = config.lastModified ? new Date(config.lastModified).toLocaleDateString('de-DE') : '';
                        option.textContent = `${config.name} ${dateStr ? '(' + dateStr + ')' : ''}`;
                        configSelect.appendChild(option);
                    });
                    console.log(`Loaded ${data.configurations.length} saved configurations`);
                } else {
                    configSelect.innerHTML = '<option value="">-- Keine gespeicherten Konfigurationen --</option>';
                }
            } catch (error) {
                console.error('Error loading saved configurations:', error);
            }
        }

        async function fetchFolders() {
            // This function is now replaced by loadProjectData()
            // Keeping it for backward compatibility if called from elsewhere
            await loadProjectData();
        }

        async function fetchUsers() {
            // This function is now replaced by loadProjectData()
            // Keeping it for backward compatibility if called from elsewhere
            await loadProjectData();
        }

        async function fetchFiles() {
            const token = getToken();
            const folderId = getTargetFolder();

            console.log('fetchFiles() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('Folder ID:', folderId);

            if (!token || !folderId) {
                if (!token) {
                    showResult('connectionResult', 'error', 'âš  Authentifizierung lÃ¤uft... Bitte warten Sie, bis Trimble Connect die Verbindung hergestellt hat.');
                } else {
                    showResult('connectionResult', 'error', 'âš  Bitte wÃ¤hlen Sie zuerst einen Zielordner aus');
                }
                console.error('Missing token or folderId');
                return;
            }

            showResult('connectionResult', 'loading', 'â³ Dateien werden geladen...');

            try {
                // Fetch Excel files for all dropdowns (template, raumprogramm, raumbuch)
                console.log('Fetching Excel files from folder:', folderId);
                const excelResponse = await fetch(`${API_PROJECT}/files`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        folderId: folderId,
                        fileExtensions: ['xlsx']
                    })
                });

                console.log('Excel response status:', excelResponse.status);
                const excelData = await excelResponse.json();
                console.log('Excel response data:', excelData);

                if (excelResponse.ok && excelData.success) {
                    // Populate template dropdown
                    const templateSelect = document.getElementById('templateFile');
                    templateSelect.innerHTML = '<option value="">-- Vorlage auswÃ¤hlen --</option>';

                    // Populate raumbuch dropdown
                    const raumbuchSelect = document.getElementById('raumbuchFile');
                    raumbuchSelect.innerHTML = '<option value="">-- Raumbuch auswÃ¤hlen --</option>';

                    console.log('Excel files found:', excelData.files?.length || 0);

                    if (excelData.files && excelData.files.length > 0) {
                        excelData.files.forEach(file => {
                            console.log('Adding Excel file:', file.name);

                            // Add to template dropdown
                            const templateOption = document.createElement('option');
                            templateOption.value = file.id;
                            templateOption.textContent = file.name;
                            templateOption.dataset.name = file.name;
                            templateOption.dataset.versionId = file.versionId;
                            templateSelect.appendChild(templateOption);

                            // Add to raumbuch dropdown (used by both Step 3 update and Step 4 pset operations)
                            const raumbuchOption = document.createElement('option');
                            raumbuchOption.value = file.id;
                            raumbuchOption.textContent = file.name;
                            raumbuchOption.dataset.name = file.name;
                            raumbuchOption.dataset.versionId = file.versionId;
                            raumbuchSelect.appendChild(raumbuchOption);
                        });
                    }
                } else {
                    console.error('Excel fetch failed:', excelData);
                }

                // Fetch IFC files for IFC dropdown
                console.log('Fetching IFC files from folder:', folderId);
                const ifcResponse = await fetch(`${API_PROJECT}/files`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        folderId: folderId,
                        fileExtensions: ['ifc']
                    })
                });

                console.log('IFC response status:', ifcResponse.status);
                const ifcData = await ifcResponse.json();
                console.log('IFC response data:', ifcData);

                if (ifcResponse.ok && ifcData.success) {
                    const ifcSelect = document.getElementById('ifcFile');

                    ifcSelect.innerHTML = '<option value="">-- IFC auswÃ¤hlen --</option>';

                    console.log('IFC files found:', ifcData.files?.length || 0);

                    if (ifcData.files && ifcData.files.length > 0) {
                        ifcData.files.forEach(file => {
                            console.log('Adding IFC file:', file.name);
                            const option = document.createElement('option');
                            option.value = file.id;
                            option.textContent = file.name;
                            option.dataset.name = file.name;
                            ifcSelect.appendChild(option);
                        });
                    }
                } else {
                    console.error('IFC fetch failed:', ifcData);
                }

                const excelCount = excelData.files?.length || 0;
                const ifcCount = ifcData.files?.length || 0;

                console.log('Total files:', excelCount, 'Excel,', ifcCount, 'IFC');
                showResult('connectionResult', 'success', `âœ… Dateien geladen! ${excelCount} Excel, ${ifcCount} IFC`);
            } catch (error) {
                console.error('Error in fetchFiles:', error);
                console.error('Error stack:', error.stack);
                showResult('connectionResult', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        async function fetchUsers() {
            const token = getToken();
            const projectId = getProjectId();

            if (!token || !projectId) {
                showResult('step2Result', 'error', 'âš  Bitte warten Sie auf die Authentifizierung Ã¼ber Trimble Connect');
                return;
            }

            showResult('step2Result', 'loading', 'â³ Benutzer werden geladen...');

            try {
                const response = await fetch(`${API_PROJECT}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessToken: token, projectId: projectId })
                });

                console.log('Response status:', response.status);
                const contentType = response.headers.get('content-type');
                console.log('Content-Type:', contentType);

                if (!contentType || !contentType.includes('application/json')) {
                    const textResponse = await response.text();
                    console.error('Non-JSON response:', textResponse);
                    showResult('step2Result', 'error', 'âŒ UngÃ¼ltige Antwort vom Server (kein JSON)');
                    return;
                }

                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok && (data.success || data.Success)) {
                    const select = document.getElementById('bcfAssignees');
                    select.innerHTML = '';

                    const users = data.users || data.Users;
                    if (!users || !Array.isArray(users)) {
                        showResult('step2Result', 'error', 'âš  Keine Benutzer-Daten in Antwort');
                        return;
                    }

                    console.log('Number of users:', users.length);

                    users.forEach(user => {
                        console.log('Adding user:', user.email, user.displayName);
                        const option = document.createElement('option');
                        option.value = user.email || user.Email;
                        option.textContent = `${user.displayName || user.DisplayName} (${user.email || user.Email})`;
                        option.dataset.id = user.id || user.Id;
                        option.dataset.displayName = user.displayName || user.DisplayName;
                        select.appendChild(option);
                    });

                    showResult('step2Result', 'success', `âœ… ${users.length} Benutzer geladen!`);
                } else {
                    console.error('Response not OK or success=false');
                    const errorMsg = data.message || data.Message || 'Unbekannter Fehler';
                    showResult('step2Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                console.error('Error in fetchUsers:', error);
                console.error('Error stack:', error.stack);
                showResult('step2Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        async function saveConfig() {
            const configName = document.getElementById('configName').value.trim();
            const projectId = getProjectId();

            if (!configName) {
                alert('âš  Bitte geben Sie einen Konfigurations-Namen ein!');
                return;
            }

            if (!projectId) {
                alert('âš  Warte auf Projekt-ID von Trimble Connect. Bitte versuchen Sie es in wenigen Sekunden erneut.');
                return;
            }

            // Build configuration object including all user choices
            const config = {
                projectId: projectId,
                projectName: configName,
                lastUpdated: new Date().toISOString(),
                targetFolder: getSelectedOption('targetFolder'),
                files: {
                    template: getSelectedOption('templateFile'),
                    ifcModel: getSelectedOption('ifcFile'),
                    raumbuch: getSelectedOption('raumbuchFile')
                },
                bcfAssignees: getSelectedUsers(),
                // Analyse tab settings
                zusammenfassung: currentConfig.zusammenfassung || [],
                toleranceMin: toleranceSettings.min,
                toleranceMax: toleranceSettings.max,
                toleranceProfiles: currentConfig.toleranceProfiles || [],
                // Ausstattung tab settings
                inventoryFolder: getSelectedOption('inventoryFolder'),
                psetPartialName: document.getElementById('psetPartialName')?.value || 'Plancal nova',
                roomPropertyName: document.getElementById('roomPropertyName')?.value || 'Room Nbr',
                selectedIfcFiles: getSelectedIfcFiles(),
                selectedProperties: getSelectedProperties()
            };

            try {
                showResult('connectionResult', 'info', 'ğŸ”„ Speichere Konfiguration...');

                // Try to save to Azure
                const response = await fetch(`${API_PROJECT}/config/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        configName: configName,
                        configuration: config
                    })
                });

                // Check if response is OK first
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error response:', response.status, errorText);
                    throw new Error(`Server error (${response.status}): ${errorText.substring(0, 200)}`);
                }

                const data = await response.json();
                console.log('Save config response:', data);

                if (data.success) {
                    if (data.savedToAzure) {
                        showResult('connectionResult', 'success', `âœ… ${data.message}`);
                        // Reload the configurations list
                        await loadSavedConfigurations(projectId);
                    } else {
                        // Azure not configured, download as file
                        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${configName}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                        showResult('connectionResult', 'success', `âœ… Konfiguration "${configName}.json" heruntergeladen (lokaler Modus)!`);
                    }
                } else {
                    throw new Error(data.message || 'Fehler beim Speichern (keine Fehlermeldung vom Server)');
                }
            } catch (error) {
                console.error('Error saving config:', error);
                showResult('connectionResult', 'error', `âŒ Fehler beim Speichern: ${error.message}`);
            }
        }

        async function loadConfigFromAzure() {
            const configName = document.getElementById('savedConfigs').value;
            const projectId = getProjectId();

            if (!configName) {
                alert('âš  Bitte wÃ¤hlen Sie eine Konfiguration aus!');
                return;
            }

            if (!projectId) {
                alert('âš  Project ID nicht gefunden!');
                return;
            }

            try {
                showResult('connectionResult', 'info', 'ğŸ”„ Lade Konfiguration...');

                const response = await fetch(`${API_PROJECT}/config/load`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId: projectId,
                        configName: configName
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.configuration) {
                    applyConfiguration(data.configuration);
                    showResult('connectionResult', 'success', `âœ… ${data.message}`);
                } else {
                    throw new Error(data.message || 'Fehler beim Laden');
                }
            } catch (error) {
                console.error('Error loading config from Azure:', error);
                showResult('connectionResult', 'error', `âŒ Fehler beim Laden: ${error.message}`);
            }
        }

        async function deleteConfigFromAzure() {
            const configName = document.getElementById('savedConfigs').value;
            const projectId = getProjectId();

            if (!configName) {
                alert('âš  Bitte wÃ¤hlen Sie eine Konfiguration aus!');
                return;
            }

            if (!projectId) {
                alert('âš  Project ID nicht gefunden!');
                return;
            }

            // Confirm deletion
            if (!confirm(`MÃ¶chten Sie die Konfiguration "${configName}" wirklich lÃ¶schen?`)) {
                return;
            }

            try {
                showResult('connectionResult', 'info', 'ğŸ”„ LÃ¶sche Konfiguration...');

                const response = await fetch(`${API_PROJECT}/config/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId: projectId,
                        configName: configName
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    showResult('connectionResult', 'success', `âœ… ${data.message}`);
                    // Reload the configurations list
                    await loadSavedConfigurations(projectId);
                } else {
                    throw new Error(data.message || 'Fehler beim LÃ¶schen');
                }
            } catch (error) {
                console.error('Error deleting config from Azure:', error);
                showResult('connectionResult', 'error', `âŒ Fehler beim LÃ¶schen: ${error.message}`);
            }
        }

        function applyConfiguration(config) {
            currentConfig = config;

            // Fill Project ID and Name (only if fields exist - they may be hidden in extension mode)
            const projectIdField = document.getElementById('projectId');
            if (projectIdField) {
                projectIdField.value = config.projectId || '';
            }
            document.getElementById('configName').value = config.projectName || '';

            // Fill Target Folder (display name in readonly field if not in dropdown yet)
            if (config.targetFolder) {
                const folderSelect = document.getElementById('targetFolder');
                // Try to find and select the folder
                let found = false;
                for (let i = 0; i < folderSelect.options.length; i++) {
                    if (folderSelect.options[i].value === config.targetFolder.id) {
                        folderSelect.selectedIndex = i;
                        found = true;
                        break;
                    }
                }
                // If not found, add temporary option
                if (!found) {
                    const option = document.createElement('option');
                    option.value = config.targetFolder.id;
                    option.textContent = config.targetFolder.path || config.targetFolder.name;
                    option.dataset.name = config.targetFolder.name;
                    option.dataset.path = config.targetFolder.path;
                    folderSelect.appendChild(option);
                    folderSelect.value = config.targetFolder.id;
                }
            }

            // Fill Template
            if (config.files?.template) {
                setSelectValue('templateFile', config.files.template.id, config.files.template.name);
            }

            // Fill IFC
            if (config.files?.ifcModel) {
                setSelectValue('ifcFile', config.files.ifcModel.id, config.files.ifcModel.name);
            }

            // Fill Raumbuch (changed from readonly to dropdown)
            if (config.files?.raumbuch) {
                setSelectValue('raumbuchFile', config.files.raumbuch.id, config.files.raumbuch.name);
            }

            // Fill BCF Assignees
            if (config.bcfAssignees && config.bcfAssignees.length > 0) {
                const select = document.getElementById('bcfAssignees');
                // Pre-select users if they exist in dropdown
                for (let i = 0; i < select.options.length; i++) {
                    const option = select.options[i];
                    const isSelected = config.bcfAssignees.some(u => u.email === option.value);
                    option.selected = isSelected;
                }
            }

            // Restore tolerance settings
            if (config.toleranceMin !== undefined) {
                toleranceSettings.min = config.toleranceMin;
                document.getElementById('toleranceMin').value = config.toleranceMin;
            }
            if (config.toleranceMax !== undefined) {
                toleranceSettings.max = config.toleranceMax;
                document.getElementById('toleranceMax').value = config.toleranceMax;
            }

            // Restore zusammenfassung data
            if (config.zusammenfassung && config.zusammenfassung.length > 0) {
                analyseData = config.zusammenfassung;
                currentConfig.zusammenfassung = config.zusammenfassung;
            }

            // Restore Ausstattung tab settings
            if (config.inventoryFolder) {
                setSelectValue('inventoryFolder', config.inventoryFolder.id, config.inventoryFolder.name);
            }
            if (config.psetPartialName) {
                document.getElementById('psetPartialName').value = config.psetPartialName;
            }
            if (config.roomPropertyName) {
                document.getElementById('roomPropertyName').value = config.roomPropertyName;
            }
        }

        function getSelectedOption(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return null;
            const option = select.options[select.selectedIndex];
            if (!option || !option.value) return null;

            return {
                id: option.value,
                name: option.dataset.name || option.textContent,
                path: option.dataset.path || ''
            };
        }

        function getSelectedUsers() {
            const select = document.getElementById('bcfAssignees');
            const users = [];
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].selected) {
                    users.push({
                        id: select.options[i].dataset.id || '',
                        email: select.options[i].value,
                        displayName: select.options[i].dataset.displayName || select.options[i].textContent
                    });
                }
            }
            return users;
        }

        function setSelectValue(selectId, value, name) {
            const select = document.getElementById(selectId);
            if (!select) {
                console.log(`Select element ${selectId} not found, skipping`);
                return;
            }
            let found = false;

            // Try to find existing option
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === value) {
                    select.selectedIndex = i;
                    found = true;
                    return;
                }
            }

            // If not found, add as option
            if (!found && value && name) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = name;
                option.dataset.name = name;
                select.appendChild(option);
                select.value = value;
            }
        }

        // ====================================================================
        //  POLLING HELPER FUNCTION
        // ====================================================================

        /**
         * Polls the folder for a newly created file by name.
         * Tries up to 5 times with 500ms intervals.
         * Returns the file ID if found, or null if not found.
         */
        async function pollForFile(fileName, maxAttempts = 5, delayMs = 500) {
            const token = getToken();
            const folderId = getTargetFolder();

            console.log(`Starting polling for file: ${fileName}`);

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                console.log(`Poll attempt ${attempt}/${maxAttempts}`);
                //
                // Wait before querying
                await new Promise(resolve => setTimeout(resolve, delayMs));

                try {
                    const response = await fetch(`${API_PROJECT}/files`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            accessToken: token,
                            folderId: folderId,
                            fileExtensions: ['xlsx']
                        })
                    });

                    if (!response.ok) {
                        console.warn(`Folder query failed with status ${response.status}`);
                        continue;
                    }

                    const data = await response.json();

                    if ((data.success || data.Success) && (data.files || data.Files)) {
                        // Find the file by name (case-insensitive)
                        const files = data.files || data.Files;
                        const foundFile = files.find(f =>
                            (f.name || f.Name).toLowerCase() === fileName.toLowerCase()
                        );

                        if (foundFile && (foundFile.id || foundFile.Id)) {
                            const fileId = foundFile.id || foundFile.Id;
                            const fileName = foundFile.name || foundFile.Name;
                            console.log(`Found file: ${fileName}, ID: ${fileId}`);
                            return foundFile;
                        }
                    }

                    console.log(`File '${fileName}' not found yet. Will retry...`);
                } catch (error) {
                    console.error(`Error during poll attempt ${attempt}:`, error);
                }
            }

            console.warn(`File '${fileName}' not found after ${maxAttempts} attempts.`);
            return null;
        }

        /**
         * Updates a dropdown with a new file option and selects it.
         */
        function updateDropdownWithFile(selectId, file) {
            const select = document.getElementById(selectId);
            if (!select) {
                console.log(`Dropdown ${selectId} not found, skipping update`);
                return;
            }

            // Check if file already exists in dropdown
            let optionExists = false;
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === file.id) {
                    select.selectedIndex = i;
                    optionExists = true;
                    break;
                }
            }

            // If not exists, add it
            if (!optionExists) {
                const option = document.createElement('option');
                option.value = file.id;
                option.textContent = file.name;
                option.dataset.name = file.name;
                select.appendChild(option);
                select.value = file.id;
            }

            console.log(`Updated dropdown ${selectId} with file: ${file.name}`);
        }

        // ====================================================================
        //  EXISTING FUNCTIONS (updated to use polling)
        // ====================================================================

        async function testConnection() {
            const token = getToken();
            const projectId = getProjectId();

            if (!token || !projectId) {
                showResult('connectionResult', 'error', 'âš  Bitte warten Sie auf die Authentifizierung Ã¼ber Trimble Connect');
                return;
            }

            showResult('connectionResult', 'loading', 'â³ Teste Verbindung...');

            try {
                const response = await fetch(`${API_BASE}/test-project`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessToken: token, projectId: projectId })
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('connectionResult', 'success', `âœ… Verbindung OK! Projekt: ${data.projectId || projectId}`);
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    showResult('connectionResult', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                showResult('connectionResult', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        async function importTemplate() {
            const token = getToken();
            const projectId = getProjectId();
            const templateFileId = document.getElementById('templateFile').value;
            const targetFolder = getTargetFolder();

            console.log('importTemplate() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('ProjectId:', projectId);
            console.log('Template File ID:', templateFileId);
            console.log('Target Folder:', targetFolder);

            if (!token || !templateFileId || !targetFolder || !projectId) {
                showResult('step1Result', 'error', 'âš  Bitte alle Felder ausfÃ¼llen');
                return;
            }

            showResult('step1Result', 'loading', 'â³ Importiere Vorlage...');

            try {
                const requestBody = {
                    accessToken: token,
                    projectId: projectId,
                    templateFileId: templateFileId,
                    targetFolderId: targetFolder
                };

                console.log('Sending request body:', requestBody);

                const response = await fetch(`${API_BASE}/import-template`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    const fileName = data.raumprogrammFileName || 'Raumprogramm.xlsx';
                    const fileId = data.raumprogrammFileId || 'N/A';

                    console.log('Raumprogramm created successfully:', fileName, fileId);

                    // Save to config
                    currentConfig.files.raumprogramm = {
                        id: fileId,
                        name: fileName
                    };

                    console.log('Updated currentConfig.files.raumprogramm:', currentConfig.files.raumprogramm);

                    showResult('step1Result', 'loading', `âœ… Raumprogramm erstellt!<br>â³ Warte auf ID von Connect...`);

                    // Poll for the file to get the actual Connect ID
                    const foundFile = await pollForFile(fileName);

                    if (foundFile) {
                        // Update config with correct ID
                        currentConfig.files.raumprogramm.id = foundFile.id;

                        // Update dropdown in Step 3
                        updateDropdownWithFile('raumprogrammFile', foundFile);

                        showResult('step1Result', 'success',
                            `âœ… Erfolgreich!<br>Datei: ${fileName}<br>ID: ${foundFile.id}<br>âœ… Raumprogramm wurde zur Dropdown-Liste hinzugefÃ¼gt!`);
                    } else {
                        // File not found after polling, use backend ID
                        showResult('step1Result', 'warning',
                            `âš ï¸ Raumprogramm wurde erstellt, aber ID konnte nicht sofort abgerufen werden.<br>Datei: ${fileName}<br>Bitte klicken Sie auf "Dateien laden" um die Liste zu aktualisieren.`);
                    }
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    console.error('Import template failed:', errorMsg);
                    showResult('step1Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                console.error('Error in importTemplate:', error);
                showResult('step1Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        async function createBcfTopic() {
            const token = getToken();
            const projectId = getProjectId();
            const folderId = getTargetFolder();
            const title = document.getElementById('bcfTitle').value.trim();
            const description = document.getElementById('bcfDescription').value.trim();
            const priority = document.getElementById('bcfPriority').value;
            const dueDate = document.getElementById('bcfDueDate').value;

            // Get selected users
            const selectedUsers = getSelectedUsers();
            if (selectedUsers.length === 0) {
                showResult('step2Result', 'error', 'âš  Bitte mindestens einen Benutzer auswÃ¤hlen');
                return;
            }

            const assignedTo = selectedUsers.map(u => u.email).join(',');

            if (!token || !projectId || !folderId) {
                showResult('step2Result', 'error', 'âš  Bitte Token, Project ID und Folder auswÃ¤hlen');
                return;
            }

            showResult('step2Result', 'loading', 'â³ Erstelle BCF Topic...');

            try {
                const response = await fetch(`${API_BASE}/create-bcf-topic`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        projectId: projectId,
                        folderId: folderId,
                        title: title,
                        description: description,
                        assignedTo: assignedTo,
                        createMultipleTopics: false,
                        priority: priority || null,
                        dueDate: dueDate || null
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    let resultHtml = `âœ… BCF Topic erfolgreich erstellt!<br>Topic GUID: ${data.topicGuid || 'N/A'}`;

                    if (data.documentReferenceGuid) {
                        resultHtml += `<br>Dokumentreferenz GUID: ${data.documentReferenceGuid}`;
                    }

                    resultHtml += `<br><br>âš ï¸ Bitte prÃ¼fen Sie die Benutzerzuweisungen und Berechtigungen in Trimble Connect.`;

                    showResult('step2Result', 'success', resultHtml);
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    showResult('step2Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                showResult('step2Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        async function importIfc() {
            const token = getToken();
            const projectId = getProjectId();
            const ifcFileId = document.getElementById('ifcFile').value;
            const raumprogrammFileSelect = document.getElementById('raumprogrammFile');
            const raumprogrammFileId = raumprogrammFileSelect.value;
            const targetFolder = getTargetFolder();

            console.log('importIfc() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('ProjectId:', projectId);
            console.log('IFC File ID:', ifcFileId);
            console.log('Raumprogramm File ID:', raumprogrammFileId);
            console.log('Target Folder:', targetFolder);

            if (!token || !projectId || !ifcFileId || !raumprogrammFileId || !targetFolder) {
                let missingFields = [];
                if (!token) missingFields.push('Token');
                if (!projectId) missingFields.push('Project ID');
                if (!ifcFileId) missingFields.push('IFC File');
                if (!raumprogrammFileId) missingFields.push('Raumprogramm File');
                if (!targetFolder) missingFields.push('Target Folder');

                showResult('step3Result', 'error', `âš  Bitte alle Felder ausfÃ¼llen. Fehlende Felder: ${missingFields.join(', ')}`);
                return;
            }

            showResult('step3Result', 'loading', 'â³ Importiere IFC und erstelle Raumbuch... (kann einige Sekunden dauern)');

            try {
                const requestBody = {
                    accessToken: token,
                    projectId: projectId,
                    ifcFileId: ifcFileId,
                    raumprogrammFileId: raumprogrammFileId,
                    targetFolderId: targetFolder
                };

                console.log('Sending request body:', requestBody);

                const response = await fetch(`${API_BASE}/import-ifc`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    const fileName = data.raumbuchFileName || 'Raumbuch.xlsx';
                    const fileId = data.raumbuchFileId || 'N/A';

                    console.log('Raumbuch created successfully:', fileName, fileId);

                    // Save to config
                    currentConfig.files.raumbuch = {
                        id: fileId,
                        name: fileName
                    };

                    let message = `âœ… Raumbuch erstellt!<br>Datei: ${fileName}<br>â³ Warte auf ID von Connect...<br><br><strong>Analyse:</strong><br>`;
                    if (data.analysis && data.analysis.length > 0) {
                        data.analysis.forEach(a => {
                            // Use new status logic: OK, Zu wenig, Zu viel
                            const status = a.status || (a.isUnderLimit ? 'âš ï¸ Zu wenig' : (a.isOverLimit ? 'ğŸ“Š Zu viel' : 'âœ… OK'));
                            message += `- ${a.roomCategory}: ${a.percentage.toFixed(1)}% ${status}<br>`;
                        });
                    }

                    showResult('step3Result', 'loading', message);

                    // Poll for the file to get the actual Connect ID
                    const foundFile = await pollForFile(fileName);

                    if (foundFile) {
                        // Update config with correct ID
                        currentConfig.files.raumbuch.id = foundFile.id;

                        // Update dropdown (used by both Step 3 update and Step 4 pset operations)
                        updateDropdownWithFile('raumbuchFile', foundFile);

                        message = `âœ… Raumbuch erfolgreich erstellt!<br>Datei: ${fileName}<br>ID: ${foundFile.id}<br>âœ… Raumbuch wurde zur Dropdown-Liste hinzugefÃ¼gt!`;
                        showResult('step3Result', 'success', message);
                    } else {
                        // File not found after polling, use backend ID
                        message = `âš ï¸ Raumbuch wurde erstellt, aber ID konnte nicht sofort abgerufen werden.<br>Datei: ${fileName}<br>Bitte klicken Sie auf "Dateien laden" um die Liste zu aktualisieren.<br><br><strong>Analyse:</strong><br>`;
                        if (data.analysis && data.analysis.length > 0) {
                            data.analysis.forEach(a => {
                                // Use new status logic: OK, Zu wenig, Zu viel
                                const status = a.status || (a.isUnderLimit ? 'âš ï¸ Zu wenig' : (a.isOverLimit ? 'ğŸ“Š Zu viel' : 'âœ… OK'));
                                message += `- ${a.roomCategory}: ${a.percentage.toFixed(1)}% ${status}<br>`;
                            });
                        }
                        showResult('step3Result', 'warning', message);
                    }
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    showResult('step3Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                console.error('Error in importIfc:', error);
                showResult('step3Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        async function updateRaumbuch() {
            const token = getToken();
            const projectId = getProjectId();
            const ifcFileId = document.getElementById('ifcFile').value;
            const templateFileId = document.getElementById('templateFile').value;
            const existingRaumbuchFileId = document.getElementById('raumbuchFile').value;
            const targetFolder = getTargetFolder();

            // Get column mappings
            const raumtypCol = document.getElementById('mappingRaumtyp').value;
            const raumkategorieCol = document.getElementById('mappingRaumkategorie').value;
            const flaecheSollCol = document.getElementById('mappingFlaecheSoll').value;

            console.log('updateRaumbuch() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('ProjectId:', projectId);
            console.log('IFC File ID:', ifcFileId);
            console.log('Template File ID:', templateFileId);
            console.log('Existing Raumbuch File ID:', existingRaumbuchFileId);
            console.log('Target Folder:', targetFolder);

            if (!token || !projectId || !ifcFileId || !templateFileId || !existingRaumbuchFileId || !targetFolder) {
                let missingFields = [];
                if (!token) missingFields.push('Token');
                if (!projectId) missingFields.push('Project ID');
                if (!ifcFileId) missingFields.push('IFC File');
                if (!templateFileId) missingFields.push('Vorlagendatei');
                if (!existingRaumbuchFileId) missingFields.push('Raumbuch File');
                if (!targetFolder) missingFields.push('Target Folder');

                showResult('step3Result', 'error', `âš  Bitte alle Felder ausfÃ¼llen. Fehlende Felder: ${missingFields.join(', ')}`);
                return;
            }

            if (!raumtypCol || !flaecheSollCol) {
                showResult('step3Result', 'error', 'âš  Bitte laden Sie die Vorlage und wÃ¤hlen Sie mindestens Raumtyp und FlÃ¤che Soll Spalten aus');
                return;
            }

            showResult('step3Result', 'loading', 'â³ Aktualisiere Raumbuch... (kann einige Sekunden dauern)');

            try {
                const requestBody = {
                    accessToken: token,
                    projectId: projectId,
                    raumbuchFileId: existingRaumbuchFileId,
                    templateFileId: templateFileId,
                    ifcFileId: ifcFileId,
                    targetFolderId: targetFolder,
                    columnMappings: {
                        raumtypColumn: parseInt(raumtypCol),
                        raumkategorieColumn: raumkategorieCol ? parseInt(raumkategorieCol) : -1,
                        flaecheSollColumn: parseInt(flaecheSollCol)
                    }
                };

                console.log('Sending request body:', requestBody);

                const response = await fetch(`${API_BASE}/update-raumbuch-with-mappings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    const fileName = data.raumbuchFileName || 'Raumbuch.xlsx';
                    const fileId = data.raumbuchFileId || 'N/A';

                    console.log('Raumbuch updated successfully:', fileName, fileId);

                    // Save to config
                    currentConfig.files.raumbuch = {
                        id: fileId,
                        name: fileName
                    };

                    let message = `âœ… Raumbuch aktualisiert!<br>Datei: ${fileName}<br>`;
                    message += `RÃ¤ume hinzugefÃ¼gt: ${data.RoomsAdded || 0}<br>`;
                    message += `RÃ¤ume aktualisiert: ${data.RoomsUpdated || 0}<br>`;
                    message += `RÃ¤ume unverÃ¤ndert: ${data.RoomsUnchanged || 0}`;

                    showResult('step3Result', 'success', message);
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    showResult('step3Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                console.error('Error in updateRaumbuch:', error);
                showResult('step3Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        async function writePset() {
            const token = getToken();
            const ifcFileId = document.getElementById('ifcFile').value; // Read from Step 3
            const raumbuchFileId = document.getElementById('raumbuchFile').value; // Read from Step 3
            const targetFolder = getTargetFolder();

            if (!token || !ifcFileId || !raumbuchFileId || !targetFolder) {
                showResult('step4Result', 'error', 'âš  Bitte alle Felder ausfÃ¼llen (IFC und Raumbuch aus Schritt 3 erforderlich)');
                return;
            }

            showResult('step4Result', 'loading', 'â³ Schreibe Pset "Raumbuch" in IFC... (kann einige Sekunden dauern)');

            try {
                const response = await fetch(`${API_BASE}/write-raumbuch-pset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        ifcFileId: ifcFileId,
                        raumbuchFileId: raumbuchFileId,
                        targetFolderId: targetFolder
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    let message = `âœ… ${data.Message || data.message || 'Pset erfolgreich geschrieben!'}<br>`;
                    message += `RÃ¤ume aktualisiert: ${data.RoomsUpdated || data.roomsUpdated || 0}<br>`;
                    message += `RÃ¤ume Ã¼bersprungen: ${data.RoomsSkipped || data.roomsSkipped || 0}`;

                    if (data.Warnings && data.Warnings.length > 0) {
                        message += '<br><br><strong>Warnungen:</strong><br>';
                        data.Warnings.forEach(w => {
                            message += `- ${w}<br>`;
                        });
                    }

                    showResult('step4Result', 'success', message);
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    showResult('step4Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                showResult('step4Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        async function updatePset() {
            const token = getToken();
            const ifcFileId = document.getElementById('ifcFile').value; // Read from Step 3
            const raumbuchFileId = document.getElementById('raumbuchFile').value; // Read from Step 3
            const targetFolder = getTargetFolder();

            if (!token || !ifcFileId || !raumbuchFileId || !targetFolder) {
                showResult('step4Result', 'error', 'âš  Bitte alle Felder ausfÃ¼llen (IFC und Raumbuch aus Schritt 3 erforderlich)');
                return;
            }

            showResult('step4Result', 'loading', 'â³ Aktualisiere Pset "Raumbuch" in IFC...');

            try {
                const response = await fetch(`${API_BASE}/update-raumbuch-pset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        ifcFileId: ifcFileId,
                        raumbuchFileId: raumbuchFileId,
                        targetFolderId: targetFolder
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    let message = `âœ… ${data.Message || data.message || 'Pset erfolgreich aktualisiert!'}<br>`;
                    message += `RÃ¤ume aktualisiert: ${data.RoomsUpdated || data.roomsUpdated || 0}<br>`;
                    message += `RÃ¤ume Ã¼bersprungen: ${data.RoomsSkipped || data.roomsSkipped || 0}`;

                    showResult('step4Result', 'success', message);
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    showResult('step4Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                showResult('step4Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        async function deletePset() {
            const token = getToken();
            const ifcFileId = document.getElementById('ifcFile').value; // Read from Step 3
            const targetFolder = getTargetFolder();

            if (!token || !ifcFileId || !targetFolder) {
                showResult('step4Result', 'error', 'âš  Bitte IFC File aus Schritt 3 auswÃ¤hlen');
                return;
            }

            if (!confirm('Sind Sie sicher, dass Sie das Pset "Raumbuch" aus der IFC-Datei lÃ¶schen mÃ¶chten?')) {
                return;
            }

            showResult('step4Result', 'loading', 'â³ LÃ¶sche Pset "Raumbuch" aus IFC...');

            try {
                const response = await fetch(`${API_BASE}/delete-raumbuch-pset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        ifcFileId: ifcFileId,
                        targetFolderId: targetFolder
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    let message = `âœ… ${data.Message || data.message || 'Pset erfolgreich gelÃ¶scht!'}<br>`;
                    message += `Psets entfernt: ${data.PsetsRemoved || data.psetsRemoved || 0}`;

                    showResult('step4Result', 'success', message);
                } else {
                    const errorMsg = data.message || data.exceptionMessage || data.Message || `HTTP ${response.status}`;
                    showResult('step4Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                showResult('step4Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        /**
         * Opens the IFC file in 3D Viewer using Trimble Connect
         */
        async function openIn3DViewer() {
            const ifcFileId = document.getElementById('ifcFile').value;
            const projectId = getProjectId();

            if (!ifcFileId) {
                showResult('step4Result', 'error', 'âš  Bitte IFC-Datei in Einstellungen auswÃ¤hlen');
                return;
            }

            if (!projectId) {
                showResult('step4Result', 'error', 'âš  Projekt-ID nicht verfÃ¼gbar');
                return;
            }

            try {
                // Build the Trimble Connect 3D Viewer URL
                // Format: https://web.connect.trimble.com/projects/{projectId}/viewer/3d/?modelId={fileId}
                const viewerUrl = `https://web.connect.trimble.com/projects/${projectId}/viewer/3d/?modelId=${ifcFileId}`;

                console.log('Opening 3D Viewer:', viewerUrl);

                // Open in new tab
                window.open(viewerUrl, '_blank');

                showResult('step4Result', 'success', 'âœ… 3D-Viewer wird in neuem Tab geÃ¶ffnet...');
            } catch (error) {
                console.error('Error opening 3D Viewer:', error);
                showResult('step4Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        async function createRoomSheets() {
            const token = getToken();
            const raumbuchFileId = document.getElementById('raumbuchFile').value;
            const targetFolder = getTargetFolder();

            console.log('createRoomSheets() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('Raumbuch File ID:', raumbuchFileId);
            console.log('Target Folder:', targetFolder);

            if (!token || !raumbuchFileId || !targetFolder) {
                showResult('step5_1Result', 'error', 'âš  Bitte Token, Raumbuch-Datei und Zielordner auswÃ¤hlen');
                return;
            }

            showResult('step5_1Result', 'loading', 'â³ Erstelle Raumlisten...');

            try {
                const requestBody = {
                    accessToken: token,
                    raumbuchFileId: raumbuchFileId,
                    targetFolderId: targetFolder
                };

                console.log('Sending request body:', requestBody);

                const response = await fetch(`${API_BASE}/create-room-sheets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok && (data.success || data.Success)) {
                    let message = `âœ… ${data.message || data.Message}<br>`;
                    message += `Raumlisten erstellt: ${data.roomSheetsCreated || data.RoomSheetsCreated || 0}`;

                    showResult('step5_1Result', 'success', message);
                } else {
                    const errorMsg = data.message || data.Message || data.exceptionMessage || `HTTP ${response.status}`;
                    showResult('step5_1Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                showResult('step5_1Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        async function loadIfcFilesForInventory() {
            const token = getToken();
            const inventoryFolderId = document.getElementById('inventoryFolder').value;

            console.log('loadIfcFilesForInventory() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('Inventory Folder ID:', inventoryFolderId);

            if (!token || !inventoryFolderId) {
                showResult('step5_2Result', 'error', 'âš  Bitte Token und IFC-Ordner auswÃ¤hlen');
                return;
            }

            showResult('step5_2Result', 'loading', 'â³ IFC-Dateien werden geladen...');

            try {
                const response = await fetch(`${API_PROJECT}/files`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        folderId: inventoryFolderId,
                        fileExtensions: ['ifc']
                    })
                });

                console.log('IFC files response status:', response.status);
                const data = await response.json();
                console.log('IFC files response data:', data);

                if (response.ok && (data.success || data.Success)) {
                    const ifcFilesList = document.getElementById('ifcFilesList');

                    const files = data.files || data.Files;
                    if (files && files.length > 0) {
                        // Create checkboxes for each IFC file
                        let html = '';
                        files.forEach(file => {
                            const fileId = file.id || file.Id;
                            const fileName = file.name || file.Name;
                            html += `
                                        <label class="file-checkbox-label">
                                            <input type="checkbox" id="ifc_${fileId}" value="${fileId}" class="ifc-file-checkbox file-checkbox">
                                            <span>${fileName}</span>
                                        </label>
                                    `;
                        });
                        ifcFilesList.innerHTML = html;
                        showResult('step5_2Result', 'success', `âœ… ${files.length} IFC-Datei(en) gefunden`);
                    } else {
                        ifcFilesList.innerHTML = '<p style="color: #666;">Keine IFC-Dateien gefunden</p>';
                        showResult('step5_2Result', 'warning', 'âš  Keine IFC-Dateien im ausgewÃ¤hlten Ordner gefunden');
                    }
                } else {
                    const errorMsg = data.message || data.Message || `HTTP ${response.status}`;
                    showResult('step5_2Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                showResult('step5_2Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        async function discoverProperties() {
            const token = getToken();
            const psetPartialName = document.getElementById('psetPartialName').value;

            // Get selected IFC file IDs
            const selectedCheckboxes = document.querySelectorAll('.ifc-file-checkbox:checked');
            const ifcFileIds = Array.from(selectedCheckboxes).map(cb => cb.value);

            console.log('discoverProperties() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('IFC File IDs:', ifcFileIds);
            console.log('Pset Partial Name:', psetPartialName);

            if (!token || ifcFileIds.length === 0) {
                showResult('step5_2Result', 'error', 'âš  Bitte Token und mindestens eine IFC-Datei auswÃ¤hlen');
                return;
            }

            if (!psetPartialName) {
                showResult('step5_2Result', 'error', 'âš  Bitte Pset-Name angeben');
                return;
            }

            showResult('step5_2Result', 'loading', 'â³ Eigenschaften werden geladen...');

            try {
                const requestBody = {
                    accessToken: token,
                    ifcFileIds: ifcFileIds,
                    psetPartialName: psetPartialName
                };

                console.log('Sending request body:', requestBody);

                const response = await fetch(`${API_BASE}/discover-properties`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok && (data.success || data.Success)) {
                    const select = document.getElementById('additionalProperties');
                    select.innerHTML = '';

                    const properties = data.properties || data.Properties;
                    if (properties && properties.length > 0) {
                        properties.forEach(prop => {
                            const option = document.createElement('option');
                            option.value = prop.propertyName || prop.PropertyName;
                            option.textContent = `${prop.propertyName || prop.PropertyName} (${prop.psetName || prop.PsetName})`;
                            select.appendChild(option);
                        });
                        showResult('step5_2Result', 'success', `âœ… ${properties.length} Eigenschaft(en) gefunden`);
                    } else {
                        select.innerHTML = '<option value="">-- Keine Eigenschaften gefunden --</option>';
                        showResult('step5_2Result', 'warning', 'âš  Keine Eigenschaften gefunden');
                    }
                } else {
                    const errorMsg = data.message || data.Message || `HTTP ${response.status}`;
                    showResult('step5_2Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                console.error('Error in discoverProperties:', error);
                showResult('step5_2Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        async function fillInventory() {
            const token = getToken();
            const raumbuchFileId = document.getElementById('raumbuchFile').value;
            const targetFolder = getTargetFolder();
            const psetPartialName = document.getElementById('psetPartialName').value;
            const roomPropertyName = document.getElementById('roomPropertyName').value;

            // Get selected IFC file IDs
            const selectedCheckboxes = document.querySelectorAll('.ifc-file-checkbox:checked');
            const ifcFileIds = Array.from(selectedCheckboxes).map(cb => cb.value);

            // Get selected additional properties
            const additionalPropertiesSelect = document.getElementById('additionalProperties');
            const additionalProperties = Array.from(additionalPropertiesSelect.selectedOptions).map(opt => opt.value).filter(v => v);

            console.log('fillInventory() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('Raumbuch File ID:', raumbuchFileId);
            console.log('IFC File IDs:', ifcFileIds);
            console.log('Pset Partial Name:', psetPartialName);
            console.log('Additional Properties:', additionalProperties);
            console.log('Room Property Name:', roomPropertyName);

            if (!token || !raumbuchFileId || !targetFolder || ifcFileIds.length === 0) {
                showResult('step5_2Result', 'error', 'âš  Bitte Token, Raumbuch-Datei, Zielordner und mindestens eine IFC-Datei auswÃ¤hlen');
                return;
            }

            if (!psetPartialName || !roomPropertyName) {
                showResult('step5_2Result', 'error', 'âš  Bitte Pset-Name und Raumnummer-Eigenschaft angeben');
                return;
            }

            showResult('step5_2Result', 'loading', 'â³ Inventar wird erstellt...');

            try {
                const requestBody = {
                    accessToken: token,
                    raumbuchFileId: raumbuchFileId,
                    ifcFileIds: ifcFileIds,
                    psetPartialName: psetPartialName,
                    roomPropertyName: roomPropertyName,
                    targetFolderId: targetFolder,
                    additionalProperties: additionalProperties.length > 0 ? additionalProperties : null
                };

                console.log('Sending request body:', requestBody);

                const response = await fetch(`${API_BASE}/fill-inventory`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok && (data.success || data.Success)) {
                    let message = `âœ… ${data.message || data.Message}<br>`;
                    message += `RÃ¤ume aktualisiert: ${data.roomsUpdated || data.RoomsUpdated || 0}<br>`;
                    message += `Objekte hinzugefÃ¼gt: ${data.totalItems || data.TotalItems || 0}`;

                    const warnings = data.warnings || data.Warnings;
                    if (warnings && warnings.length > 0) {
                        message += '<br><br><strong>Warnungen:</strong><br>';
                        warnings.forEach(w => {
                            message += `âš  ${w}<br>`;
                        });
                    }

                    showResult('step5_2Result', 'success', message);
                } else {
                    const errorMsg = data.message || data.Message || data.exceptionMessage || `HTTP ${response.status}`;
                    showResult('step5_2Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                showResult('step5_2Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        async function deleteRoomLists() {
            const token = getToken();
            const raumbuchFileId = document.getElementById('raumbuchFile').value;
            const targetFolder = getTargetFolder();

            console.log('deleteRoomLists() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('Raumbuch File ID:', raumbuchFileId);
            console.log('Target Folder:', targetFolder);

            if (!token || !raumbuchFileId || !targetFolder) {
                showResult('step5_1Result', 'error', 'âš  Bitte Token, Raumbuch-Datei und Zielordner auswÃ¤hlen');
                return;
            }

            showResult('step5_1Result', 'loading', 'â³ LÃ¶sche Raumlisten...');

            try {
                const requestBody = {
                    accessToken: token,
                    raumbuchFileId: raumbuchFileId,
                    targetFolderId: targetFolder
                };

                console.log('Sending request body:', requestBody);

                const response = await fetch(`${API_BASE}/delete-room-lists`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok && (data.success || data.Success)) {
                    let message = `âœ… ${data.message || data.Message}<br>`;
                    message += `${data.sheetsDeleted || data.SheetsDeleted || 0} RaumblÃ¤tter gelÃ¶scht<br>`;
                    message += `${data.hyperlinksRemoved || data.HyperlinksRemoved || 0} Hyperlinks entfernt`;

                    showResult('step5_1Result', 'success', message);
                } else {
                    const errorMsg = data.message || data.Message || data.exceptionMessage || `HTTP ${response.status}`;
                    showResult('step5_1Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                showResult('step5_1Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        async function updateInventory() {
            const token = getToken();
            const raumbuchFileId = document.getElementById('raumbuchFile').value;
            const targetFolder = getTargetFolder();
            const psetPartialName = document.getElementById('psetPartialName').value;
            const roomPropertyName = document.getElementById('roomPropertyName').value;

            // Get selected IFC file IDs
            const selectedCheckboxes = document.querySelectorAll('.ifc-file-checkbox:checked');
            const ifcFileIds = Array.from(selectedCheckboxes).map(cb => cb.value);

            // Get selected additional properties
            const additionalPropertiesSelect = document.getElementById('additionalProperties');
            const additionalProperties = Array.from(additionalPropertiesSelect.selectedOptions).map(opt => opt.value).filter(v => v);

            console.log('updateInventory() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('Raumbuch File ID:', raumbuchFileId);
            console.log('IFC File IDs:', ifcFileIds);
            console.log('Pset Partial Name:', psetPartialName);
            console.log('Room Property Name:', roomPropertyName);
            console.log('Additional Properties:', additionalProperties);

            if (!token || !raumbuchFileId || !targetFolder || ifcFileIds.length === 0) {
                showResult('step5_2Result', 'error', 'âš  Bitte Token, Raumbuch-Datei, Zielordner und mindestens eine IFC-Datei auswÃ¤hlen');
                return;
            }

            if (!psetPartialName || !roomPropertyName) {
                showResult('step5_2Result', 'error', 'âš  Bitte Pset-Name und Raumnummer-Eigenschaft angeben');
                return;
            }

            showResult('step5_2Result', 'loading', 'â³ Inventar wird aktualisiert...');

            try {
                const requestBody = {
                    accessToken: token,
                    raumbuchFileId: raumbuchFileId,
                    ifcFileIds: ifcFileIds,
                    psetPartialName: psetPartialName,
                    roomPropertyName: roomPropertyName,
                    targetFolderId: targetFolder,
                    additionalProperties: additionalProperties.length > 0 ? additionalProperties : null
                };

                console.log('Sending request body:', requestBody);

                const response = await fetch(`${API_BASE}/update-inventory`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok && (data.success || data.Success)) {
                    let message = `âœ… ${data.message || data.Message}<br>`;
                    message += `RÃ¤ume aktualisiert: ${data.roomsUpdated || data.RoomsUpdated || 0}<br>`;
                    message += `Objekte gelÃ¶scht: ${data.itemsDeleted || data.ItemsDeleted || 0}<br>`;
                    message += `Objekte hinzugefÃ¼gt: ${data.itemsAdded || data.ItemsAdded || 0}`;

                    const warnings = data.warnings || data.Warnings;
                    if (warnings && warnings.length > 0) {
                        message += '<br><br><strong>Warnungen:</strong><br>';
                        warnings.forEach(w => {
                            message += `âš  ${w}<br>`;
                        });
                    }

                    showResult('step5_2Result', 'success', message);
                } else {
                    const errorMsg = data.message || data.Message || data.exceptionMessage || `HTTP ${response.status}`;
                    showResult('step5_2Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                showResult('step5_2Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        // ====================================================================
        //  ANALYSE TAB FUNCTIONS
        // ====================================================================

        // Store current tolerance settings
        let toleranceSettings = {
            min: -10,
            max: 10
        };

        // Store current analyse data
        let analyseData = [];

        /**
         * Loads analyse data from Zusammenfassung (from loaded config or API)
         */
        async function loadAnalyseData() {
            showResult('analyseResult', 'loading', 'â³ Lade Analysedaten...');

            try {
                const token = getToken();
                const raumbuchFileId = document.getElementById('raumbuchFile')?.value;

                if (!token || !raumbuchFileId) {
                    showResult('analyseResult', 'error', 'âš ï¸ Bitte zuerst ein Raumbuch auswÃ¤hlen');
                    return;
                }

                // Load data from the Raumbuch Excel file (Zusammenfassung sheet)
                const response = await fetch(`${API_BASE}/get-zusammenfassung`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        raumbuchFileId: raumbuchFileId
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.zusammenfassung) {
                        analyseData = data.zusammenfassung;
                        currentConfig.zusammenfassung = data.zusammenfassung;
                        renderAnalyseTable(data.zusammenfassung);
                        updateKPIWidget(data.zusammenfassung);
                        showResult('analyseResult', 'success', `âœ… ${data.zusammenfassung.length} Kategorien geladen`);
                    } else {
                        showResult('analyseResult', 'warning', 'âš ï¸ Keine Zusammenfassung gefunden');
                    }
                } else {
                    // Try to use cached data from config
                    if (currentConfig.zusammenfassung && currentConfig.zusammenfassung.length > 0) {
                        analyseData = currentConfig.zusammenfassung;
                        renderAnalyseTable(currentConfig.zusammenfassung);
                        updateKPIWidget(currentConfig.zusammenfassung);
                        showResult('analyseResult', 'success', `âœ… ${currentConfig.zusammenfassung.length} Kategorien aus Konfiguration geladen`);
                    } else {
                        showResult('analyseResult', 'error', 'âŒ Fehler beim Laden der Daten');
                    }
                }
            } catch (error) {
                console.error('Error loading analyse data:', error);
                showResult('analyseResult', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        /**
         * Renders the analyse table with the given data
         */
        function renderAnalyseTable(data) {
            const tbody = document.getElementById('analyseTableBody');
            if (!tbody) return;

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#666;">Keine Daten vorhanden.</td></tr>';
                return;
            }

            let html = '';
            data.forEach((item, index) => {
                const percentage = getItemProp(item, 'percentage', 'Percentage', 0);
                const sollArea = getItemProp(item, 'sollArea', 'SollArea', 0);
                const istArea = getItemProp(item, 'istArea', 'IstArea', 0);
                const raumtyp = getItemProp(item, 'raumtyp', 'Raumtyp', null) ||
                    getItemProp(item, 'roomCategory', 'RoomCategory', '-');
                const raumkategorie = getItemProp(item, 'raumkategorie', 'Raumkategorie', '');
                const comment = getItemProp(item, 'comment', 'Comment', '');

                // Determine status based on tolerance settings
                const status = getStatus(percentage, sollArea, istArea);
                const statusClass = getStatusClass(status);
                // Color logic: Red for Unterschritten, Green for ErfÃ¼llt, Yellow for Ãœberschritten
                let rowClass = '';
                if (status === 'Unterschritten' || sollArea === 0) {
                    rowClass = 'analyse-row-under';
                } else if (status === 'ErfÃ¼llt') {
                    rowClass = 'analyse-row-ok';
                } else if (status === 'Ãœberschritten') {
                    rowClass = 'analyse-row-over';
                }

                // Create visual bar
                const barHtml = createProgressBar(percentage);

                html += `
                        <tr class="analyse-row ${rowClass}" data-status="${status.toLowerCase()}" data-index="${index}">
                            <td>${escapeHtml(raumtyp)}</td>
                            <td><input type="text" class="kategorie-input form-control" value="${escapeHtml(raumkategorie)}" data-index="${index}" data-field="raumkategorie" style="width:100px; padding:4px;" onchange="onAnalyseFieldChange(${index})"></td>
                            <td><input type="number" class="soll-input form-control" value="${sollArea.toFixed(2)}" data-index="${index}" data-field="sollArea" step="0.01" style="width:80px; padding:4px;" onchange="onSollChange(${index})"></td>
                            <td>${istArea.toFixed(2)}</td>
                            <td>${barHtml}</td>
                            <td><span class="status-badge ${statusClass}" data-index="${index}">${status}</span></td>
                            <td><input type="text" class="comment-input" value="${escapeHtml(comment)}" data-index="${index}" data-field="comment" placeholder="Kommentar..." onchange="onAnalyseFieldChange(${index})"></td>
                        </tr>
                    `;
            });

            tbody.innerHTML = html;
        }

        /**
         * Determines the status based on percentage and tolerance settings
         * Status values: ErfÃ¼llt (within tolerance), Unterschritten (IST < SOLL), Ãœberschritten (IST > SOLL)
         */
        function getStatus(percentage, sollArea, istArea) {
            // Handle null/undefined/NaN cases
            if (percentage == null || isNaN(percentage)) return 'ErfÃ¼llt';

            // SOLL=0 is considered Unterschritten (red)
            if (sollArea === 0) return 'Unterschritten';

            // Both zero = ErfÃ¼llt
            if (sollArea <= 0 && istArea <= 0) return 'ErfÃ¼llt';

            const deviation = percentage - 100;

            // IST < SOLL = Unterschritten (red)
            if (deviation < toleranceSettings.min) {
                return 'Unterschritten';
                // IST > SOLL = Ãœberschritten (no color in Excel, yellow in UI)
            } else if (deviation > toleranceSettings.max) {
                return 'Ãœberschritten';
            }
            // Within tolerance = ErfÃ¼llt (green)
            return 'ErfÃ¼llt';
        }

        /**
         * Gets the CSS class for status badge
         */
        function getStatusClass(status) {
            switch (status) {
                case 'Unterschritten': return 'status-under';
                case 'Ãœberschritten': return 'status-over';
                default: return 'status-ok';
            }
        }

        // Constants for progress bar visualization
        const PROGRESS_BAR_MAX_PERCENT = 150;
        const DEVIATION_INTENSITY_DIVISOR = 30;

        /**
         * Creates a visual progress bar for SOLL/IST comparison
         */
        function createProgressBar(percentage) {
            // Handle null/undefined/NaN cases
            if (percentage == null || isNaN(percentage)) percentage = 0;

            const width = Math.min(Math.max(percentage, 0), PROGRESS_BAR_MAX_PERCENT);
            const barWidth = (width / PROGRESS_BAR_MAX_PERCENT) * 100;
            const markerPos = (100 / PROGRESS_BAR_MAX_PERCENT) * 100; // 100% marker position

            let barColor = '#2E8540'; // Green for OK
            if (percentage < 100 - Math.abs(toleranceSettings.min)) {
                barColor = '#D64545'; // Red for under
            } else if (percentage > 100 + toleranceSettings.max) {
                barColor = '#FFBF47'; // Yellow for over
            }

            // Color intensity based on deviation
            const deviation = Math.abs(percentage - 100);
            const intensity = Math.min(deviation / DEVIATION_INTENSITY_DIVISOR, 1);

            return `
                    <div class="progress-bar-container">
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" style="width:${barWidth}%; background-color:${barColor}; opacity:${0.4 + intensity * 0.6};"></div>
                            <div class="progress-bar-marker" style="left:${markerPos}%;"></div>
                        </div>
                        <span class="progress-bar-label">${percentage.toFixed(0)}%</span>
                    </div>
                `;
        }

        /**
         * Updates the KPI widget with summary data
         */
        function updateKPIWidget(data) {
            if (!data || data.length === 0) return;

            let totalSoll = 0;
            let totalIst = 0;
            let okCount = 0;
            let underCount = 0;
            let overCount = 0;

            data.forEach(item => {
                const soll = getItemProp(item, 'sollArea', 'SollArea', 0);
                const ist = getItemProp(item, 'istArea', 'IstArea', 0);
                const percentage = getItemProp(item, 'percentage', 'Percentage', 0);

                totalSoll += soll;
                totalIst += ist;

                const status = getStatus(percentage, soll, ist);
                if (status === 'ErfÃ¼llt') okCount++;
                else if (status === 'Unterschritten') underCount++;
                else if (status === 'Ãœberschritten') overCount++;
            });

            const deviation = totalSoll > 0 ? ((totalIst / totalSoll) * 100 - 100).toFixed(1) : 0;

            document.getElementById('kpiSollTotal').textContent = totalSoll.toFixed(2) + ' mÂ²';
            document.getElementById('kpiIstTotal').textContent = totalIst.toFixed(2) + ' mÂ²';
            document.getElementById('kpiDeviation').textContent = (deviation >= 0 ? '+' : '') + deviation + '%';
            document.getElementById('kpiOkCount').textContent = okCount;
            document.getElementById('kpiUnderCount').textContent = underCount;
            document.getElementById('kpiOverCount').textContent = overCount;

            // Color the deviation based on value
            const deviationEl = document.getElementById('kpiDeviation');
            if (deviation < toleranceSettings.min) {
                deviationEl.style.color = '#D64545';
            } else if (deviation > toleranceSettings.max) {
                deviationEl.style.color = '#FFBF47';
            } else {
                deviationEl.style.color = '#2E8540';
            }
        }

        /**
         * Applies tolerance settings and re-renders the table
         */
        async function applyToleranceSettings() {
            toleranceSettings.min = parseFloat(document.getElementById('toleranceMin').value) || -10;
            toleranceSettings.max = parseFloat(document.getElementById('toleranceMax').value) || 10;

            // Save tolerance settings to config
            currentConfig.toleranceMin = toleranceSettings.min;
            currentConfig.toleranceMax = toleranceSettings.max;

            if (analyseData.length > 0) {
                renderAnalyseTable(analyseData);
                updateKPIWidget(analyseData);
                showResult('analyseResult', 'success', 'âœ… Toleranz-Einstellungen angewendet');
            }

            // Auto-save config if configName is set
            await autoSaveConfig();
        }

        /**
         * Filters the analyse table by status
         */
        function filterAnalyseTable(filter) {
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.filter-btn[data-filter="${filter}"]`)?.classList.add('active');

            // Filter rows
            const rows = document.querySelectorAll('.analyse-row');
            rows.forEach(row => {
                const status = row.dataset.status;
                if (filter === 'all') {
                    row.style.display = '';
                } else if (filter === 'ok' && status === 'erfÃ¼llt') {
                    row.style.display = '';
                } else if (filter === 'under' && status === 'unterschritten') {
                    row.style.display = '';
                } else if (filter === 'over' && status === 'Ã¼berschritten') {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        /**
         * Searches the analyse table
         */
        function searchAnalyseTable() {
            const searchTerm = document.getElementById('analyseSearch').value.toLowerCase();
            const rows = document.querySelectorAll('.analyse-row');

            rows.forEach(row => {
                const category = (row.cells && row.cells[0] && row.cells[0].textContent) ? row.cells[0].textContent.toLowerCase() : '';
                if (category.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        /**
         * Sorts the analyse table by column
         */
        let sortDirection = {};
        function sortAnalyseTable(columnIndex) {
            const table = document.getElementById('analyseTable');
            const tbody = document.getElementById('analyseTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr.analyse-row'));

            if (rows.length === 0) return;

            // Toggle sort direction
            sortDirection[columnIndex] = !sortDirection[columnIndex];
            const ascending = sortDirection[columnIndex];

            rows.sort((a, b) => {
                let aVal = (a.cells && a.cells[columnIndex] && a.cells[columnIndex].textContent) ? a.cells[columnIndex].textContent : '';
                let bVal = (b.cells && b.cells[columnIndex] && b.cells[columnIndex].textContent) ? b.cells[columnIndex].textContent : '';

                // Try to parse as numbers
                const aNum = parseFloat(aVal.replace(/[^0-9.-]/g, ''));
                const bNum = parseFloat(bVal.replace(/[^0-9.-]/g, ''));

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return ascending ? aNum - bNum : bNum - aNum;
                }

                return ascending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            });

            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

        /**
         * Saves analyse changes (comments, Raumkategorie, SOLL) to JSON config and Excel
         * Updates both Raumbuch sheet (all rooms by category) and Zusammenfassung sheet
         */
        async function saveAnalyseChanges() {
            showResult('analyseResult', 'loading', 'â³ Speichere Ã„nderungen...');

            try {
                // Collect all editable field values from inputs
                analyseData.forEach((item, index) => {
                    const kategorieInput = document.querySelector(`.kategorie-input[data-index="${index}"]`);
                    const sollInput = document.querySelector(`.soll-input[data-index="${index}"]`);
                    const commentInput = document.querySelector(`.comment-input[data-index="${index}"]`);

                    if (kategorieInput) {
                        item.raumkategorie = kategorieInput.value;
                        item.Raumkategorie = kategorieInput.value;
                    }
                    if (sollInput) {
                        item.sollArea = parseFloat(sollInput.value) || 0;
                        item.SollArea = item.sollArea;
                        // Recalculate percentage
                        const istArea = item.istArea || item.IstArea || 0;
                        item.percentage = item.sollArea > 0 ? (istArea / item.sollArea) * 100 : 0;
                        item.Percentage = item.percentage;
                    }
                    if (commentInput) {
                        item.comment = commentInput.value;
                        item.Comment = commentInput.value;
                    }

                    // Calculate status for saving
                    const status = getStatus(item.percentage, item.sollArea, item.istArea || item.IstArea);
                    item.status = status;
                    item.Status = status;
                });

                // Update config
                currentConfig.zusammenfassung = analyseData;

                // Save config to Azure
                const configName = document.getElementById('configName').value.trim();
                if (!configName) {
                    showResult('analyseResult', 'error', 'âš ï¸ Bitte geben Sie einen Konfigurationsnamen ein');
                    return;
                }

                // Update the Excel file with all changes (Raumbuch + Zusammenfassung sheets)
                const token = getToken();
                const raumbuchFileId = document.getElementById('raumbuchFile')?.value;
                const targetFolderId = document.getElementById('targetFolder')?.value;

                let excelUpdateSuccess = false;
                if (token && raumbuchFileId && targetFolderId) {
                    try {
                        const updateResponse = await fetch(`${API_BASE}/update-zusammenfassung`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                accessToken: token,
                                raumbuchFileId: raumbuchFileId,
                                targetFolderId: targetFolderId,
                                zusammenfassung: analyseData,
                                toleranceMin: toleranceSettings.min,
                                toleranceMax: toleranceSettings.max
                            })
                        });

                        if (updateResponse.ok) {
                            const updateData = await updateResponse.json();
                            if (updateData.success) {
                                excelUpdateSuccess = true;
                                console.log('Excel updated successfully');
                            }
                        }
                    } catch (excelError) {
                        console.error('Error updating Excel:', excelError);
                        // Continue with JSON save even if Excel update fails
                    }
                }

                // Build full configuration and save to JSON
                await saveConfig();

                if (excelUpdateSuccess) {
                    showResult('analyseResult', 'success', 'âœ… Ã„nderungen in Excel und Konfiguration gespeichert');
                } else {
                    showResult('analyseResult', 'success', 'âœ… Ã„nderungen in Konfiguration gespeichert (Excel-Update nicht mÃ¶glich)');
                }
            } catch (error) {
                console.error('Error saving analyse changes:', error);
                showResult('analyseResult', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        /**
         * Auto-save configuration silently when certain actions are performed
         */
        async function autoSaveConfig() {
            const configName = document.getElementById('configName').value.trim();
            const projectId = getProjectId();

            if (!configName || !projectId) {
                console.log('Auto-save skipped: no config name or project ID');
                return;
            }

            try {
                // Build full configuration including all user choices
                const config = {
                    projectId: projectId,
                    projectName: configName,
                    lastUpdated: new Date().toISOString(),
                    targetFolder: getSelectedOption('targetFolder'),
                    files: {
                        template: getSelectedOption('templateFile'),
                        ifcModel: getSelectedOption('ifcFile'),
                        raumbuch: getSelectedOption('raumbuchFile')
                    },
                    bcfAssignees: getSelectedUsers(),
                    zusammenfassung: currentConfig.zusammenfassung || [],
                    toleranceMin: toleranceSettings.min,
                    toleranceMax: toleranceSettings.max,
                    toleranceProfiles: currentConfig.toleranceProfiles || [],
                    inventoryFolder: getSelectedOption('inventoryFolder'),
                    psetPartialName: document.getElementById('psetPartialName')?.value || 'Plancal nova',
                    roomPropertyName: document.getElementById('roomPropertyName')?.value || 'Room Nbr',
                    selectedIfcFiles: getSelectedIfcFiles(),
                    selectedProperties: getSelectedProperties()
                };

                // Update currentConfig
                Object.assign(currentConfig, config);

                const response = await fetch(`${API_PROJECT}/config/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        configName: configName,
                        configuration: config
                    })
                });

                if (response.ok) {
                    console.log('Config auto-saved successfully');
                }
            } catch (error) {
                console.error('Auto-save error:', error);
            }
        }

        /**
         * Gets selected IFC files from checkbox list
         */
        function getSelectedIfcFiles() {
            const checkboxes = document.querySelectorAll('#ifcFilesList input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => ({
                id: cb.value,
                name: cb.dataset.name || ''
            }));
        }

        /**
         * Gets selected properties from multi-select
         */
        function getSelectedProperties() {
            const select = document.getElementById('additionalProperties');
            if (!select) return [];
            return Array.from(select.selectedOptions).map(opt => opt.value);
        }

        /**
         * Escapes HTML to prevent XSS
         */
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Helper function to get property from item with both camelCase and PascalCase fallback
         * @param {object} item - The data item
         * @param {string} camelCase - Property name in camelCase (e.g., 'sollArea')
         * @param {string} pascalCase - Property name in PascalCase (e.g., 'SollArea')
         * @param {*} defaultValue - Default value if property not found
         */
        function getItemProp(item, camelCase, pascalCase, defaultValue) {
            if (!item) return defaultValue;
            return item[camelCase] ?? item[pascalCase] ?? defaultValue;
        }

        // Store column mappings
        let columnMappings = {
            raumtyp: '',
            raumkategorie: '',
            flaecheSoll: ''
        };

        // Store template headers
        let templateHeaders = [];

        /**
         * Loads template headers for column mapping
         */
        async function loadTemplateHeaders() {
            const token = getToken();
            const templateFileId = document.getElementById('templateFile').value;

            if (!token || !templateFileId) {
                showResult('step1Result', 'error', 'âš  Bitte Vorlagendatei auswÃ¤hlen');
                return;
            }

            showResult('step1Result', 'loading', 'â³ Lade SpaltenÃ¼berschriften...');

            try {
                const response = await fetch(`${API_BASE}/get-template-headers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        templateFileId: templateFileId
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    templateHeaders = data.headers || [];

                    // Populate mapping dropdowns
                    const mappingSelects = ['mappingRaumtyp', 'mappingRaumkategorie', 'mappingFlaecheSoll'];
                    mappingSelects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        if (select) {
                            select.innerHTML = '<option value="">-- Spalte wÃ¤hlen --</option>';
                            templateHeaders.forEach((header, index) => {
                                const option = document.createElement('option');
                                option.value = index.toString();
                                option.textContent = `${getColumnLetter(index)}: ${header}`;
                                select.appendChild(option);
                            });
                        }
                    });

                    // Set default mappings if columns exist - with validation
                    // Default: A=Raumtyp, F=Raumkategorie, G=FlÃ¤che Soll
                    if (templateHeaders.length >= 1) {
                        document.getElementById('mappingRaumtyp').value = '0'; // Column A
                    }
                    if (templateHeaders.length >= 6) {
                        document.getElementById('mappingRaumkategorie').value = '5'; // Column F
                    } else {
                        // Leave Raumkategorie unmapped if not enough columns - will use IFC LongName
                        console.log('Template has fewer than 6 columns - Raumkategorie will be derived from IFC');
                    }
                    if (templateHeaders.length >= 7) {
                        document.getElementById('mappingFlaecheSoll').value = '6'; // Column G
                    } else if (templateHeaders.length >= 4) {
                        // Fallback: try column D for FlÃ¤che Soll (older format)
                        document.getElementById('mappingFlaecheSoll').value = '3'; // Column D
                        console.log('Template has fewer than 7 columns - using column D for FlÃ¤che Soll');
                    }

                    // Show mapping table
                    document.getElementById('mappingTableContainer').style.display = 'block';

                    // Show helpful message with validation info
                    let message = `âœ… ${templateHeaders.length} Spalten geladen.`;
                    if (templateHeaders.length < 7) {
                        message += ` Hinweis: Weniger als 7 Spalten gefunden - bitte Zuordnung prÃ¼fen.`;
                    } else {
                        message += ` Bitte Zuordnung prÃ¼fen.`;
                    }
                    showResult('step1Result', 'success', message);
                } else {
                    const errorMsg = data.message || 'Fehler beim Laden';
                    showResult('step1Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                console.error('Error loading template headers:', error);
                showResult('step1Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        /**
         * Converts column index to Excel letter (0 = A, 1 = B, etc.)
         */
        function getColumnLetter(index) {
            let letter = '';
            while (index >= 0) {
                letter = String.fromCharCode((index % 26) + 65) + letter;
                index = Math.floor(index / 26) - 1;
            }
            return letter;
        }

        /**
         * Creates Raumbuch directly from template file using column mappings
         */
        async function createRaumbuch() {
            const token = getToken();
            const projectId = getProjectId();
            const templateFileId = document.getElementById('templateFile').value;
            const ifcFileId = document.getElementById('ifcFile').value;
            const targetFolder = getTargetFolder();

            // Get column mappings
            const raumtypCol = document.getElementById('mappingRaumtyp').value;
            const raumkategorieCol = document.getElementById('mappingRaumkategorie').value;
            const flaecheSollCol = document.getElementById('mappingFlaecheSoll').value;

            console.log('createRaumbuch() called');
            console.log('Token length:', token ? token.length : 0);
            console.log('Template File ID:', templateFileId);
            console.log('IFC File ID:', ifcFileId);
            console.log('Column mappings:', { raumtypCol, raumkategorieCol, flaecheSollCol });

            if (!token || !projectId || !templateFileId || !ifcFileId || !targetFolder) {
                let missingFields = [];
                if (!token) missingFields.push('Token');
                if (!projectId) missingFields.push('Project ID');
                if (!templateFileId) missingFields.push('Vorlagendatei');
                if (!ifcFileId) missingFields.push('IFC Datei');
                if (!targetFolder) missingFields.push('Zielordner');
                showResult('step3Result', 'error', `âš  Bitte alle Felder ausfÃ¼llen. Fehlende Felder: ${missingFields.join(', ')}`);
                return;
            }

            if (!raumtypCol || !flaecheSollCol) {
                showResult('step3Result', 'error', 'âš  Bitte laden Sie die Vorlage und wÃ¤hlen Sie mindestens Raumtyp und FlÃ¤che Soll Spalten aus');
                return;
            }

            showResult('step3Result', 'loading', 'â³ Erstelle Raumbuch... (kann einige Sekunden dauern)');

            try {
                const requestBody = {
                    accessToken: token,
                    projectId: projectId,
                    templateFileId: templateFileId,
                    ifcFileId: ifcFileId,
                    targetFolderId: targetFolder,
                    columnMappings: {
                        raumtypColumn: parseInt(raumtypCol),
                        raumkategorieColumn: raumkategorieCol ? parseInt(raumkategorieCol) : -1,
                        flaecheSollColumn: parseInt(flaecheSollCol)
                    }
                };

                console.log('Sending request body:', requestBody);

                const response = await fetch(`${API_BASE}/create-raumbuch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    const fileName = data.raumbuchFileName || 'Raumbuch.xlsx';
                    const fileId = data.raumbuchFileId || 'N/A';

                    console.log('Raumbuch created successfully:', fileName, fileId);

                    // Save to config
                    currentConfig.files.raumbuch = {
                        id: fileId,
                        name: fileName
                    };

                    let message = `âœ… Raumbuch erstellt!<br>Datei: ${fileName}<br>â³ Warte auf ID von Connect...`;
                    if (data.analysis && data.analysis.length > 0) {
                        message += '<br><br><strong>Analyse:</strong><br>';
                        data.analysis.forEach(a => {
                            const status = a.status || (a.percentage < 90 ? 'âš ï¸ Zu wenig' : (a.percentage > 110 ? 'ğŸ“Š Zu viel' : 'âœ… OK'));
                            message += `- ${a.raumtyp || a.roomCategory}: ${a.percentage.toFixed(1)}% ${status}<br>`;
                        });
                    }

                    showResult('step3Result', 'loading', message);

                    // Poll for the file to get the actual Connect ID
                    const foundFile = await pollForFile(fileName);

                    if (foundFile) {
                        // Update config with correct ID
                        currentConfig.files.raumbuch.id = foundFile.id;

                        // Update dropdown
                        updateDropdownWithFile('raumbuchFile', foundFile);

                        message = `âœ… Raumbuch erfolgreich erstellt!<br>Datei: ${fileName}<br>ID: ${foundFile.id}<br>âœ… Raumbuch wurde zur Dropdown-Liste hinzugefÃ¼gt!`;
                        showResult('step3Result', 'success', message);
                    } else {
                        showResult('step3Result', 'warning', `âš ï¸ Raumbuch wurde erstellt, aber ID konnte nicht abgerufen werden. Bitte "Dateien laden" klicken.`);
                    }
                } else {
                    const errorMsg = data.message || data.exceptionMessage || `HTTP ${response.status}`;
                    showResult('step3Result', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                console.error('Error in createRaumbuch:', error);
                showResult('step3Result', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        /**
         * Handles changes to SOLL values - recalculates percentage and status
         */
        function onSollChange(index) {
            const input = document.querySelector(`.soll-input[data-index="${index}"]`);
            if (!input || !analyseData[index]) return;

            const newSoll = parseFloat(input.value) || 0;
            const istArea = analyseData[index].istArea || analyseData[index].IstArea || 0;

            // Update the data
            analyseData[index].sollArea = newSoll;
            analyseData[index].SollArea = newSoll;

            // Recalculate percentage
            const newPercentage = newSoll > 0 ? (istArea / newSoll) * 100 : 0;
            analyseData[index].percentage = newPercentage;
            analyseData[index].Percentage = newPercentage;

            // Update the row
            updateAnalyseRow(index);
        }

        /**
         * Handles changes to other fields (Raumkategorie, Comment)
         */
        function onAnalyseFieldChange(index) {
            if (!analyseData[index]) return;

            // Update Raumkategorie
            const kategorieInput = document.querySelector(`.kategorie-input[data-index="${index}"]`);
            if (kategorieInput) {
                analyseData[index].raumkategorie = kategorieInput.value;
                analyseData[index].Raumkategorie = kategorieInput.value;
            }

            // Update Comment
            const commentInput = document.querySelector(`.comment-input[data-index="${index}"]`);
            if (commentInput) {
                analyseData[index].comment = commentInput.value;
                analyseData[index].Comment = commentInput.value;
            }
        }

        /**
         * Updates a single row in the analyse table
         */
        function updateAnalyseRow(index) {
            const row = document.querySelector(`.analyse-row[data-index="${index}"]`);
            if (!row || !analyseData[index]) return;

            const item = analyseData[index];
            const percentage = item.percentage || item.Percentage || 0;
            const sollArea = item.sollArea || item.SollArea || 0;
            const istArea = item.istArea || item.IstArea || 0;

            // Determine status
            const status = getStatus(percentage, sollArea, istArea);
            const statusClass = getStatusClass(status);

            // Color logic: Red for Unterschritten, Green for ErfÃ¼llt, Yellow for Ãœberschritten
            let rowClass = '';
            if (status === 'Unterschritten' || sollArea === 0) {
                rowClass = 'analyse-row-under';
            } else if (status === 'ErfÃ¼llt') {
                rowClass = 'analyse-row-ok';
            } else if (status === 'Ãœberschritten') {
                rowClass = 'analyse-row-over';
            }

            // Update row class
            row.className = `analyse-row ${rowClass}`;
            row.dataset.status = status.toLowerCase();

            // Update status badge
            const statusBadge = row.querySelector('.status-badge');
            if (statusBadge) {
                statusBadge.className = `status-badge ${statusClass}`;
                statusBadge.textContent = status;
            }

            // Update progress bar (column index 4)
            const cells = row.cells;
            if (cells && cells.length > 4) {
                cells[4].innerHTML = createProgressBar(percentage);
            }

            // Update KPI widget
            updateKPIWidget(analyseData);
        }

        /**
         * Recalculates status for all rows
         */
        function recalculateStatus() {
            if (!analyseData || analyseData.length === 0) {
                showResult('analyseResult', 'warning', 'âš ï¸ Keine Daten zum Aktualisieren');
                return;
            }

            // Collect current values from inputs
            analyseData.forEach((item, index) => {
                const sollInput = document.querySelector(`.soll-input[data-index="${index}"]`);
                const kategorieInput = document.querySelector(`.kategorie-input[data-index="${index}"]`);
                const commentInput = document.querySelector(`.comment-input[data-index="${index}"]`);

                if (sollInput) {
                    item.sollArea = parseFloat(sollInput.value) || 0;
                    item.SollArea = item.sollArea;
                }
                if (kategorieInput) {
                    item.raumkategorie = kategorieInput.value;
                    item.Raumkategorie = kategorieInput.value;
                }
                if (commentInput) {
                    item.comment = commentInput.value;
                    item.Comment = commentInput.value;
                }

                // Recalculate percentage
                const istArea = item.istArea || item.IstArea || 0;
                item.percentage = item.sollArea > 0 ? (istArea / item.sollArea) * 100 : 0;
                item.Percentage = item.percentage;
            });

            // Re-render the table
            renderAnalyseTable(analyseData);
            updateKPIWidget(analyseData);

            showResult('analyseResult', 'success', 'âœ… Status aktualisiert');
        }

        /**
         * Updates IST values from IFC file
         */
        async function updateIstValues() {
            const token = getToken();
            const ifcFileId = document.getElementById('ifcFile').value;

            if (!token || !ifcFileId) {
                showResult('analyseResult', 'error', 'âš ï¸ Bitte IFC-Datei in Einstellungen auswÃ¤hlen');
                return;
            }

            if (!analyseData || analyseData.length === 0) {
                showResult('analyseResult', 'error', 'âš ï¸ Bitte zuerst Daten laden');
                return;
            }

            showResult('analyseResult', 'loading', 'â³ Aktualisiere IST-Werte aus IFC...');

            try {
                const response = await fetch(`${API_BASE}/get-ist-from-ifc`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        ifcFileId: ifcFileId
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Update IST values in analyseData based on Raumkategorie
                    const istByCategory = data.istByCategory || {};
                    let updatedCount = 0;

                    analyseData.forEach(item => {
                        const kategorie = item.raumkategorie || item.Raumkategorie || item.raumtyp || item.Raumtyp || item.roomCategory || item.RoomCategory;
                        if (kategorie && istByCategory[kategorie] !== undefined) {
                            item.istArea = istByCategory[kategorie];
                            item.IstArea = istByCategory[kategorie];

                            // Recalculate percentage
                            const sollArea = item.sollArea || item.SollArea || 0;
                            item.percentage = sollArea > 0 ? (item.istArea / sollArea) * 100 : 0;
                            item.Percentage = item.percentage;
                            updatedCount++;
                        }
                    });

                    // Re-render table
                    renderAnalyseTable(analyseData);
                    updateKPIWidget(analyseData);

                    showResult('analyseResult', 'success', `âœ… ${updatedCount} IST-Werte aktualisiert`);
                } else {
                    const errorMsg = data.message || 'Fehler beim Laden';
                    showResult('analyseResult', 'error', `âŒ ${errorMsg}`);
                }
            } catch (error) {
                console.error('Error updating IST values:', error);
                showResult('analyseResult', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        // ====================================================================
        //  RAUMPROGRAMM TAB FUNCTIONS (SQL Database)
        // ====================================================================

        const API_RAUMPROGRAM = '/api';
        let currentRaumprogramPage = 1;
        const raumprogramPageSize = 50;

        /**
         * Refresh all master data (room types and inventory templates)
         */
        async function refreshAllMasterData() {
            await Promise.all([
                loadRoomTypes(),
                loadInventoryTemplates()
            ]);
        }

        /**
         * Load room types from database
         */
        async function loadRoomTypes() {
            try {
                const response = await fetch(`${API_RAUMPROGRAM}/roomtype`);
                const data = await response.json();

                if (response.ok && data.success) {
                    const select = document.getElementById('existingRoomTypes');
                    const filterSelect = document.getElementById('raumprogram-filter-roomtype');
                    const istFilterSelect = document.getElementById('ist-filter-roomtype');
                    const roomSelect = document.getElementById('roomRoomType');

                    select.innerHTML = '';
                    filterSelect.innerHTML = '<option value="">-- Alle --</option>';
                    if (istFilterSelect) istFilterSelect.innerHTML = '<option value="">-- Alle --</option>';
                    roomSelect.innerHTML = '<option value="">-- Raumtyp auswÃ¤hlen --</option>';

                    (data.roomTypes || []).forEach(rt => {
                        const option = document.createElement('option');
                        option.value = rt.roomTypeID;
                        // Display name with category if available
                        option.textContent = rt.roomCategory ? `${rt.name} (${rt.roomCategory})` : rt.name;
                        select.appendChild(option);

                        const filterOption = document.createElement('option');
                        filterOption.value = rt.roomTypeID;
                        filterOption.textContent = rt.name;
                        filterSelect.appendChild(filterOption);

                        if (istFilterSelect) {
                            istFilterSelect.appendChild(filterOption.cloneNode(true));
                        }

                        const roomOption = document.createElement('option');
                        roomOption.value = rt.roomTypeID;
                        roomOption.textContent = rt.name;
                        roomSelect.appendChild(roomOption);
                    });

                    console.log(`Loaded ${data.roomTypes?.length || 0} room types`);
                }
            } catch (error) {
                console.error('Error loading room types:', error);
            }
        }

        /**
         * Load inventory templates from database
         */
        async function loadInventoryTemplates() {
            try {
                const response = await fetch(`${API_RAUMPROGRAM}/inventorytemplate`);
                const data = await response.json();

                if (response.ok && data.success) {
                    const select = document.getElementById('existingInventoryTemplates');
                    const filterSelect = document.getElementById('raumprogram-filter-inventory');
                    const istFilterSelect = document.getElementById('ist-filter-inventory');

                    select.innerHTML = '';
                    filterSelect.innerHTML = '<option value="">-- Alle --</option>';
                    if (istFilterSelect) istFilterSelect.innerHTML = '<option value="">-- Alle --</option>';

                    // Store inventory templates globally for dynamic table columns
                    window.inventoryTemplates = data.inventoryTemplates || [];

                    (data.inventoryTemplates || []).forEach(it => {
                        const option = document.createElement('option');
                        option.value = it.inventoryTemplateID;
                        // Show DataType and Unit in the display
                        let displayText = it.propertyName;
                        if (it.dataType && it.dataType !== 'Text') {
                            displayText += ` [${it.dataType}]`;
                        }
                        if (it.unit) {
                            displayText += ` (${it.unit})`;
                        }
                        option.textContent = displayText;
                        select.appendChild(option);

                        const filterOption = document.createElement('option');
                        filterOption.value = it.inventoryTemplateID;
                        filterOption.textContent = it.propertyName;
                        filterSelect.appendChild(filterOption);

                        if (istFilterSelect) {
                            istFilterSelect.appendChild(filterOption.cloneNode(true));
                        }
                    });

                    console.log(`Loaded ${data.inventoryTemplates?.length || 0} inventory templates`);
                }
            } catch (error) {
                console.error('Error loading inventory templates:', error);
            }
        }

        /**
         * Create a new room type
         */
        async function createRoomType() {
            const name = document.getElementById('newRoomTypeName').value.trim();
            const roomCategory = document.getElementById('newRoomTypeCategory')?.value?.trim() || '';

            if (!name) {
                showResult('masterDataResult', 'error', 'âš ï¸ Bitte geben Sie einen Namen ein');
                return;
            }

            showResult('masterDataResult', 'loading', 'â³ Erstelle Raumtyp...');

            try {
                const response = await fetch(`${API_RAUMPROGRAM}/roomtype`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        roomCategory: roomCategory,
                        userId: getCurrentUserId()
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showResult('masterDataResult', 'success', `âœ… ${data.message}`);
                    document.getElementById('newRoomTypeName').value = '';
                    document.getElementById('newRoomTypeCategory').value = '';
                    await loadRoomTypes();
                } else {
                    showResult('masterDataResult', 'error', `âŒ ${data.message || 'Fehler'}`);
                }
            } catch (error) {
                showResult('masterDataResult', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        /**
         * Delete selected room type
         */
        async function deleteSelectedRoomType() {
            const select = document.getElementById('existingRoomTypes');
            const selectedId = select.value;

            if (!selectedId) {
                showResult('masterDataResult', 'error', 'âš ï¸ Bitte wÃ¤hlen Sie einen Raumtyp aus');
                return;
            }

            const selectedText = select.options[select.selectedIndex].textContent;
            if (!confirm(`MÃ¶chten Sie den Raumtyp "${selectedText}" wirklich lÃ¶schen?`)) {
                return;
            }

            showResult('masterDataResult', 'loading', 'â³ LÃ¶sche Raumtyp...');

            try {
                const userId = getCurrentUserId();
                const url = userId
                    ? `${API_RAUMPROGRAM}/roomtype/${selectedId}?userId=${encodeURIComponent(userId)}`
                    : `${API_RAUMPROGRAM}/roomtype/${selectedId}`;
                const response = await fetch(url, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showResult('masterDataResult', 'success', `âœ… ${data.message}`);
                    await loadRoomTypes();
                } else {
                    showResult('masterDataResult', 'error', `âŒ ${data.message || 'Fehler'}`);
                }
            } catch (error) {
                showResult('masterDataResult', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        /**
         * Create a new inventory template
         */
        async function createInventoryTemplate() {
            const propertyName = document.getElementById('newInventoryPropertyName').value.trim();
            const dataType = document.getElementById('newInventoryDataType')?.value || 'Text';
            const unit = document.getElementById('newInventoryUnit')?.value?.trim() || '';

            if (!propertyName) {
                showResult('masterDataResult', 'error', 'âš ï¸ Bitte geben Sie einen Eigenschaftsnamen ein');
                return;
            }

            showResult('masterDataResult', 'loading', 'â³ Erstelle Ausstattungseigenschaft...');

            try {
                const response = await fetch(`${API_RAUMPROGRAM}/inventorytemplate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        propertyName: propertyName,
                        dataType: dataType,
                        unit: unit || null,
                        userId: getCurrentUserId()
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showResult('masterDataResult', 'success', `âœ… ${data.message}`);
                    document.getElementById('newInventoryPropertyName').value = '';
                    document.getElementById('newInventoryUnit').value = '';
                    await loadInventoryTemplates();
                } else {
                    showResult('masterDataResult', 'error', `âŒ ${data.message || 'Fehler'}`);
                }
            } catch (error) {
                showResult('masterDataResult', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        /**
         * Delete selected inventory template
         */
        async function deleteSelectedInventoryTemplate() {
            const select = document.getElementById('existingInventoryTemplates');
            const selectedId = select.value;

            if (!selectedId) {
                showResult('masterDataResult', 'error', 'âš ï¸ Bitte wÃ¤hlen Sie eine Eigenschaft aus');
                return;
            }

            const selectedText = select.options[select.selectedIndex].textContent;
            if (!confirm(`MÃ¶chten Sie die Eigenschaft "${selectedText}" wirklich lÃ¶schen?`)) {
                return;
            }

            showResult('masterDataResult', 'loading', 'â³ LÃ¶sche Eigenschaft...');

            try {
                const userId = getCurrentUserId();
                const url = userId
                    ? `${API_RAUMPROGRAM}/inventorytemplate/${selectedId}?userId=${encodeURIComponent(userId)}`
                    : `${API_RAUMPROGRAM}/inventorytemplate/${selectedId}`;
                const response = await fetch(url, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showResult('masterDataResult', 'success', `âœ… ${data.message}`);
                    await loadInventoryTemplates();
                } else {
                    showResult('masterDataResult', 'error', `âŒ ${data.message || 'Fehler'}`);
                }
            } catch (error) {
                showResult('masterDataResult', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        /**
         * Create a new room - SOLL only (IST values managed in AusgefÃ¼hrt tab)
         */
        async function createRoom() {
            const roomTypeId = document.getElementById('roomRoomType').value;
            const name = document.getElementById('roomName').value.trim();
            const areaPlanned = document.getElementById('roomAreaPlanned').value;

            if (!roomTypeId || !name) {
                showResult('roomManagementResult', 'error', 'âš ï¸ Bitte Raumtyp und Name eingeben');
                return;
            }

            showResult('roomManagementResult', 'loading', 'â³ Erstelle Raum...');

            try {
                const response = await fetch(`${API_RAUMPROGRAM}/room`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        roomTypeID: parseInt(roomTypeId),
                        name: name,
                        netAreaPlanned: areaPlanned ? parseFloat(areaPlanned) : null,
                        netAreaActual: null, // IST values managed in AusgefÃ¼hrt tab
                        grossAreaPlanned: null,
                        grossAreaActual: null,
                        userId: getCurrentUserId()
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showResult('roomManagementResult', 'success', `âœ… ${data.message}`);
                    document.getElementById('roomName').value = '';
                    document.getElementById('roomAreaPlanned').value = '';
                    await loadRaumprogramData();
                } else {
                    showResult('roomManagementResult', 'error', `âŒ ${data.message || 'Fehler'}`);
                }
            } catch (error) {
                showResult('roomManagementResult', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        /**
         * Load Raumprogramm data with pagination and filters
         */
        async function loadRaumprogramData(page = 1) {
            if (page < 1) page = 1;
            currentRaumprogramPage = page;

            const roomTypeId = document.getElementById('raumprogram-filter-roomtype')?.value || '';
            const inventoryId = document.getElementById('raumprogram-filter-inventory')?.value || '';
            const search = document.getElementById('raumprogram-search')?.value?.trim() || '';

            showResult('raumprogramResult', 'loading', 'â³ Lade Raumprogramm-Daten...');

            try {
                let url = `${API_RAUMPROGRAM}/raumprogram?page=${page}&pageSize=${raumprogramPageSize}`;
                if (roomTypeId) url += `&roomTypeId=${roomTypeId}`;

                // Handle multiple inventory selection
                const inventorySelect = document.getElementById('raumprogram-filter-inventory');
                const selectedInventories = Array.from(inventorySelect?.selectedOptions || [])
                    .map(opt => opt.value)
                    .filter(v => v);
                if (selectedInventories.length === 1) {
                    url += `&inventoryTemplateId=${selectedInventories[0]}`;
                }

                if (search) url += `&search=${encodeURIComponent(search)}`;

                const response = await fetch(url);
                const data = await response.json();

                if (response.ok && data.success) {
                    renderRaumprogramTable(data.rooms || [], selectedInventories);
                    updateRaumprogramPagination(data);
                    showResult('raumprogramResult', 'success', `âœ… ${data.totalCount} RÃ¤ume gefunden`);
                } else {
                    showResult('raumprogramResult', 'error', `âŒ ${data.message || 'Fehler beim Laden'}`);
                }
            } catch (error) {
                console.error('Error loading Raumprogramm data:', error);
                showResult('raumprogramResult', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        /**
         * Render Raumprogramm data table - SOLL only with dynamic columns based on visibility settings
         */
        function renderRaumprogramTable(rooms, selectedInventoryIds = []) {
            const thead = document.getElementById('raumprogramTableHead');
            const tbody = document.getElementById('raumprogramTableBody');

            // Get column visibility settings
            const showRaumtyp = document.getElementById('col-raumtyp')?.checked ?? true;
            const showRaumkategorie = document.getElementById('col-raumkategorie')?.checked ?? true;
            const showRaum = document.getElementById('col-raum')?.checked ?? true;
            const showNetArea = document.getElementById('col-netarea')?.checked ?? true;
            const showGrossArea = document.getElementById('col-grossarea')?.checked ?? true;
            const showAreaPlanned = document.getElementById('col-areaplanned')?.checked ?? false;
            const showDescription = document.getElementById('col-description')?.checked ?? false;
            const showObjectType = document.getElementById('col-objecttype')?.checked ?? false;
            const showPredefinedType = document.getElementById('col-predefinedtype')?.checked ?? false;

            // Get selected inventory templates for column headers
            const templates = window.inventoryTemplates || [];
            const selectedTemplates = selectedInventoryIds.length > 0
                ? templates.filter(t => selectedInventoryIds.includes(String(t.inventoryTemplateID)))
                : [];

            // Show comment column only when single inventory selected
            const showComment = selectedInventoryIds.length === 1;

            // Build dynamic headers
            let headerHtml = '<tr>';
            if (showRaumtyp) headerHtml += '<th>Raumtyp</th>';
            if (showRaumkategorie) headerHtml += '<th>Raumkategorie</th>';
            if (showRaum) headerHtml += '<th>Raum</th>';
            if (showNetArea) headerHtml += '<th>NettoflÃ¤che (mÂ²)</th>';
            if (showGrossArea) headerHtml += '<th>BruttoflÃ¤che (mÂ²)</th>';
            if (showAreaPlanned) headerHtml += '<th>FlÃ¤che SOLL (mÂ²)</th>';
            if (showDescription) headerHtml += '<th>Beschreibung</th>';
            if (showObjectType) headerHtml += '<th>Objekttyp</th>';
            if (showPredefinedType) headerHtml += '<th>Vordefinierter Typ</th>';

            // Add inventory columns
            selectedTemplates.forEach(t => {
                const unit = t.unit ? ` (${t.unit})` : '';
                headerHtml += `<th>${escapeHtml(t.propertyName)}${unit}</th>`;
            });
            if (showComment) {
                headerHtml += '<th>Kommentar</th>';
            }
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            // Calculate column count for empty message
            let colCount = 0;
            if (showRaumtyp) colCount++;
            if (showRaumkategorie) colCount++;
            if (showRaum) colCount++;
            if (showNetArea) colCount++;
            if (showGrossArea) colCount++;
            if (showAreaPlanned) colCount++;
            if (showDescription) colCount++;
            if (showObjectType) colCount++;
            if (showPredefinedType) colCount++;
            colCount += selectedTemplates.length;
            if (showComment) colCount++;

            if (!rooms || rooms.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${colCount || 5}" style="text-align:center; color:#666;">Keine Daten vorhanden.</td></tr>`;
                return;
            }

            let html = '';
            rooms.forEach(room => {
                html += '<tr>';
                if (showRaumtyp) html += `<td>${escapeHtml(room.roomTypeName || '')}</td>`;
                if (showRaumkategorie) html += `<td>${escapeHtml(room.roomCategory || '')}</td>`;
                if (showRaum) html += `<td>${escapeHtml(room.name || '')}</td>`;
                if (showNetArea) html += `<td>${(room.netAreaPlanned || 0).toFixed(2)}</td>`;
                if (showGrossArea) html += `<td>${(room.grossAreaPlanned || 0).toFixed(2)}</td>`;
                if (showAreaPlanned) html += `<td>${(room.netAreaPlanned || 0).toFixed(2)}</td>`;
                if (showDescription) html += `<td>${escapeHtml(room.description || '')}</td>`;
                if (showObjectType) html += `<td>${escapeHtml(room.objectType || '')}</td>`;
                if (showPredefinedType) html += `<td>${escapeHtml(room.predefinedType || '')}</td>`;

                // Add columns for each selected inventory
                selectedTemplates.forEach(t => {
                    const inv = (room.inventory || []).find(i => i.inventoryTemplateID === t.inventoryTemplateID);
                    const value = inv?.valuePlanned || '-';
                    html += `<td>${escapeHtml(value)}</td>`;
                });

                // Add comment column if single inventory selected
                if (showComment) {
                    const inv = (room.inventory || [])[0];
                    const comment = inv?.comment || '';
                    html += `<td>${escapeHtml(comment)}</td>`;
                }

                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        /**
         * Update pagination controls
         */
        function updateRaumprogramPagination(data) {
            const prevBtn = document.getElementById('raumprogramPrevPage');
            const nextBtn = document.getElementById('raumprogramNextPage');
            const info = document.getElementById('raumprogramPaginationInfo');

            prevBtn.disabled = data.page <= 1;
            nextBtn.disabled = data.page >= data.totalPages;
            info.textContent = `Seite ${data.page} von ${data.totalPages || 1} (${data.totalCount} EintrÃ¤ge)`;
        }

        /**
         * Delete a room
         */
        async function deleteRoom(roomId) {
            if (!confirm('MÃ¶chten Sie diesen Raum wirklich lÃ¶schen?')) {
                return;
            }

            showResult('raumprogramResult', 'loading', 'â³ LÃ¶sche Raum...');

            try {
                const userId = getCurrentUserId();
                const url = userId
                    ? `${API_RAUMPROGRAM}/room/${roomId}?userId=${encodeURIComponent(userId)}`
                    : `${API_RAUMPROGRAM}/room/${roomId}`;
                const response = await fetch(url, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showResult('raumprogramResult', 'success', `âœ… ${data.message}`);
                    await loadRaumprogramData(currentRaumprogramPage);
                } else {
                    showResult('raumprogramResult', 'error', `âŒ ${data.message || 'Fehler'}`);
                }
            } catch (error) {
                showResult('raumprogramResult', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        /**
         * Import Raumprogramm from Excel
         */
        async function importRaumprogramFromExcel() {
            const token = getToken();
            const fileId = document.getElementById('raumprogramImportFile')?.value;

            if (!token || !fileId) {
                showResult('importExportResult', 'error', 'âš ï¸ Bitte Token und Datei auswÃ¤hlen');
                return;
            }

            showResult('importExportResult', 'loading', 'â³ Importiere Daten aus Excel...');

            try {
                const response = await fetch(`${API_RAUMPROGRAM}/raumprogram/import`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        fileId: fileId,
                        columnMappings: {
                            raumtypColumn: 0,
                            roomNameColumn: 1,
                            areaPlannedColumn: 2,
                            areaActualColumn: 3
                        }
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    let msg = `âœ… ${data.message}<br>`;
                    msg += `Raumtypen erstellt: ${data.roomTypesCreated || 0}<br>`;
                    msg += `RÃ¤ume erstellt: ${data.roomsCreated || 0}<br>`;
                    msg += `RÃ¤ume aktualisiert: ${data.roomsUpdated || 0}`;
                    showResult('importExportResult', 'success', msg);
                    await refreshAllMasterData();
                    await loadRaumprogramData();
                } else {
                    showResult('importExportResult', 'error', `âŒ ${data.message || 'Import fehlgeschlagen'}`);
                }
            } catch (error) {
                showResult('importExportResult', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        /**
         * Export Raumprogramm to Excel
         */
        async function exportRaumprogramToExcel() {
            const token = getToken();
            const targetFolder = getTargetFolder();

            if (!token || !targetFolder) {
                showResult('importExportResult', 'error', 'âš ï¸ Bitte Token und Zielordner in Einstellungen konfigurieren');
                return;
            }

            showResult('importExportResult', 'loading', 'â³ Exportiere Daten nach Excel...');

            try {
                const response = await fetch(`${API_RAUMPROGRAM}/raumprogram/export`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accessToken: token,
                        targetFolderId: targetFolder
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showResult('importExportResult', 'success', `âœ… ${data.message}<br>Datei: ${data.fileName}`);
                } else {
                    showResult('importExportResult', 'error', `âŒ ${data.message || 'Export fehlgeschlagen'}`);
                }
            } catch (error) {
                showResult('importExportResult', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        // ====================================================================
        //  AUSGEFÃœHRT (IST) TAB FUNCTIONS
        // ====================================================================

        let currentIstPage = 1;
        const istPageSize = 50;

        /**
         * Load IST data with pagination and filters
         */
        async function loadIstData(page = 1) {
            if (page < 1) page = 1;
            currentIstPage = page;

            const roomTypeId = document.getElementById('ist-filter-roomtype')?.value || '';
            const search = document.getElementById('ist-search')?.value?.trim() || '';

            showResult('istResult', 'loading', 'â³ Lade IST-Daten...');

            try {
                let url = `${API_RAUMPROGRAM}/raumprogram?page=${page}&pageSize=${istPageSize}`;
                if (roomTypeId) url += `&roomTypeId=${roomTypeId}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;

                const response = await fetch(url);
                const data = await response.json();

                if (response.ok && data.success) {
                    renderIstTable(data.rooms || []);
                    updateIstPagination(data);
                    showResult('istResult', 'success', `âœ… ${data.totalCount} RÃ¤ume gefunden`);
                } else {
                    showResult('istResult', 'error', `âŒ ${data.message || 'Fehler beim Laden'}`);
                }
            } catch (error) {
                console.error('Error loading IST data:', error);
                showResult('istResult', 'error', `âŒ Fehler: ${error.message}`);
            }
        }

        /**
         * Render IST data table - shows IST values for editing
         */
        function renderIstTable(rooms) {
            const thead = document.getElementById('istTableHead');
            const tbody = document.getElementById('istTableBody');

            // Get selected inventory templates
            const inventorySelect = document.getElementById('ist-filter-inventory');
            const selectedInventoryIds = Array.from(inventorySelect?.selectedOptions || [])
                .map(opt => opt.value)
                .filter(v => v);

            const templates = window.inventoryTemplates || [];
            const selectedTemplates = selectedInventoryIds.length > 0
                ? templates.filter(t => selectedInventoryIds.includes(String(t.inventoryTemplateID)))
                : [];

            // Show comment column only when single inventory selected
            const showComment = selectedInventoryIds.length === 1;

            // Build dynamic headers with NetAreaActual and GrossAreaActual
            let headerHtml = '<tr><th>Raumtyp</th><th>Raum Name</th><th>NettoflÃ¤che (mÂ²)</th><th>BruttoflÃ¤che (mÂ²)</th>';
            selectedTemplates.forEach(t => {
                const unit = t.unit ? ` (${t.unit})` : '';
                headerHtml += `<th>IST: ${escapeHtml(t.propertyName)}${unit}</th>`;
            });
            if (showComment) {
                headerHtml += '<th>Kommentar</th>';
            }
            headerHtml += '<th>Aktionen</th></tr>';
            thead.innerHTML = headerHtml;

            if (!rooms || rooms.length === 0) {
                // Base columns: Raumtyp, Raum Name, NettoflÃ¤che, BruttoflÃ¤che, Aktionen = 5
                const baseColCount = 5;
                const colspan = baseColCount + selectedTemplates.length + (showComment ? 1 : 0);
                tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center; color:#666;">Keine Daten vorhanden.</td></tr>`;
                return;
            }

            let html = '';
            rooms.forEach(room => {
                const netAreaActual = room.netAreaActual || 0;
                const grossAreaActual = room.grossAreaActual || 0;

                html += `<tr data-room-id="${room.roomID}">`;
                html += `<td>${escapeHtml(room.roomTypeName || '')}</td>`;
                html += `<td>${escapeHtml(room.name || '')}</td>`;
                html += `<td><input type="number" class="form-control ist-input" data-field="netAreaActual" value="${netAreaActual}" step="0.01" style="width:100px;"></td>`;
                html += `<td><input type="number" class="form-control ist-input" data-field="grossAreaActual" value="${grossAreaActual}" step="0.01" style="width:100px;"></td>`;

                // Add columns for each selected inventory (IST values)
                selectedTemplates.forEach(t => {
                    const inv = (room.inventory || []).find(i => i.inventoryTemplateID === t.inventoryTemplateID);
                    const value = inv?.valueActual || '';
                    html += `<td><input type="text" class="form-control ist-input" data-template-id="${t.inventoryTemplateID}" value="${escapeHtml(value)}" style="width:120px;"></td>`;
                });

                // Add comment input if single inventory selected
                if (showComment) {
                    const inv = (room.inventory || [])[0];
                    const comment = inv?.comment || '';
                    html += `<td><input type="text" class="form-control ist-input" data-field="comment" value="${escapeHtml(comment)}" style="width:150px;"></td>`;
                }

                html += `<td><button class="btn btn-danger btn-sm" onclick="deleteRoom(${room.roomID})" title="LÃ¶schen">ğŸ—‘ï¸</button></td>`;
                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        /**
         * Update IST pagination controls
         */
        function updateIstPagination(data) {
            const prevBtn = document.getElementById('istPrevPage');
            const nextBtn = document.getElementById('istNextPage');
            const info = document.getElementById('istPaginationInfo');

            if (prevBtn) prevBtn.disabled = data.page <= 1;
            if (nextBtn) nextBtn.disabled = data.page >= data.totalPages;
            if (info) info.textContent = `Seite ${data.page} von ${data.totalPages || 1} (${data.totalCount} EintrÃ¤ge)`;
        }

        /**
         * Save IST changes
         */
        async function saveIstChanges() {
            showResult('istResult', 'info', 'âš ï¸ IST-Werte speichern wird in einer zukÃ¼nftigen Version implementiert.');
        }

        /**
         * Sync IST values from IFC
         */
        async function syncIstFromIfc() {
            showResult('istResult', 'info', 'âš ï¸ IFC-Synchronisation wird in einer zukÃ¼nftigen Version implementiert.');
        }

        /**
         * Extract IST values from IFC file
         */
        async function extractIstFromIfc() {
            showResult('ifcExtractionResult', 'info', 'âš ï¸ IFC-Extraktion wird in einer zukÃ¼nftigen Version implementiert.');
        }

        // Initialize date picker with today's date as default
        document.addEventListener('DOMContentLoaded', function () {
            const dueDateField = document.getElementById('bcfDueDate');
            if (dueDateField) {
                const today = new Date().toISOString().split('T')[0];
                dueDateField.value = today;
            }
        });

    </script>
</body>
</html>
